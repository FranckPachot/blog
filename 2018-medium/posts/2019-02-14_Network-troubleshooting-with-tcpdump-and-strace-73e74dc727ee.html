<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Network troubleshooting with tcpdump and strace</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Network troubleshooting with tcpdump and strace</h1>
</header>
<section data-field="subtitle" class="p-summary">
Here is a little example using tcpdump and strace to troubleshoot a network issue with an Oracle connection. It may not be the best…
</section>
<section data-field="body" class="e-content">
<section name="e917" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f825" id="f825" class="graf graf--h3 graf--leading graf--title">Network troubleshooting with tcpdump and strace</h3><p name="a288" id="a288" class="graf graf--p graf-after--h3">Here is a little example using tcpdump and strace to troubleshoot a network issue with an Oracle connection. It may not be the best approach for all cases, but just an example, as this is a copy/paste of my screen after I analyzed it. I just changed the server names.</p><p name="baeb" id="baeb" class="graf graf--p graf-after--p">At some point, the communication between two servers was hanging, with both endpoints waiting on read() — like ‘SQL*Net message from client’ wait event on the server. This issue occurred only on some circumstances: a case that always reproduced was RMAN correctly connected to the catalog, but hanging when we did a ‘show all’.</p><h4 name="5772" id="5772" class="graf graf--h4 graf-after--p">Client netstat and strace</h4><p name="cfa9" id="cfa9" class="graf graf--p graf-after--h4">I have RMAN started and connected to the catalog.</p><p name="9d6b" id="9d6b" class="graf graf--p graf-after--p">I identify my client process, in this case the RMAN executable. I display its TCP connection with netstat and its current system calls with strace:</p><pre name="8cd8" id="8cd8" class="graf graf--pre graf-after--p">[root@client tmp]# <strong class="markup--strong markup--pre-strong">netstat -p</strong> | grep &quot;/rman&quot;</pre><pre name="46d4" id="46d4" class="graf graf--pre graf-after--pre">Proto Local Address Foreign Address State<br>tcp   client:<strong class="markup--strong markup--pre-strong">37051</strong>  server:1521      ESTABLISHED <strong class="markup--strong markup--pre-strong">192131</strong>/rman</pre><pre name="7e10" id="7e10" class="graf graf--pre graf-after--pre">[root@client tmp]# <strong class="markup--strong markup--pre-strong">strace </strong>-yttp <strong class="markup--strong markup--pre-strong">192131</strong><br>Process 192131 attached<br>10:41:29.168494 read(0&lt;/dev/pts/2&gt;,</pre><p name="a8f0" id="a8f0" class="graf graf--p graf-after--pre">I can see the connection from <em class="markup--em markup--p-em">client </em>to <em class="markup--em markup--p-em">server </em>on port 1521 and the process is waiting on user input (stdin).</p><h4 name="f4d3" id="f4d3" class="graf graf--h4 graf-after--p">Server netstat and strace</h4><p name="1007" id="1007" class="graf graf--p graf-after--h4">On the remote side, I see the same TCP connection (same hosts and ports):</p><pre name="9f8b" id="9f8b" class="graf graf--pre graf-after--p">[root@server log]# netstat -p | grep &quot;:<strong class="markup--strong markup--pre-strong">37051</strong>&quot;</pre><pre name="82cd" id="82cd" class="graf graf--pre graf-after--pre">Proto Local Address Foreign Address State<br>tcp   server:1521   client:37051    ESTABLISHED <strong class="markup--strong markup--pre-strong">36761</strong>/oraclePDBR2</pre><p name="7c9c" id="7c9c" class="graf graf--p graf-after--pre">and the process is waiting on socket (‘SQL*Net message from client’):</p><pre name="732f" id="732f" class="graf graf--pre graf-after--p">[root@server log]# strace -yttp <strong class="markup--strong markup--pre-strong">36761</strong><br>Process 36761 attached<br>10:41:43.745239 <strong class="markup--strong markup--pre-strong">read</strong>(20&lt;<strong class="markup--strong markup--pre-strong">socket</strong>:[3785769780]&gt;,</pre><h4 name="ae84" id="ae84" class="graf graf--h4 graf-after--pre">Client/server dialogue</h4><p name="a82f" id="a82f" class="graf graf--p graf-after--h4">Here is where I run ‘show all;’ which will get hung. I’ll show all the network dialogue from this point.</p><p name="e3f3" id="e3f3" class="graf graf--p graf-after--p">I run tcpdump in background to show the packets sent on <em class="markup--em markup--p-em">client </em>:</p><pre name="cfc6" id="cfc6" class="graf graf--pre graf-after--p">[root@client tmp]# tcpdump -i bond0 src client and dst server &amp;</pre><p name="dc27" id="dc27" class="graf graf--p graf-after--pre">and on <em class="markup--em markup--p-em">server</em>:</p><pre name="331f" id="331f" class="graf graf--pre graf-after--p">[root@server tmp]# tcpdump -i bond0 src server and dst client &amp;</pre><p name="e471" id="e471" class="graf graf--p graf-after--pre">In both I have strace attached to the processes identified by netstat -p (strace -y to show file name for descriptors and -tt to show timestamp)</p><p name="c789" id="c789" class="graf graf--p graf-after--p">Here are the traces just after I run ‘show all;’ on the <em class="markup--em markup--p-em">client</em>, which queries the <em class="markup--em markup--p-em">server</em>.</p><p name="d8ae" id="d8ae" class="graf graf--p graf-after--p">The <em class="markup--em markup--p-em">client </em>sends a statement. Here is the write (from strace) and TCP message (from tcpdump):</p><pre name="1355" id="1355" class="graf graf--pre graf-after--p">10:43:44.309812 write(15&lt;socket:[2594150602]&gt;, &quot;\3+\0\0\6\0\0\0\0\0\21i{\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\5\0\0&quot;..., <strong class="markup--strong markup--pre-strong">811</strong>) = <strong class="markup--strong markup--pre-strong">811</strong></pre><pre name="42c2" id="42c2" class="graf graf--pre graf-after--pre">10:43:44.309853 IP client.37051 &gt; server.1521: Flags [P.], seq 34484:35295, ack 17685, win 442, length <strong class="markup--strong markup--pre-strong">811</strong></pre><p name="159d" id="159d" class="graf graf--p graf-after--pre">The <em class="markup--em markup--p-em">server </em>receives it and strace displays the end of the line with the read() return code (which is the size of the message):</p><pre name="2b31" id="2b31" class="graf graf--pre graf-after--p">&quot;\3+\0\0\6\0\0\0\0\0\21i{\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\5\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">811</strong></pre><p name="d7ba" id="d7ba" class="graf graf--p graf-after--pre">In the meanwhile, the <em class="markup--em markup--p-em">client </em>waits for the answer:</p><pre name="fa70" id="fa70" class="graf graf--pre graf-after--p">10:43:44.309892 read(15&lt;socket:[2594150602]&gt;,</pre><p name="70ff" id="70ff" class="graf graf--p graf-after--pre">Then the <em class="markup--em markup--p-em">server </em>answers:</p><pre name="b32b" id="b32b" class="graf graf--pre graf-after--p">10:43:44.356795 write(20&lt;socket:[3785769780]&gt;, &quot;\0\355\0\0\6\0\0\0\0\0\v\1\5q\6\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., <strong class="markup--strong markup--pre-strong">237</strong></pre><pre name="6f57" id="6f57" class="graf graf--pre graf-after--pre">10:43:44.356830 IP server.1521&gt; client.37051: Flags [P.], seq 17685:<strong class="markup--strong markup--pre-strong">17922</strong>, ack 35296, win 442, length <strong class="markup--strong markup--pre-strong">237</strong></pre><pre name="4172" id="4172" class="graf graf--pre graf-after--pre">) = <strong class="markup--strong markup--pre-strong">237</strong></pre><p name="7a09" id="7a09" class="graf graf--p graf-after--pre">We see strace printing the call (write 237 bytes), then tcpdump showing the packet going out (same size: bytes 17685 to 17922 in this server-&gt;client stream), and then strace continues the line when the write() system call returns, displaying the number of bytes written.</p><p name="ceda" id="ceda" class="graf graf--p graf-after--p">Sending this packet is also the occasion to acknowledge what was received — up to byte 35296 of the client-&gt;server message.</p><p name="eb6e" id="eb6e" class="graf graf--p graf-after--p">The <em class="markup--em markup--p-em">client </em>gets it, strace showing the end of the read() line:</p><pre name="abd7" id="abd7" class="graf graf--pre graf-after--p">10:43:44.357178 IP client.37051 &gt; server.1521: Flags [.], ack <strong class="markup--strong markup--pre-strong">17922</strong>, win 442, length 0</pre><pre name="23ea" id="23ea" class="graf graf--pre graf-after--pre">&quot;\0\355\0\0\6\0\0\0\0\0\v\1\5q\6\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">237</strong></pre><p name="56cf" id="56cf" class="graf graf--p graf-after--pre">Note that an empty message (length=0) was sent by the client to acknowledge that it has received up to byte 17922 in the server-&gt;client message.</p><p name="33c1" id="33c1" class="graf graf--p graf-after--p">After having sent its answer, the <em class="markup--em markup--p-em">server </em>waits for the next query (and acknowledges what was received recently with a length 0 packet):</p><pre name="acad" id="acad" class="graf graf--pre graf-after--p">10:43:44.356894 read(20&lt;socket:[3785769780]&gt;, </pre><pre name="1275" id="1275" class="graf graf--pre graf-after--pre">10:43:44.357493 IP server.1521&gt; client.37051: Flags [.], <strong class="markup--strong markup--pre-strong">ack 36267</strong>, win 442, length 0</pre><p name="a6f9" id="a6f9" class="graf graf--p graf-after--pre">The <em class="markup--em markup--p-em">client </em>sends a new query:</p><pre name="62ea" id="62ea" class="graf graf--pre graf-after--p">10:43:44.357368 write(15&lt;socket:[2594150602]&gt;, &quot;\3\313\0\0\6\0\0\0\0\0\21i}\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\4\0\0&quot;..., <strong class="markup--strong markup--pre-strong">971</strong></pre><pre name="5381" id="5381" class="graf graf--pre graf-after--pre">10:43:44.357416 IP client.37051 &gt; server.1521: Flags [P.], seq 35295:36266, ack 17922, win 442, length <strong class="markup--strong markup--pre-strong">971</strong><br>) = <strong class="markup--strong markup--pre-strong">971</strong></pre><p name="f99c" id="f99c" class="graf graf--p graf-after--pre">and waits for the response:</p><pre name="0947" id="0947" class="graf graf--pre graf-after--p">10:43:44.357461 read(15&lt;socket:[2594150602]&gt;, &quot;\0\356\0\0\6\0\0\0\0\0\v\1\5\n\7\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">238</strong></pre><p name="b986" id="b986" class="graf graf--p graf-after--pre">From here, I start to show the full line with the return code (238 bytes) but remember that only the ‘10:43:44.357461 read(15&lt;socket:[2594150602]&gt;,’ part is displayed by strace before the message is actually received. The buffer content and size is written later.</p><p name="6229" id="6229" class="graf graf--p graf-after--p">Here is the <em class="markup--em markup--p-em">server </em>receiving the message from the <em class="markup--em markup--p-em">client </em>and sending the answer:</p><pre name="5198" id="5198" class="graf graf--pre graf-after--p">&quot;\3\313\0\0\6\0\0\0\0\0\21i}\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\4\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">971</strong></pre><pre name="98cd" id="98cd" class="graf graf--pre graf-after--pre">10:43:44.365296 write(20&lt;socket:[3785769780]&gt;, &quot;\0\356\0\0\6\0\0\0\0\0\v\1\5\n\7\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., <strong class="markup--strong markup--pre-strong">238</strong></pre><pre name="8833" id="8833" class="graf graf--pre graf-after--pre">10:43:44.365326 IP server.1521&gt; client.37051: Flags [P.], seq 17922:18160, ack 36267, win 442, length <strong class="markup--strong markup--pre-strong">238</strong></pre><pre name="8975" id="8975" class="graf graf--pre graf-after--pre">) = <strong class="markup--strong markup--pre-strong">238</strong></pre><p name="23fc" id="23fc" class="graf graf--p graf-after--pre">We have seen that the client got it (the 238 bytes). It sends a new query (365 bytes), waits for the answer which is 237 bytes:</p><pre name="b1ab" id="b1ab" class="graf graf--pre graf-after--p">10:43:44.365766 write(15&lt;socket:[2594150602]&gt;, &quot;\1m\0\0\6\0\0\0\0\0\21i\177\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\2\0\0&quot;..., 365) = <strong class="markup--strong markup--pre-strong">365</strong></pre><pre name="515f" id="515f" class="graf graf--pre graf-after--pre">10:43:44.365817 IP client.37051 &gt; server.1521: Flags [P.], seq 36266:36631, ack 18160, win 442, length <strong class="markup--strong markup--pre-strong">365</strong></pre><pre name="dda2" id="dda2" class="graf graf--pre graf-after--pre">10:43:44.365870 read(15&lt;socket:[2594150602]&gt;, &quot;\0\355\0\0\6\0\0\0\0\0\v\1\5\221\1\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">237</strong></pre><p name="9f27" id="9f27" class="graf graf--p graf-after--pre">Here is the server part for this dialogue, receiving the 365 bytes query and writing the 237 bytes answer:</p><pre name="eb32" id="eb32" class="graf graf--pre graf-after--p">10:43:44.365408 read(20&lt;socket:[3785769780]&gt;, &quot;\1m\0\0\6\0\0\0\0\0\21i\177\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\2\0\0&quot;..., 8208) = <strong class="markup--strong markup--pre-strong">365</strong></pre><pre name="a93b" id="a93b" class="graf graf--pre graf-after--pre">10:43:44.366793 write(20&lt;socket:[3785769780]&gt;, &quot;\0\355\0\0\6\0\0\0\0\0\v\1\5\221\1\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., <strong class="markup--strong markup--pre-strong">237</strong></pre><pre name="7b27" id="7b27" class="graf graf--pre graf-after--pre">10:43:44.366829 IP server.1521&gt; client.37051: Flags [P.], seq 18160:18397, ack 36632, win 442, length <strong class="markup--strong markup--pre-strong">237</strong></pre><pre name="d68d" id="d68d" class="graf graf--pre graf-after--pre">) = <strong class="markup--strong markup--pre-strong">237</strong></pre><p name="4e1d" id="4e1d" class="graf graf--p graf-after--pre">There are a few more exchanges where the client sends 381 bytes, the server answers 236 bytes, then the client sends 297 bytes and the server answers in 181 bytes. Here is the <em class="markup--em markup--p-em">client </em>strace and tcpddump for this:</p><pre name="4c34" id="4c34" class="graf graf--pre graf-after--p">10:43:44.367199 write(15&lt;socket:[2594150602]&gt;, &quot;\1}\0\0\6\0\0\0\0\0\21i\201\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\4\0\0&quot;..., 381) = 381</pre><pre name="b77b" id="b77b" class="graf graf--pre graf-after--pre">10:43:44.367229 IP client.37051 &gt; server.1521: Flags [P.], seq 36631:37012, ack 18397, win 442, length 381</pre><pre name="2d2c" id="2d2c" class="graf graf--pre graf-after--pre">10:43:44.367272 read(15&lt;socket:[2594150602]&gt;, <br>&quot;\0\354\0\0\6\0\0\0\0\0\v\1\5L\1\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., 8208) = 236</pre><pre name="b293" id="b293" class="graf graf--pre graf-after--pre">10:43:44.368522 write(15&lt;socket:[2594150602]&gt;, &quot;\1)\0\0\6\0\0\0\0\0\21i\203\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\5\0\0&quot;..., 297) = 297</pre><pre name="5d95" id="5d95" class="graf graf--pre graf-after--pre">10:43:44.368555 IP client.37051 &gt; server.1521: Flags [P.], seq 37012:37309, ack 18633, win 442, length 297</pre><pre name="c673" id="c673" class="graf graf--pre graf-after--pre">10:43:44.368598 read(15&lt;socket:[2594150602]&gt;, &quot;\0\265\0\0\6\0\0\0\0\0\10\6\0\252I(\35\2\7\0\0\2\0\0\0\1\0\0\0\0\0\0&quot;..., 8208) = 181</pre><p name="3785" id="3785" class="graf graf--p graf-after--pre">and the strace and tcpdump on the <em class="markup--em markup--p-em">server </em>side:</p><pre name="af19" id="af19" class="graf graf--pre graf-after--p">10:43:44.366884 read(20&lt;socket:[3785769780]&gt;, &quot;\1}\0\0\6\0\0\0\0\0\21i\201\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\4\0\0&quot;..., 8208) = 381</pre><pre name="3172" id="3172" class="graf graf--pre graf-after--pre">10:43:44.368031 write(20&lt;socket:[3785769780]&gt;, &quot;\0\354\0\0\6\0\0\0\0\0\v\1\5L\1\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0&quot;..., 236</pre><pre name="84bd" id="84bd" class="graf graf--pre graf-after--pre">10:43:44.368084 IP server.1521&gt; client.37051: Flags [P.], seq 18397:18633, ack 37013, win 442, length 236<br>) = 236</pre><pre name="b5a3" id="b5a3" class="graf graf--pre graf-after--pre">10:43:44.368181 read(20&lt;socket:[3785769780]&gt;, &quot;\1)\0\0\6\0\0\0\0\0\21i\203\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\5\0\0&quot;..., 8208) = 297</pre><pre name="d47f" id="d47f" class="graf graf--pre graf-after--pre">10:43:44.370926 write(20&lt;socket:[3785769780]&gt;, &quot;\0\265\0\0\6\0\0\0\0\0\10\6\0\252I(\35\2\7\0\0\2\0\0\0\1\0\0\0\0\0\0&quot;..., 181) = 181</pre><pre name="546a" id="546a" class="graf graf--pre graf-after--pre">10:43:44.370949 IP server.1521 &gt; client.37051: Flags [P.], seq 18633:<strong class="markup--strong markup--pre-strong">18814</strong>, ack <strong class="markup--strong markup--pre-strong">37310</strong>, win 442, length 181</pre><pre name="fbe1" id="fbe1" class="graf graf--pre graf-after--pre">10:43:44.371006 read(20&lt;socket:[3785769780]&gt;, </pre><p name="fab2" id="fab2" class="graf graf--p graf-after--pre">The <em class="markup--em markup--p-em">client </em>which got the 181 bytes answer from the server, now sends a new query:</p><pre name="d77b" id="d77b" class="graf graf--pre graf-after--p">10:43:44.413973 write(15&lt;socket:[2594150602]&gt;, &quot;\10V\0\0\6\0\0\0\0\0\21i\205\376\377\377\377\377\377\377\377\1\0\0\0\0\0\0\0\2\0\0&quot;..., 2134</pre><pre name="248e" id="248e" class="graf graf--pre graf-after--pre">10:43:44.414020 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309</strong>:39443, ack <strong class="markup--strong markup--pre-strong">18814</strong>, win 442, length 2134</pre><pre name="a468" id="a468" class="graf graf--pre graf-after--pre">) = 2134</pre><p name="4859" id="4859" class="graf graf--p graf-after--pre">and then waits for the answer:</p><pre name="ea12" id="ea12" class="graf graf--pre graf-after--p">10:43:44.414115 read(15&lt;socket:[2594150602]&gt;,</pre><p name="1cf6" id="1cf6" class="graf graf--p graf-after--pre">but this is where it hangs. Remember where we are:</p><ul class="postList"><li name="5afc" id="5afc" class="graf graf--li graf-after--p">the <em class="markup--em markup--li-em">server </em>has acknowledged up byte 37310 in messages from <em class="markup--em markup--li-em">client</em> and is waiting to read from the socket</li><li name="2894" id="2894" class="graf graf--li graf-after--li">the client is acknowledging up to byte 18814 in messages from <em class="markup--em markup--li-em">server</em> and sends more bytes (from 37309 to 39443)</li></ul><p name="c797" id="c797" class="graf graf--p graf-after--li">But the <em class="markup--em markup--p-em">server </em>didn’t receive them and is still waiting:</p><pre name="3edd" id="3edd" class="graf graf--pre graf-after--p">10:43:44.371006 read(20&lt;socket:[3785769780]&gt;,</pre><p name="0640" id="0640" class="graf graf--p graf-after--pre">Both side waiting… this is where tcpdump will be helpful. strace shows only one write() call, which writes to the TCP buffer. But tcpdump shows many attempts to send this to the server:</p><pre name="5836" id="5836" class="graf graf--pre graf-after--p">10:43:44.617869 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309:39443</strong>, ack 18814, win 442, length 2134</pre><pre name="1805" id="1805" class="graf graf--pre graf-after--pre">10:43:45.025804 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309:39443</strong>, ack 18814, win 442, length 2134</pre><pre name="00ec" id="00ec" class="graf graf--pre graf-after--pre">10:43:45.841818 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309:39443</strong>, ack 18814, win 442, length 2134</pre><pre name="d798" id="d798" class="graf graf--pre graf-after--pre">10:43:47.473818 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309:39443</strong>, ack 18814, win 442, length 2134</pre><pre name="4e6c" id="4e6c" class="graf graf--pre graf-after--pre">10:43:50.737837 IP client.37051 &gt; server.1521: Flags [P.], seq <strong class="markup--strong markup--pre-strong">37309:39443</strong>, ack 18814, win 442, length 2134</pre><p name="e868" id="e868" class="graf graf--p graf-after--pre">Same packet, same size, the 37309 to 39443 bytes of the client-&gt;server conversation. The last acknowledge from the server was 37310 — he never received this packet. And because it is TCP, it retries. The write() was done because it writes to the buffer, so the application is just waiting for the answer.</p><p name="aca3" id="aca3" class="graf graf--p graf-after--p">A packet has disappeared in the client-&gt;server conversation. This is a job for the network team, but there’s something to remark here. Many messages were ok, but not this one. What is special? The size is larger: 2134 bytes. The maximum we had before was 971.</p><h4 name="2002" id="2002" class="graf graf--h4 graf-after--p">Simple ping…</h4><p name="9dad" id="9dad" class="graf graf--p graf-after--h4">Those numbers may already ring a bell, but let’s try to PING with some different packets sizes. Up to 1472 goes through:</p><pre name="18f6" id="18f6" class="graf graf--pre graf-after--p">[root@client tmp]# ping -c 5 <strong class="markup--strong markup--pre-strong">-s 1472</strong> -W 5 server<br>PING client (10.30.13.62) 1472(1500) bytes of data.<br>1480 bytes from server(10.30.13.62): icmp_seq=1 ttl=58 time=0.607 ms<br>1480 bytes from server(10.30.13.62): icmp_seq=2 ttl=58 time=0.477 ms<br>1480 bytes from server(10.30.13.62): icmp_seq=3 ttl=58 time=0.494 ms<br>1480 bytes from server(10.30.13.62): icmp_seq=4 ttl=58 time=0.474 ms<br>1480 bytes from server(10.30.13.62): icmp_seq=5 ttl=58 time=0.533 ms</pre><p name="a3b9" id="a3b9" class="graf graf--p graf-after--pre">But larger fails:</p><pre name="8cee" id="8cee" class="graf graf--pre graf-after--p">[root@client tmp]# ping -c 5 <strong class="markup--strong markup--pre-strong">-s 1473</strong> -W 5 server<br>PING server (10.30.13.62) 1473(1501) bytes of data.</pre><pre name="adf3" id="adf3" class="graf graf--pre graf-after--pre">--- server ping statistics ---<br>5 packets transmitted, 0 received, <strong class="markup--strong markup--pre-strong">100% packet loss</strong>, time 9000ms</pre><p name="7308" id="7308" class="graf graf--p graf-after--pre">All packets were lost.</p><p name="924f" id="924f" class="graf graf--p graf-after--p">The default Ethernet MTU (maximum transmission size) is 1500 bytes but we use Jumbo Frames here, as defined by the interface:</p><pre name="ba15" id="ba15" class="graf graf--pre graf-after--p">[root@client tmp]# ip a | grep mtu<br>...<br>8: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; <strong class="markup--strong markup--pre-strong">mtu 9000</strong> qdisc noqueue state UP</pre><p name="eb28" id="eb28" class="graf graf--p graf-after--pre">There is probably a router in the middle which does not allow Jumbo Frames… This is now a job for the network guys. However, if I need a quick workaround I can limit the Session Data Unit on Oracle side, like:</p><pre name="de61" id="de61" class="graf graf--pre graf-after--p">(DESCRIPTION=(CONNECT_DATA=(SERVICE_NAME=myservice))<strong class="markup--strong markup--pre-strong">(SDU=1430)</strong>(ADDRESS=(PROTOCOL=TCP)(HOST=server)(PORT=1521)))</pre><p name="f4e7" id="f4e7" class="graf graf--p graf-after--pre">With SDU at 1430 the length of the packets (as displayed by tcpdump) are at maximum 1460 bytes (NS and NT layers add 30 bytes) which is the maximum that can go through MTU 1500 (as IP and TCP headers add 20 bytes each).</p><p name="0092" id="0092" class="graf graf--p graf-after--p graf--trailing">If you wonder why ping was able to send packets up to 1472 bytes, that’s because the ICMP header is only 8 bytes instead of the TCP 20 bytes.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/73e74dc727ee"><time class="dt-published" datetime="2019-02-14T16:46:09.776Z">February 14, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/network-troubleshooting-with-tcpdump-and-strace-73e74dc727ee" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>