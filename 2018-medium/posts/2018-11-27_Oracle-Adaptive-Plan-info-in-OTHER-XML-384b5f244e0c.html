<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Oracle Adaptive Plan info in OTHER_XML</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Oracle Adaptive Plan info in OTHER_XML</h1>
</header>
<section data-field="subtitle" class="p-summary">
DBMS_XPLAN displays the operation ID with no gap, even for Adaptive Plans where the inactive operations are skipped. Did you ever wonder…
</section>
<section data-field="body" class="e-content">
<section name="7098" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5f3e" id="5f3e" class="graf graf--h3 graf--leading graf--title">Oracle Adaptive Plan info in OTHER_XML</h3><p name="cc99" id="cc99" class="graf graf--p graf-after--h3">DBMS_XPLAN displays the operation ID with no gap, even for Adaptive Plans where the inactive operations are skipped. Did you ever wonder where the information of skipped rows is stored?</p><p name="3e0b" id="3e0b" class="graf graf--p graf-after--p">Here is a simple query (but please, remember that natural join is bad ;)</p><pre name="f6d8" id="f6d8" class="graf graf--pre graf-after--p">SQL&gt; set feedback on sql_id<br>SQL&gt; select * from dept natural join emp natural join bonus;</pre><pre name="b3f4" id="b3f4" class="graf graf--pre graf-after--pre">no rows selected</pre><pre name="8f41" id="8f41" class="graf graf--pre graf-after--pre">SQL_ID: 3q7fbwk91v4ra</pre><p name="81fb" id="81fb" class="graf graf--p graf-after--pre">The execution plan shows that the plan is adaptive:</p><pre name="42d2" id="42d2" class="graf graf--pre graf-after--p">SQL&gt; select * from dbms_xplan.display_cursor(format=&gt;&#39;BASIC <strong class="markup--strong markup--pre-strong">+note</strong>&#39;);</pre><pre name="3017" id="3017" class="graf graf--pre graf-after--pre">PLAN_TABLE_OUTPUT<br>------------------------------------------------------<br>EXPLAINED SQL STATEMENT:<br>------------------------<br>select * from dept natural join emp natural join bonus</pre><pre name="fd40" id="fd40" class="graf graf--pre graf-after--pre">Plan hash value: 1315453310</pre><pre name="c34f" id="c34f" class="graf graf--pre graf-after--pre">------------------------------------------------<br>| Id  | Operation                    | Name    |<br>------------------------------------------------<br>|   0 | SELECT STATEMENT             |         |<br>|   1 |  NESTED LOOPS                |         |<br>|   2 |   NESTED LOOPS               |         |<br>|   3 |    HASH JOIN                 |         |<br>|   4 |     TABLE ACCESS FULL        | BONUS   |<br>|   5 |     TABLE ACCESS FULL        | EMP     |<br>|   6 |    INDEX UNIQUE SCAN         | PK_DEPT |<br>|   7 |   TABLE ACCESS BY INDEX ROWID| DEPT    |<br>------------------------------------------------</pre><pre name="3bca" id="3bca" class="graf graf--pre graf-after--pre">Note<br>-----<br>   - <strong class="markup--strong markup--pre-strong">this is an adaptive plan</strong></pre><p name="82bf" id="82bf" class="graf graf--p graf-after--pre">With the ‘+adaptive format’ we see the active and inactive branches:</p><pre name="a8f1" id="a8f1" class="graf graf--pre graf-after--p">SQL&gt; select * from dbms_xplan.display_cursor( sql_id=&gt;&#39;3q7fbwk91v4ra&#39;, format=&gt;&#39;BASIC <strong class="markup--strong markup--pre-strong">+adaptive</strong> +note&#39;);</pre><pre name="5b27" id="5b27" class="graf graf--pre graf-after--pre">PLAN_TABLE_OUTPUT<br>------------------------------------------------------<br>EXPLAINED SQL STATEMENT:<br>------------------------<br>select * from dept natural join emp natural join bonus</pre><pre name="76c0" id="76c0" class="graf graf--pre graf-after--pre">Plan hash value: 1315453310</pre><pre name="0254" id="0254" class="graf graf--pre graf-after--pre">-------------------------------------------------<br>| Id  | Operation                     | Name    |<br>-------------------------------------------------<br>|   0 | SELECT STATEMENT              |         |<br>|<strong class="markup--strong markup--pre-strong">-  1</strong> |  HASH JOIN                    |         |<br>|   2 |   NESTED LOOPS                |         |<br>|   3 |    NESTED LOOPS               |         |<br>|<strong class="markup--strong markup--pre-strong">-  4</strong> |     STATISTICS COLLECTOR      |         |<br>|   5 |      HASH JOIN                |         |<br>|   6 |       TABLE ACCESS FULL       | BONUS   |<br>|   7 |       TABLE ACCESS FULL       | EMP     |<br>|   8 |     INDEX UNIQUE SCAN         | PK_DEPT |<br>|   9 |    TABLE ACCESS BY INDEX ROWID| DEPT    |<br>|<strong class="markup--strong markup--pre-strong">- 10</strong> |   TABLE ACCESS FULL           | DEPT    |<br>-------------------------------------------------</pre><pre name="e38b" id="e38b" class="graf graf--pre graf-after--pre">Note<br>-----<br>   - this is an adaptive plan (<strong class="markup--strong markup--pre-strong">rows marked &#39;-&#39; are inactive</strong>)</pre><p name="0e76" id="0e76" class="graf graf--p graf-after--pre">You can see that the numbering has changed: now 1–10 and this is what we actually have in PLAN_TABLE:</p><pre name="0854" id="0854" class="graf graf--pre graf-after--p">SQL&gt; column &quot;LPAD(&#39;&#39;,DEPTH,&#39;&#39;)||OPERATION&quot; format a30<br>SQL&gt; select id,depth,parent_id,lpad(&#39; &#39;,depth,&#39; &#39;)||operation    from v$sql_plan where sql_id like &#39;3q7fbwk91v4ra&#39;;</pre><pre name="2381" id="2381" class="graf graf--pre graf-after--pre">ID      DEPTH  PARENT_ID LPAD(&#39;&#39;,DEPTH,&#39;&#39;)||OPERATION<br>---------- ---------- ---------- ------------------------------<br>         0          0            SELECT STATEMENT<br>         1          1          0  HASH JOIN<br>         2          2          1   NESTED LOOPS<br>         3          3          2    NESTED LOOPS<br>         4          4          3     STATISTICS COLLECTOR<br>         5          5          4      HASH JOIN<br>         6          6          5       TABLE ACCESS<br>         7          6          5       TABLE ACCESS<br>         8          4          3     INDEX<br>         9          3          2    TABLE ACCESS<br>        10          2          1   TABLE ACCESS</pre><p name="5f94" id="5f94" class="graf graf--p graf-after--pre">The ID here is unique. Adaptive Plan does not break this. So this means that it was mapped to different numbers when the inactive lines were skipped. DBMS_XPLAN does this for us but if we have our own tool we need to know where this mapping comes from.</p><h3 name="c169" id="c169" class="graf graf--h3 graf-after--p">/other_xml/display_map</h3><p name="d2ff" id="d2ff" class="graf graf--p graf-after--h3">As most of the additional information that we can see in the notes, they come from OTHER_XML</p><pre name="c2ff" id="c2ff" class="graf graf--pre graf-after--p">SQL&gt; set long 100000 linesize 68<br>SQL&gt; select other_xml from v$sql_plan where sql_id like &#39;3q7fbwk91v4ra&#39; and id=1;</pre><pre name="a5a1" id="a5a1" class="graf graf--pre graf-after--pre">OTHER_XML<br>--------------------------------------------------------------------<br>&lt;other_xml&gt;&lt;info type=&quot;db_version&quot;&gt;18.0.0.0&lt;/info&gt;&lt;info type=&quot;parse_<br>schema&quot;&gt;&lt;![CDATA[&quot;SCOTT&quot;]]&gt;&lt;/info&gt;&lt;info type=&quot;plan_hash_full&quot;&gt;176307<br>9200&lt;/info&gt;&lt;info type=&quot;plan_hash&quot;&gt;1315453310&lt;/info&gt;&lt;info type=&quot;plan_<br>hash_2&quot;&gt;4080194477&lt;/info&gt;&lt;info type=&quot;adaptive_plan&quot; note=&quot;y&quot;&gt;yes&lt;/in<br>fo&gt;&lt;outline_data&gt;&lt;hint&gt;&lt;![CDATA[IGNORE_OPTIM_EMBEDDED_HINTS]]&gt;&lt;/hint<br>&gt;&lt;hint&gt;&lt;![CDATA[OPTIMIZER_FEATURES_ENABLE(&#39;18.1.0&#39;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;<br>![CDATA[DB_VERSION(&#39;18.1.0&#39;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[ALL_ROWS]]&gt;&lt;/hi<br>nt&gt;&lt;hint&gt;&lt;![CDATA[OUTLINE_LEAF(@&quot;SEL$9E43CB6E&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CD<br>ATA[MERGE(@&quot;SEL$58A6D7F6&quot; &gt;&quot;SEL$3&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[OUTLINE(<br>@&quot;SEL$3&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[OUTLINE(@&quot;SEL$58A6D7F6&quot;)]]&gt;&lt;/hint&gt;<br>&lt;hint&gt;&lt;![CDATA[MERGE(@&quot;SEL$1&quot; &gt;&quot;SEL$2&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[OUTL<br>INE(@&quot;SEL$2&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[OUTLINE(@&quot;SEL$1&quot;)]]&gt;&lt;/hint&gt;&lt;hi<br>nt&gt;&lt;![CDATA[FULL(@&quot;SEL$9E43CB6E&quot; &quot;BONUS&quot;@&quot;SEL$2&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![<br>CDATA[FULL(@&quot;SEL$9E43CB6E&quot; &quot;EMP&quot;@&quot;SEL$1&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[IN<br>DEX(@&quot;SEL$9E43CB6E&quot; &quot;DEPT&quot;@&quot;SEL$1&quot; (&quot;DEPT&quot;.&quot;DEPTNO&quot;))]]&gt;&lt;/hint&gt;&lt;hint<br>&gt;&lt;![CDATA[LEADING(@&quot;SEL$9E43CB6E&quot; &quot;BONUS&quot;@&quot;SEL$2&quot; &quot;EMP&quot;@&quot;SEL$1&quot; &quot;DEP<br>T&quot;@&quot;SEL$1&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[USE_HASH(@&quot;SEL$9E43CB6E&quot; &quot;EMP&quot;@&quot;<br>SEL$1&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[USE_NL(@&quot;SEL$9E43CB6E&quot; &quot;DEPT&quot;@&quot;SEL$1<br>&quot;)]]&gt;&lt;/hint&gt;&lt;hint&gt;&lt;![CDATA[NLJ_BATCHING(@&quot;SEL$9E43CB6E&quot; &quot;DEPT&quot;@&quot;SEL$<br>1&quot;)]]&gt;&lt;/hint&gt;&lt;/outline_data&gt;<strong class="markup--strong markup--pre-strong">&lt;display_map&gt;&lt;row op=&quot;1&quot; dis=&quot;0&quot; par=&quot;0&quot;<br> prt=&quot;0&quot; dep=&quot;0&quot; skp=&quot;1&quot;/&gt;&lt;row op=&quot;2&quot; dis=&quot;1&quot; par=&quot;0&quot; prt=&quot;0&quot; dep=&quot;1<br>&quot; skp=&quot;0&quot;/&gt;&lt;row op=&quot;3&quot; dis=&quot;2&quot; par=&quot;1&quot; prt=&quot;0&quot; dep=&quot;2&quot; skp=&quot;0&quot;/&gt;&lt;row<br> op=&quot;4&quot; dis=&quot;2&quot; par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;2&quot; skp=&quot;1&quot;/&gt;&lt;row op=&quot;5&quot; dis=&quot;3&quot;<br> par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;3&quot; skp=&quot;0&quot;/&gt;&lt;row op=&quot;6&quot; dis=&quot;4&quot; par=&quot;3&quot; prt=&quot;0<br>&quot; dep=&quot;4&quot; skp=&quot;0&quot;/&gt;&lt;row op=&quot;7&quot; dis=&quot;5&quot; par=&quot;3&quot; prt=&quot;0&quot; dep=&quot;4&quot; skp=&quot;<br>0&quot;/&gt;&lt;row op=&quot;8&quot; dis=&quot;6&quot; par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;3&quot; skp=&quot;0&quot;/&gt;&lt;row op=&quot;9&quot;<br> dis=&quot;7&quot; par=&quot;1&quot; prt=&quot;0&quot; dep=&quot;2&quot; skp=&quot;0&quot;/&gt;&lt;row op=&quot;10&quot; dis=&quot;7&quot; par=&quot;<br>0&quot; prt=&quot;0&quot; dep=&quot;0&quot; skp=&quot;1&quot;/&gt;&lt;/display_map&gt;</strong>&lt;/other_xml&gt;</pre><p name="4c57" id="4c57" class="graf graf--p graf-after--pre">Here is what we have in /other_xml/display_map:</p><pre name="20dd" id="20dd" class="graf graf--pre graf-after--p">SQL&gt; select column_value from v$sql_plan , table(xmlsequence(extract(xmltype(other_xml),&#39;/*/display_map/row&#39;))) where sql_id like &#39;3q7fbwk91v4ra&#39; and id=1;</pre><pre name="f76b" id="f76b" class="graf graf--pre graf-after--pre">COLUMN_VALUE<br>--------------------------------------------------------------------<br>&lt;row op=&quot;1&quot; dis=&quot;0&quot; par=&quot;0&quot; prt=&quot;0&quot; dep=&quot;0&quot; <strong class="markup--strong markup--pre-strong">skp=&quot;1&quot;</strong>/&gt;<br>&lt;row op=&quot;2&quot; dis=&quot;1&quot; par=&quot;0&quot; prt=&quot;0&quot; dep=&quot;1&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;3&quot; dis=&quot;2&quot; par=&quot;1&quot; prt=&quot;0&quot; dep=&quot;2&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;4&quot; dis=&quot;2&quot; par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;2&quot; <strong class="markup--strong markup--pre-strong">skp=&quot;1&quot;</strong>/&gt;<br>&lt;row op=&quot;5&quot; dis=&quot;3&quot; par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;3&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;6&quot; dis=&quot;4&quot; par=&quot;3&quot; prt=&quot;0&quot; dep=&quot;4&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;7&quot; dis=&quot;5&quot; par=&quot;3&quot; prt=&quot;0&quot; dep=&quot;4&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;8&quot; dis=&quot;6&quot; par=&quot;2&quot; prt=&quot;0&quot; dep=&quot;3&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;9&quot; dis=&quot;7&quot; par=&quot;1&quot; prt=&quot;0&quot; dep=&quot;2&quot; skp=&quot;0&quot;/&gt;<br>&lt;row op=&quot;10&quot; dis=&quot;7&quot; par=&quot;0&quot; prt=&quot;0&quot; dep=&quot;0&quot; <strong class="markup--strong markup--pre-strong">skp=&quot;1&quot;</strong>/&gt;</pre><p name="d82e" id="d82e" class="graf graf--p graf-after--pre">I can see one row per execution plan operation, referenced by ‘op’, the operation ID, the ‘par’, the PARENT_ID, and ‘dep’ the DEPTH. The ‘skp’ flags with 1 the inactive branches that must be skipped in the default format, and ‘dis’ is the display ID to map to in order to have no gap. I don’t think that the ‘par’ — PART_ID — is currently used by dbms_xplan.</p><p name="27e7" id="27e7" class="graf graf--p graf-after--p">When is this information translated from internal representation to XML? We can see some internal structure copy during Execution such as qesdpCopySharedToExeDisplayMap() and qesdpCopyExeToSharedDisplayMap() but the conversion to XML is done when querying V$SQL_PLAN.OTHER_XML:</p><pre name="0b54" id="0b54" class="graf graf--pre graf-after--p">#0  0x000000000916a390 in <strong class="markup--strong markup--pre-strong">qesdpWriteDisplayMap</strong> ()<br>#1  0x00000000098c447d in qksxaCompactToCustomXml ()<br>#2  0x00000000098c489f in qksxaCompactToXml ()<br>#3  0x000000000befe794 in xplCompactToOtherXml ()<br>#4  0x000000000beff2ee in xplNodeToRow ()<br>#5  0x000000000bf0045d in xplMakeRow ()<br>#6  0x00000000121606aa in xplFetchRow ()<br>#7  0x000000000b0143e8 in kqlfgx ()<br>#8  0x0000000010d87767 in kglic_cbk ()<br>#9  0x0000000010d87035 in kglic0 ()<br>#10 0x0000000010d86d1c in kglic ()<br>#11 0x000000000b01095b in kqlfxp ()<br>#12 0x00000000040b1cf7 in qerfxFetch ()<br>#13 0x00000000120661af in opifch2 ()</pre><p name="f20d" id="f20d" class="graf graf--p graf-after--pre">It is interesting to see that even when this information could have been displayed as columns in V$SQL_PLAN, the CBO developers chose the ‘NoSQL’ way of putting everything new in XML. We see the limit when we try to build our own tools. I must admit that I have some awk scripts which parse the dbms_xplan.display_cursor() text output rather than trying to get information from V$SQL_PLAN…</p><p name="4205" id="4205" class="graf graf--p graf-after--p">About tools other than DBMS_XPLAN, SQL Monitor has the information in the XML. The Flash version differentiate active and inactive operations, but it looks like the SQLDev HTML5 does not (yet)grey the inactive one.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="09c6" id="09c6" class="graf graf--figure graf--layoutOutsetCenter graf-after--p graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1026px; max-height: 398px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.800000000000004%;"></div><img class="graf-image" data-image-id="1*9z7vVWZCsRwiOyHTesRvaQ.png" data-width="1026" data-height="398" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1200/1*9z7vVWZCsRwiOyHTesRvaQ.png"></div></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/384b5f244e0c"><time class="dt-published" datetime="2018-11-27T16:29:54.679Z">November 27, 2018</time></a>.</p><p><a href="https://medium.com/@FranckPachot/oracle-adaptive-plan-info-in-other-xml-384b5f244e0c" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>