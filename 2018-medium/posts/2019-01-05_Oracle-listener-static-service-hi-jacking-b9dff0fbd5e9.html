<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Oracle listener static service hi-jacking</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Oracle listener static service hi-jacking</h1>
</header>
<section data-field="subtitle" class="p-summary">
We must be careful about the services that are registered to a listener because the user connects to them with a good idea of the database…
</section>
<section data-field="body" class="e-content">
<section name="fa77" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="73c8" id="73c8" class="graf graf--h3 graf--leading graf--title">Oracle listener static service hi-jacking</h3><p name="4897" id="4897" class="graf graf--p graf-after--h3">We must be careful about the services that are registered to a listener because the user connects to them with a good idea of the database she wants to connect to, but another database or PDB can dynamically register a service with the same name, and then get the connections which were expected another destination. Of course, as a security best practice, user/password should not be the same in different databases, but what if the connection is done by a common user in multitenant? By creating a service, you can hi-jack the connections to CDB$ROOT and have them connected to your PDB.</p><p name="b86b" id="b86b" class="graf graf--p graf-after--p">You may think that static registration (the SID_LIST_LISTENER in listener.ora) is a solution, especially with the (STATIC_LISTENER=TRUE) introduced in 12cR2, but this defines only the target instance. The PDB is resolved dynamically.</p><p name="515e" id="515e" class="graf graf--p graf-after--p">This post is there only to raise awareness. I’ll not expose the possible exploits. But you can imagine: something that is scheduled to run as SYSDBA on CDB$ROOT can be high-jacked to be run on a PDB where you have more privileges to attempt some privilege escalation.</p><p name="c8d3" id="c8d3" class="graf graf--p graf-after--p">Here is my CDB1 database with PDB1 pluggable database. In addition to the default services, I’ve defined a static service CDB1_DGMGRL.</p><pre name="dcc8" id="dcc8" class="graf graf--pre graf-after--p"># lsnrctl status</pre><pre name="cc56" id="cc56" class="graf graf--pre graf-after--pre">LSNRCTL for Linux: Version 19.0.0.0.0 - Development on 05-JAN-2019 18:06:26</pre><pre name="b8a8" id="b8a8" class="graf graf--pre graf-after--pre">Copyright (c) 1991, 2018, Oracle.  All rights reserved.</pre><pre name="0735" id="0735" class="graf graf--pre graf-after--pre">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=0.0.0.0)(PORT=1521)))<br>STATUS of the LISTENER<br>------------------------<br>Alias                     LISTENER<br>Version                   TNSLSNR for Linux: Version 19.0.0.0.0 - Development<br>Start Date                16-DEC-2018 17:33:58<br>Uptime                    20 days 0 hr. 32 min. 28 sec<br>Trace Level               off<br>Security                  ON: Local OS Authentication<br>SNMP                      OFF<br>Listener Parameter File   /u01/app/oracle/product/19.0.0/network/admin/listener.ora<br>Listener Log File         /u01/app/oracle/diag/tnslsnr/VM190/listener/alert/log.xml<br>Listening Endpoints Summary...<br>  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=VM190)(PORT=1521)))<br>Services Summary...<br>Service &quot;7cd707c6f0a7108ce053be38a8c0058b&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1XDB&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;<strong class="markup--strong markup--pre-strong">CDB1_DGMGRL</strong>&quot; has 1 instance(s).<br>  <strong class="markup--strong markup--pre-strong">Instance &quot;CDB1&quot;, status UNKNOWN</strong>, has 1 handler(s) for this service...<br>Service &quot;pdb1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>The command completed successfully</pre><p name="5a0d" id="5a0d" class="graf graf--p graf-after--pre">I am the PDB administrator, connecting with the local user DEMO to PDB1 and create a service here, with the same name CDB1_DGMGRL</p><pre name="e6d0" id="e6d0" class="graf graf--pre graf-after--p">SQL&gt; connect demo/demo@//localhost/PDB1<br>Connected.</pre><pre name="4c21" id="4c21" class="graf graf--pre graf-after--pre">SQL&gt; show con_name</pre><pre name="dd96" id="dd96" class="graf graf--pre graf-after--pre">CON_NAME<br>------------------------------<br>PDB1</pre><pre name="0983" id="0983" class="graf graf--pre graf-after--pre">SQL&gt; exec <strong class="markup--strong markup--pre-strong">dbms_service.create_service</strong>(service_name=&gt;&#39;CDB1_DGMGRL&#39;, network_name=&gt;&#39;<strong class="markup--strong markup--pre-strong">CDB1_DGMGRL</strong>&#39;);</pre><pre name="c180" id="c180" class="graf graf--pre graf-after--pre">PL/SQL procedure successfully completed.</pre><pre name="e84f" id="e84f" class="graf graf--pre graf-after--pre">SQL&gt; exec dbms_service.start_service(&#39;CDB1_DGMGRL&#39;);</pre><pre name="ffaf" id="ffaf" class="graf graf--pre graf-after--pre">PL/SQL procedure successfully completed.</pre><p name="478b" id="478b" class="graf graf--p graf-after--pre">As I have started the service, it is registered by the listener, in addition to the static one.</p><pre name="a425" id="a425" class="graf graf--pre graf-after--p">Services Summary...<br>Service &quot;7cd707c6f0a7108ce053be38a8c0058b&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1XDB&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;<strong class="markup--strong markup--pre-strong">CDB1_DGMGRL</strong>&quot; has 2 instance(s).<br>  Instance &quot;CDB1&quot;, <strong class="markup--strong markup--pre-strong">status UNKNOWN</strong>, has 1 handler(s) for this service...<br>  Instance &quot;CDB1&quot;, <strong class="markup--strong markup--pre-strong">status READY</strong>, has 1 handler(s) for this service...<br>Service &quot;pdb1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>The command completed successfully</pre><p name="e8f2" id="e8f2" class="graf graf--p graf-after--pre">The registration is not a problem, as it goes to the same instance. The problem is that the instance knows that service as belonging to PDB1. Then, when a common user connects with this service his session switches to the PDB1 container:</p><pre name="8e4f" id="8e4f" class="graf graf--pre graf-after--p"># sqlplus -s sys/oracle@&quot;(DESCRIPTION=(CONNECT_DATA=(<strong class="markup--strong markup--pre-strong">SERVICE_NAME=CDB1_DGMGRL</strong>))(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))&quot; as sysdba &lt;&lt;&lt;&#39;show con_name&#39;</pre><pre name="9116" id="9116" class="graf graf--pre graf-after--pre">CON_NAME<br>------------------------------<br><strong class="markup--strong markup--pre-strong">PDB1</strong></pre><p name="479f" id="479f" class="graf graf--p graf-after--pre">Do not expect (STATIC_SERVICE=TRUE) to change anything, because the static registration has no information about the PDB:</p><pre name="119e" id="119e" class="graf graf--pre graf-after--p"># sqlplus -s sys/oracle@&quot;(DESCRIPTION=(CONNECT_DATA=(SERVICE_NAME=CDB1_DGMGRL)(INSTANCE_NAME=CDB1)<strong class="markup--strong markup--pre-strong">(STATIC_SERVICE=TRUE)</strong>)(ADDRESS=(PROTOCOL=TCP)(HOST=127.0.0.1)(PORT=1521)))&quot; as sysdba &lt;&lt;&lt;&#39;show con_name&#39;</pre><pre name="fcd2" id="fcd2" class="graf graf--pre graf-after--pre">CON_NAME<br>------------------------------<br><strong class="markup--strong markup--pre-strong">PDB1</strong></pre><p name="fce0" id="fce0" class="graf graf--p graf-after--pre">By the way, even when the service is stopped:</p><pre name="c45c" id="c45c" class="graf graf--pre graf-after--p">SQL&gt; connect demo/demo@//localhost/PDB1<br>Connected.<br>SQL&gt; exec dbms_service.stop_service(&#39;CDB1_DGMGRL&#39;);</pre><pre name="ef02" id="ef02" class="graf graf--pre graf-after--pre">PL/SQL procedure successfully completed.</pre><p name="0c8d" id="0c8d" class="graf graf--p graf-after--pre">and then the listener knows only the static declaration:</p><pre name="1ede" id="1ede" class="graf graf--pre graf-after--p">Services Summary...<br>Service &quot;7cd707c6f0a7108ce053be38a8c0058b&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;CDB1XDB&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>Service &quot;<strong class="markup--strong markup--pre-strong">CDB1_DGMGRL</strong>&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, <strong class="markup--strong markup--pre-strong">status UNKNOWN</strong>, has 1 handler(s) for this service...<br>Service &quot;pdb1&quot; has 1 instance(s).<br>  Instance &quot;CDB1&quot;, status READY, has 1 handler(s) for this service...<br>The command completed successfully</pre><p name="753f" id="753f" class="graf graf--p graf-after--pre">the instance will still redirect to PDB1 even if the session is not connected with a service:</p><pre name="5bc1" id="5bc1" class="graf graf--pre graf-after--p">SQL&gt; connect sys/oracle@&quot;(DESCRIPTION=(CONNECT_DATA=(SERVICE_NAME=CDB1_DGMGRL))(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))&quot; as sysdba<br>Connected.<br><br>SQL&gt; select sys_context(&#39;userenv&#39;,&#39;service_name&#39;) from dual;</pre><pre name="e207" id="e207" class="graf graf--pre graf-after--pre">SYS_CONTEXT(&#39;USERENV&#39;,&#39;SERVICE_NAME&#39;)<br>--------------------------------------------------------------------<br><strong class="markup--strong markup--pre-strong">SYS$USERS</strong></pre><pre name="283d" id="283d" class="graf graf--pre graf-after--pre">SQL&gt; show con_name</pre><pre name="0bf3" id="0bf3" class="graf graf--pre graf-after--pre">CON_NAME<br>------------------------------<br><strong class="markup--strong markup--pre-strong">PDB1</strong></pre><p name="4dd6" id="4dd6" class="graf graf--p graf-after--pre">Only when the service is deleted, the connections will stay in CDB$ROOT:</p><pre name="52db" id="52db" class="graf graf--pre graf-after--p">SQL&gt; exec dbms_service.delete_service(&#39;CDB1_DGMGRL&#39;);</pre><pre name="9af4" id="9af4" class="graf graf--pre graf-after--pre">PL/SQL procedure successfully completed.</pre><pre name="2210" id="2210" class="graf graf--pre graf-after--pre"># sqlplus -s sys/oracle@&quot;(DESCRIPTION=(CONNECT_DATA=(SERVICE_NAME=CDB1_DGMGRL)(INSTANCE_NAME=CDB1)(STATIC_SERVICE=TRUE))(ADDRESS=(PROTOCOL=TCP)(HOST=127.0.0.1)(PORT=1521)))&quot; as sysdba &lt;&lt;&lt;&#39;show con_name&#39;</pre><pre name="958c" id="958c" class="graf graf--pre graf-after--pre">CON_NAME<br>------------------------------<br>CDB$ROOT</pre><h4 name="f55c" id="f55c" class="graf graf--h4 graf-after--pre">Solution(s)</h4><p name="da3f" id="da3f" class="graf graf--p graf-after--h4">Basics: be careful with powerful privileges, such as INHERIT PRIVILEGES, which can allow a PDB DBA to overwrite a common user procedure with authid current_user.</p><p name="9672" id="9672" class="graf graf--p graf-after--p">Safe attitude: when you expect your connection to run in CDB$ROOT be sure to do it explicitely with ALTER SESSION SET CONTAINER=CDB$ROOT</p><p name="bde6" id="bde6" class="graf graf--p graf-after--p">Isolation: dedicate a listener for your system administration. Another listener will be the target of REMOTE_LISTENER for dynamic registration.</p><p name="9957" id="9957" class="graf graf--p graf-after--p">Least privileges: when you need only to access to CDB$ROOT connect with a user that has no CONNECT privilege on the PDBs.</p><p name="e486" id="e486" class="graf graf--p graf-after--p graf--trailing">DBaaS: if you are using multitenant for database on-demand provisioning where the user can choose the name of the PDB then be sure that the name cannot be the same as a static service you use. Naming conventions may help there.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/b9dff0fbd5e9"><time class="dt-published" datetime="2019-01-05T20:31:12.685Z">January 5, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/oracle-listener-static-service-hi-jacking-b9dff0fbd5e9" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>