<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>SYS.STATS_TARGET$</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">SYS.STATS_TARGET$</h1>
</header>
<section data-field="subtitle" class="p-summary">
Here is a little note about the SYS.STATS_TARGET$ table used by the automatic statistics gathering job run at maintenance window, or when…
</section>
<section data-field="body" class="e-content">
<section name="3c16" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c96d" id="c96d" class="graf graf--h3 graf--leading graf--title">SYS.STATS_TARGET$</h3><p name="6935" id="6935" class="graf graf--p graf-after--h3">Here is a little note about the SYS.STATS_TARGET$ table used by the automatic statistics gathering job run at maintenance window, or when running it manually with:</p><pre name="f3b4" id="f3b4" class="graf graf--pre graf-after--p">exec dbms_auto_task_immediate.gather_optimizer_stats</pre><p name="8f1f" id="8f1f" class="graf graf--p graf-after--pre">This table is not documented and has no view on it, so those are only my guesses about what I observed, and comments are welcome. Basically, this table is used by the Auto Stats job to list the tables to process, from one execution to the other.</p><p name="5924" id="5924" class="graf graf--p graf-after--p">Note that in 12c the same information is updated into DBA_OPTSTAT_OPERATION_TASKS and visible through DBMS_STATS.REPORT_STATS_OPERATIONS. But I still use STATS_TARGET$ so see in real-time what is currently processed.</p><h3 name="bbd4" id="bbd4" class="graf graf--h3 graf-after--p">Columns description</h3><h4 name="403d" id="403d" class="graf graf--h4 graf-after--h3">STATUS</h4><p name="f78c" id="f78c" class="graf graf--p graf-after--h4">When the Auto Stats job lists the objects to process, they are in state PENDING (STATUS=0).</p><p name="13c5" id="13c5" class="graf graf--p graf-after--p">Then, when it is its turn to be processed, the START_TIME is set to current timestamp and it can be SKIPPED (STATUS=4) or processed IN PROGRESS (STATUS=1)</p><p name="13e5" id="13e5" class="graf graf--p graf-after--p">Then, when processing ends the END_TIME is set to current timestamp and the status can be COMPLETED (STATUS=2) if successful, or FAILED (STATUS=3) in case of error. If it ends before completion at the end of the maintenance window, the IN PROGRESS and PENDING become TIMED OUT (STATUS=5)</p><p name="eb27" id="eb27" class="graf graf--p graf-after--p">Note that START_TIME and END_TIME have been introduced in 12c</p><h4 name="2395" id="2395" class="graf graf--h4 graf-after--p">STALENESS</h4><p name="ef49" id="ef49" class="graf graf--p graf-after--h4">This is similar, but more precise, than the STALE column in DBA_TAB_STATISTICS. Rather than YES/NO we have here an evaluation of staleness (comparing the modifications from DBA_TAB_MODIFICATIONS with the number of rows) in a logarithmic scale between -1.0 and 1.0 where the lowest is the more stale.</p><h3 name="3108" id="3108" class="graf graf--h3 graf-after--p">TYPE# and OBJ#</h3><p name="dd78" id="dd78" class="graf graf--p graf-after--h3">This is the OBJECT_TYPE and OBJECT_ID from DBA_OBJECTS. The decode of TYPE# to OBJECT_TYPE is in the DBA_OBJECTS view on OBJ$ definition. Rather than hardcoding it in my queries, I get it from:</p><pre name="5ea9" id="5ea9" class="graf graf--pre graf-after--p">select /*+ RESULT_CACHE (SYSOBJ=TRUE)*/ <br> distinct type#,object_type <br> from (select object_id obj#,object_type from dba_objects)<br> natural join sys.obj$</pre><h4 name="ab6a" id="ab6a" class="graf graf--h4 graf-after--pre">OSIZE</h4><p name="ec65" id="ec65" class="graf graf--p graf-after--h4">This is the estimated object size, from the known number of blocks and blocksize, and can be used to estimate roughly the time it takes to gather statistics.</p><h4 name="6de4" id="6de4" class="graf graf--h4 graf-after--p">BO# and PART#</h4><p name="ab38" id="ab38" class="graf graf--p graf-after--h4">Those are the physical identifiers for partitions and subpartitions, tables: it makes the links with the parent object, and between index and table, probably for the purpose of CASCADE gathering.</p><h4 name="574a" id="574a" class="graf graf--h4 graf-after--p">FLAGS</h4><p name="51df" id="51df" class="graf graf--p graf-after--h4">This is a bitmap with some information about the staleness and the status. Here is my decode (which may be wrong as it is not documented)</p><pre name="710c" id="710c" class="graf graf--pre graf-after--p">ltrim(<br>   case when bitand(flags,1)=1 then &#39;,RETRY&#39; end <br>|| case when bitand(flags,2)=2 then &#39;,NON-SEGMENT&#39; end <br>|| case when bitand(flags,4)=4 then &#39;,?&#39; end <br>|| case when bitand(flags,8)=8 then &#39;,TIMED OUT&#39; end <br>|| case when bitand(flags,16)=16 then &#39;,?&#39; end <br>|| case when bitand(flags,32)=32 then &#39;,GATHER GLOBAL&#39; end <br>|| case when bitand(flags,64)=64 then &#39;,GATHER PARTITION&#39; end <br>|| case when bitand(flags,128)=128 then &#39;,MISSING COL STATS&#39; end <br>|| case when bitand(flags,256)=256 then &#39;,STALE STATS&#39; end <br>|| case when bitand(flags,512)=512 then &#39;,NO STATS&#39; end <br>|| case when bitand(flags,1024)=1024 then &#39;,HAS DIRECTIVES&#39; end <br>|| case when bitand(flags,2048)=2048 then &#39;,MISSING EXTENSION&#39; end <br>|| case when bitand(flags,4096)=4096 then &#39;,MISSING HISTOGRAM&#39; end <br>|| case when bitand(flags,8192)=8192 then &#39;,CASCADED&#39; end <br>|| case when bitand(flags,16384)=16384 then &#39;,REPORTING RUN&#39; end <br>|| case when bitand(flags,32768)=32768 then &#39;,FIXED TABLE&#39; end <br>|| case when bitand(flags,65536)=65536 then &#39;,SYNOPSIS MISMATCH&#39; end<br>,&#39;,&#39;) flags</pre><p name="3e5a" id="3e5a" class="graf graf--p graf-after--pre">RETRY is for the gathering which was IN PROGRESS and was stopped with TIMED OUT.</p><h4 name="8d02" id="8d02" class="graf graf--h4 graf-after--p">SID, SERIAL#</h4><p name="e3fa" id="e3fa" class="graf graf--p graf-after--h4">The last session running the Auto Stats (i.e PENDING, IN PROGRESS, TIMED OUT) is identified here so you can join with V$SESSION or even V$ACTIVE_SESSION_HISTORY to get more information afterward about the duration (which is END_TIME-START_TIME). You can also find the long-running ones in V$SQL_MONITOR.</p><h3 name="407b" id="407b" class="graf graf--h3 graf-after--p">Query examples</h3><h4 name="708a" id="708a" class="graf graf--h4 graf-after--h3">details</h4><p name="3480" id="3480" class="graf graf--p graf-after--h4">Here is an example while the Auto Stats job is running. This shows which table is currently gathered (IN PROGRESS), already done (COMPLETED) or to be done (PENDING). The flags indicate that the previous execution was TIMED OUT, and which is global level gathering.</p><p name="363c" id="363c" class="graf graf--p graf-after--p">I also join with V$SESSION in order to see the currently running job (and its login time) as I’m in 11g without the START_TIME:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="337e" id="337e" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 414px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.1%;"></div><img class="graf-image" data-image-id="1*pM8KfJAPReBkIcAMd7StHg.png" data-width="1107" data-height="444" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1200/1*pM8KfJAPReBkIcAMd7StHg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2165" id="2165" class="graf graf--p graf-after--figure">Here is the query I used for this output:</p><pre name="cd22" id="cd22" class="graf graf--pre graf-after--p">select logon_time<br>--,start_time,end_time,end_time-start_time duration<br>--,start_time-lag(end_time)over(partition by sid,serial# order by start_time) after_previous,<br>,object_type,owner,object_name,subobject_name,sid||&#39;,&#39;||serial# &quot;sid/ser#&quot;,round(osize/1024/1024/1024) GBytes<br>,rtrim(case status when 0 then &#39;PENDING&#39; when 1 then &#39;IN PROGRESS&#39; when 2 then &#39;COMPLETED&#39; when 3 then &#39;FAILED&#39;<br>                   when 4 then &#39;SKIPPED&#39; when 5 then &#39;TIMEOUT&#39; end) STATUS,status status#<br>,case staleness when -100 then &#39;MISSING&#39; when -99 then null <br> else rtrim(&#39;STALE &#39;||lpad(&#39; &#39;,round(2*(1+(staleness))),&#39;+&#39;)) end staleness<br>,ltrim(<br>   case when bitand(flags,1)=1 then &#39;,TIMED OUT&#39; end <br>|| case when bitand(flags,2)=2 then &#39;,NON-SEGMENT&#39; end <br>|| case when bitand(flags,4)=4 then &#39;,4&#39; end <br>|| case when bitand(flags,8)=8 then &#39;,TIMED_OUT&#39; end <br>|| case when bitand(flags,16)=16 then &#39;,16&#39; end <br>|| case when bitand(flags,32)=32 then &#39;,GATHER GLOBAL&#39; end <br>|| case when bitand(flags,64)=64 then &#39;,GATHER PARTITION&#39; end <br>|| case when bitand(flags,128)=128 then &#39;,MISSING CSTATS&#39; end <br>|| case when bitand(flags,256)=256 then &#39;,STALE STATS&#39; end <br>|| case when bitand(flags,512)=512 then &#39;,NO STATS&#39; end <br>|| case when bitand(flags,1024)=1024 then &#39;,HAS DIRECTIVES&#39; end <br>|| case when bitand(flags,2048)=2048 then &#39;,MISSING EXTENSION&#39; end <br>|| case when bitand(flags,4096)=4096 then &#39;,MISSING HISTOGRAM&#39; end <br>|| case when bitand(flags,8192)=8192 then &#39;,CASCADED&#39; end <br>|| case when bitand(flags,16384)=16384 then &#39;,REPORTING RUN&#39; end <br>|| case when bitand(flags,32768)=32768 then &#39;,FIXED TABLE&#39; end <br>|| case when bitand(flags,65536)=65536 then &#39;,SYNOPSIS MISMATCH&#39; end<br>,&#39;,&#39;) flags<br>from (<br>select *<br>from STATS_TARGET$<br>natural left outer join (select /*+ result_cache */ distinct type#,object_type from (select object_id obj#,object_type from dba_objects) natural join sys.obj$)<br>natural left outer join (select object_id obj#,owner,object_name,subobject_name from dba_objects)<br>natural left outer join (select sid,serial#,program,sql_id,logon_time from gv$session)<br>left outer join (select bo#,part#,hiboundval,analyzetime,obj# part_obj# from sys.tabpart$) using(bo#,part#)<br>) v <br>--order by end_time desc nulls last, start_time desc nulls last<br>order by logon_time desc nulls last,status#<br>/</pre><h4 name="9824" id="9824" class="graf graf--h4 graf-after--pre">summary</h4><p name="0d88" id="0d88" class="graf graf--p graf-after--h4">Here is another query which checks the global status while the Auto Stats job is running:</p><pre name="122f" id="122f" class="graf graf--pre graf-after--p">select logon_time,status,staleness,count(*),sum(GBytes) GBytes<br>,object_type,round(100*sum(GBytes)/max(TotGB)) &quot;%&quot;<br>from (<br>select logon_time,object_type,round(osize/1024/1024/1024) GBytes,sum(osize/1024/1024/1024)over(partition by logon_time,object_type) TotGB<br>,rtrim(case status when 0 then &#39;PENDING&#39; when 1 then &#39;IN PROGRESS&#39; when 2 then &#39;COMPLETED&#39; when 3 then &#39;FAILED&#39; when 4 then &#39;SKIPPED&#39; when 5 then &#39;TIMEOUT&#39; end) STATUS<br>,case staleness when -100 then &#39;MISSING&#39; when -99 then null else &#39;STALE&#39; end staleness<br>from STATS_TARGET$<br>natural left outer join (select /*+ result_cache */ distinct type#,object_type from (select object_id obj#,object_type from dba_objects) natural join sys.obj$)<br>natural left outer join (select sid,serial#,program,sql_id,logon_time from gv$session)<br>)<br>group by logon_time,object_type,status,staleness having logon_time is not null <br>order by logon_time nulls last,status,object_type,staleness;<br><br></pre><pre name="4566" id="4566" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">LOGON_TIME        STATUS      STALENE   COUNT(*)     GBYTES<br>----------------- ----------- ------- ---------- ----------<br>15-JAN-2019 08:44 COMPLETED   STALE          288       2177<br>15-JAN-2019 08:44 IN PROGRESS STALE            1        210<br>15-JAN-2019 08:44 PENDING     MISSING      58744      18311<br>15-JAN-2019 08:44 PENDING     STALE         2567       8579<br>15-JAN-2019 08:44 PENDING                     55          0</strong></pre><h3 name="6a2b" id="6a2b" class="graf graf--h3 graf-after--pre">Processing order</h3><p name="0cfd" id="0cfd" class="graf graf--p graf-after--h3 graf--trailing">As this table is used to list the tables to process, the columns are used to order it. We know that the Auto Stats starts with the most stale (and MISSING is the first there). But before that, the tables are listed before the partitions, and partitions before subpartition. And tables are processed before indexes.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/f5aa6700e17e"><time class="dt-published" datetime="2019-01-16T19:42:59.705Z">January 16, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/sys-stats-target-f5aa6700e17e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>