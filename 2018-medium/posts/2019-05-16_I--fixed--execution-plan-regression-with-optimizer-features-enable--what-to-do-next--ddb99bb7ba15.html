<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>I ‘fixed’ execution plan regression with optimizer_features_enable, what to do next?</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">I ‘fixed’ execution plan regression with optimizer_features_enable, what to do next?</h1>
</header>
<section data-field="subtitle" class="p-summary">
Here is a simple example of using Mauro Pagano ‘pathfinder’ tool where you don’t really want to run the query, but just get the execution…
</section>
<section data-field="body" class="e-content">
<section name="c4b1" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1976" id="1976" class="graf graf--h3 graf--leading graf--title">I ‘fixed’ execution plan regression with optimizer_features_enable, what to do next?</h3><p name="9e05" id="9e05" class="graf graf--p graf-after--h3">Here is a simple example of using Mauro Pagano ‘pathfinder’ tool where you don’t really want to run the query, but just get the execution plan with all variations of optimizer settings. That’s something I used many times in situations similar to this one:</p><ul class="postList"><li name="b96a" id="b96a" class="graf graf--li graf-after--p">the database was upgraded, say from 11.2.0.4 to 19.3</li><li name="20ba" id="20ba" class="graf graf--li graf-after--li">one (or a few) SQL statements have problematic performance regression</li><li name="febf" id="febf" class="graf graf--li graf-after--li">the execution plan (in 19.3) is different than from the previous version (11.2.0.4) — you get both with SQL Tuning Sets or AWR</li><li name="2642" id="2642" class="graf graf--li graf-after--li">you set optimizer_features_enable to 11.2.0.4 and the old plan with acceptable performance is back</li></ul><p name="7f20" id="7f20" class="graf graf--p graf-after--li">That’s a quick workaround, thanks to this unique Oracle Optimizer feature which let us run the latest version of the database with a previous version of the optimizer code. But the goal is not to stay long like this. Once the service is made acceptable again with this temporary setting, the second step is to understand which bug or feature is responsible for the change. Then, at least, the workaround can be limited to only one underscore setting instead of the generic optimizer_features_enable which sets hundreds of them. The third step then will be to fix the root cause, of course, and understanding what was wrong will help.</p><figure name="30a0" id="30a0" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 525px; max-height: 695px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 132.4%;"></div><img class="graf-image" data-image-id="1*YMCOjGEVRDIAnYyzw9p47g.png" data-width="694" data-height="919" data-is-featured="true" src="https://cdn-images-1.medium.com/max/600/1*YMCOjGEVRDIAnYyzw9p47g.png"></div></figure><p name="8a29" id="8a29" class="graf graf--p graf-after--figure">This post is about the second step — going from the general optimizer_features_enable to a unique focused setting.</p><p name="8f41" id="8f41" class="graf graf--p graf-after--p">This is something I wanted to write for a long time but I was always in a rush when encountering this kind of problem. But I’m currently attending Mike Dietrich upgrade workshop at AOUG conference in Vienna and this, the change of execution plan, is addressed by the exercises. Mike exposes the tools that can be used to compare the performance before and after the upgrade: capture the statements and performance statistics and compare them, and to fix them with SQL Plan Management.</p><p name="10e0" id="10e0" class="graf graf--p graf-after--p">The workshop instructions are on Mike’s blog:</p><div name="74b5" id="74b5" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://mikedietrichde.com/database-upgrade-hands-on-lab-oracle-18c-and-19c/hol-19c-main-index-page-oracle-database-19c-hands-on-lab/" data-href="https://mikedietrichde.com/database-upgrade-hands-on-lab-oracle-18c-and-19c/hol-19c-main-index-page-oracle-database-19c-hands-on-lab/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://mikedietrichde.com/database-upgrade-hands-on-lab-oracle-18c-and-19c/hol-19c-main-index-page-oracle-database-19c-hands-on-lab/"><strong class="markup--strong markup--mixtapeEmbed-strong">HOL 19c - Main Index Page</strong><br><em class="markup--em markup--mixtapeEmbed-em">HOL 19c - Main Index Page - Oracle Database 19c Hands-On Lab - Find all instructions and many tips and tricks in this…</em>mikedietrichde.com</a><a href="https://mikedietrichde.com/database-upgrade-hands-on-lab-oracle-18c-and-19c/hol-19c-main-index-page-oracle-database-19c-hands-on-lab/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="298c84e9552621928754d62ea86ecb75" data-thumbnail-img-id="0*rjS3kXxvM6z7vtk3" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*rjS3kXxvM6z7vtk3);"></a></div><p name="e0a5" id="e0a5" class="graf graf--p graf-after--mixtapeEmbed">If you did the workshop you have seen that the query sql_id=13dn4hkrzfpdy has a different execution plan between 11g and 19c and the idea of the lab is to fix the previous plan with a SQL Plan Baseline. That’s perfect, but I was curious about the reason for this execution plan change. There are many new features or fixes between 11.2.0.4 and 19.3 and one is probably responsible for that.</p><p name="24df" id="24df" class="graf graf--p graf-after--p">This is where Mauro Pagano ‘pathfinder’ can be used. Setting optimizer_features_enable is a shortcut to set all individual features or fixes, and pathfinder will try each of them one by one.</p><p name="dec8" id="dec8" class="graf graf--p graf-after--p">The query with a plan regression was:</p><pre name="472d" id="472d" class="graf graf--pre graf-after--p">SQL Details:<br>-----------------------------<br> Object ID            : 34<br> Schema Name          : TPCC<br> Container Name       : Unknown (con_dbid: 72245725)<br> SQL ID               : 13dn4hkrzfpdy<br> Execution Frequency  : 3273<br> SQL Text             : <br>SELECT COUNT(DISTINCT (S_I_ID)) FROM ORDER_LINE, STOCK<br> WHERE OL_W_ID = :B2 AND OL_D_ID = :B4 AND (OL_O_ID &lt; :B3<br> ) AND OL_O_ID &gt;= (:B3 - 20) AND S_W_ID = :B2 AND S_I_ID =<br> OL_I_ID AND S_QUANTITY &lt; :B1</pre><p name="59ea" id="59ea" class="graf graf--p graf-after--pre">The plan before and after, as reported by AWR Diff Report are the following:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="9e22" id="9e22" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 1062px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 102.89999999999999%;"></div><img class="graf-image" data-image-id="1*DSPNL2Jv7JsVUtOcS39F2Q.png" data-width="1359" data-height="1399" src="https://cdn-images-1.medium.com/max/1200/1*DSPNL2Jv7JsVUtOcS39F2Q.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="5a1b" id="5a1b" class="graf graf--p graf-after--figure">And my goal is to understand which feature or fix control, when disabled, gets back to the plan hash value 954326358 instead of 3300316041</p><p name="0ade" id="0ade" class="graf graf--p graf-after--p">I installed sqldb360 (open sourced by Carlos Sierra and Mauro Pagano), which contains pathfinder:</p><pre name="0f99" id="0f99" class="graf graf--pre graf-after--p">git clone <a href="https://github.com/sqldb360/sqldb360.git" data-href="https://github.com/sqldb360/sqldb360.git" class="markup--anchor markup--pre-anchor" rel="nofollow noopener noopener" target="_blank">https://github.com/sqldb360/sqldb360.git</a><br>cd ./sqldb360/sql/</pre><p name="8c7f" id="8c7f" class="graf graf--p graf-after--pre">I changed the script.sql to put my query there with an EXPLAIN PLAN because I don’t want to execute it (which would require parameters):</p><pre name="a888" id="a888" class="graf graf--pre graf-after--p">alter session set current_schema=TPCC;</pre><pre name="5cc7" id="5cc7" class="graf graf--pre graf-after--pre">explain plan for<br> SELECT  /* ^^pathfinder_testid */<br>  COUNT(DISTINCT (S_I_ID)) FROM ORDER_LINE, STOCK<br>  WHERE OL_W_ID = :B2 AND OL_D_ID = :B4 AND (OL_O_ID &lt; :B3<br>  ) AND OL_O_ID &gt;= (:B3 - 20) AND S_W_ID = :B2 AND S_I_ID =<br>  OL_I_ID AND S_QUANTITY &lt; :B1</pre></div><div class="section-inner sectionLayout--outsetColumn"><figure name="f171" id="f171" class="graf graf--figure graf--layoutOutsetCenter graf-after--pre"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 444px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43%;"></div><img class="graf-image" data-image-id="1*SoiYOyAD5TOXrR141sECvA.png" data-width="1596" data-height="686" src="https://cdn-images-1.medium.com/max/1200/1*SoiYOyAD5TOXrR141sECvA.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="8ae9" id="8ae9" class="graf graf--p graf-after--figure">By default, pathfinder executes the query and gets the execution plan with dbms_xplan.display_cursor, using the tag in the comment to identify it.</p><p name="3133" id="3133" class="graf graf--p graf-after--p">Here I’m doing an EXPLAIN PLAN and then I changed the pathfinder.sql to use dbms_xplan.display. My change in the ‘xplan driver’ is the following:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="bf98" id="bf98" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 418px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.5%;"></div><img class="graf-image" data-image-id="1*NrfOXC6dQlwOhHUUsAKRjg.png" data-width="1934" data-height="783" src="https://cdn-images-1.medium.com/max/1200/1*NrfOXC6dQlwOhHUUsAKRjg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2218" id="2218" class="graf graf--p graf-after--figure">I’ve left the old query, but add the following one to be executed:</p><pre name="7a53" id="7a53" class="graf graf--pre graf-after--p">-- my addition there<br>PRO .<br>PRO SELECT RPAD(&#39;explain plan&#39;, 11) inst_child, plan_table_output<br>PRO FROM TABLE(DBMS_XPLAN.DISPLAY(&#39;PLAN_TABLE&#39;, NULL, &#39;ADVANCED&#39;))<br>-- done<br>PRO /</pre><p name="0a57" id="0a57" class="graf graf--p graf-after--pre">Then running pathfinder:</p><pre name="bbd3" id="bbd3" class="graf graf--pre graf-after--p">[oracle@hol]$ sqlplus / as sysdba @ pathfinder.sql &#39;&quot;/ as sysdba&quot;&#39;</pre><p name="0f01" id="0f01" class="graf graf--p graf-after--pre">This takes some time to test all settings for optimizer underscore parameters (632 ones here in 19.3) and fix controls (1459 here):</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="21fe" id="21fe" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 519px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.3%;"></div><img class="graf-image" data-image-id="1*jLtkMrU5RK7QqS97D1PD6Q.png" data-width="1613" data-height="811" src="https://cdn-images-1.medium.com/max/1200/1*jLtkMrU5RK7QqS97D1PD6Q.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="a743" id="a743" class="graf graf--p graf-after--figure">The result is a zip file containing an index and the detail of each test.</p><p name="6168" id="6168" class="graf graf--p graf-after--p">The index (00001_pathfinder_upgr_20190515_1113_index.html) has one line per combination and it is easy to search from the plan hash value:</p><p name="894f" id="894f" class="graf graf--p graf-after--p">My old plan is chosen when _optimizer_partial_join_eval is set to false:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="cc59" id="cc59" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 191px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 18.6%;"></div><img class="graf-image" data-image-id="1*jKpkFbATArx5fh8Wq118Ww.png" data-width="1773" data-height="329" src="https://cdn-images-1.medium.com/max/1200/1*jKpkFbATArx5fh8Wq118Ww.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="bb58" id="bb58" class="graf graf--p graf-after--figure">And now, I have a better workaround. Instead of setting the optimizer_feature_enable, I can set only:</p><pre name="50ba" id="50ba" class="graf graf--pre graf-after--p">ALTER SESSION SET &quot;_optimizer_partial_join_eval&quot; = FALSE;</pre><p name="9228" id="9228" class="graf graf--p graf-after--pre">Of course, my search for the plan hash value also highlights which versions set the same:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="60a5" id="60a5" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 218px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 21.099999999999998%;"></div><img class="graf-image" data-image-id="1*UMznKBngS5ESu6YRzvO7zg.png" data-width="1777" data-height="375" src="https://cdn-images-1.medium.com/max/1200/1*UMznKBngS5ESu6YRzvO7zg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="b6b1" id="b6b1" class="graf graf--p graf-after--figure">The goal of this post is to show the tool. If you want to know more about Partial Join Evaluation, Google tells me that I blogged about this in the past:</p><div name="ada3" id="ada3" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://blog.dbi-services.com/partial-join-evaluation-in-oracle-12c/" data-href="https://blog.dbi-services.com/partial-join-evaluation-in-oracle-12c/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://blog.dbi-services.com/partial-join-evaluation-in-oracle-12c/"><strong class="markup--strong markup--mixtapeEmbed-strong">Partial Join Evaluation in Oracle 12c - Blog dbi services</strong><br><em class="markup--em markup--mixtapeEmbed-em">Do you think that it&#39;s better to write semi-join SQL statements with IN(), EXISTS(), or to do a JOIN? Usually, the…</em>blog.dbi-services.com</a><a href="https://blog.dbi-services.com/partial-join-evaluation-in-oracle-12c/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="383e3b78ff0a26313e025148dede5a76" data-thumbnail-img-id="0*7G_hDa_Q_NYyUSkd" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*7G_hDa_Q_NYyUSkd);"></a></div><p name="2d2b" id="2d2b" class="graf graf--p graf-after--mixtapeEmbed">The query here, a count(distinct) on a join, is subject to this optimization which changes the join to a semi-join.</p><p name="aff4" id="aff4" class="graf graf--p graf-after--p">If I can change the query, maybe I’ll prefer to disable it with a hint. If I click on the baseline plan from the pathfinder index, I can see the plan with hints:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="00d3" id="00d3" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 1088px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 105.5%;"></div><img class="graf-image" data-image-id="1*OlsBuQi1K2icpHgixE0BrQ.png" data-width="1536" data-height="1620" src="https://cdn-images-1.medium.com/max/1200/1*OlsBuQi1K2icpHgixE0BrQ.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="6789" id="6789" class="graf graf--p graf-after--figure">Then probably a NO_PARTIAL_JOIN can disable this feature.</p><p name="a04a" id="a04a" class="graf graf--p graf-after--p">Side remark: you can see OPTIMIZER_FEATURES_ENABLE(‘19.1.0&#39;) but I told you that I’m on 19.3, right? And that this is the pathfinder baseline without any session setting. I didn’t expect 19.3 there because Release Updates should not add features that change the execution plan. But I expected something like ‘19.0.0’. The magic of the new release model…</p><h4 name="5cb3" id="5cb3" class="graf graf--h4 graf-after--p">In summary:</h4><ul class="postList"><li name="a135" id="a135" class="graf graf--li graf-after--h4">Pathfinder is easy to run, give it a try when you need to understand why an execution plan has changed.</li><li name="58a5" id="58a5" class="graf graf--li graf-after--li">Do the Mike Dietrich hands-on lab: upgrade is something to exercise before doing it in production.</li><li name="cf67" id="cf67" class="graf graf--li graf-after--li">Since 8i, the Oracle Optimizer developers add a flag for any change, in order to give us the possibility to enable or disable the feature or the fix. And you control it at instance, session or query level. This is a unique feature you do not find on other database systems. And it can save your business because a critical regression can always happen after an upgrade.</li><li name="7f67" id="7f67" class="graf graf--li graf-after--li graf--trailing">AOUG conference had a great idea with the ‘workshop and live-demo’ day before the conference day. Fewer attendees and more interaction with the speakers.</li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/ddb99bb7ba15"><time class="dt-published" datetime="2019-05-16T19:21:47.704Z">May 16, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/i-fixed-execution-plan-regression-with-optimizer-features-enable-what-to-do-next-ddb99bb7ba15" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>