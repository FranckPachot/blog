<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>19c Observe-Only Data Guard FSFO: no split-brain risk in manual failover</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">19c Observe-Only Data Guard FSFO: no split-brain risk in manual failover</h1>
</header>
<section data-field="subtitle" class="p-summary">
Fast-Start Failover (FSFO) is an amazing feature of Oracle Data Guard Broker which brings High Availability (HA)features in addition to…
</section>
<section data-field="body" class="e-content">
<section name="6221" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9892" id="9892" class="graf graf--h3 graf--leading graf--title">19c Observe-Only Data Guard FSFO: no split-brain risk in manual failover</h3><p name="e055" id="e055" class="graf graf--p graf-after--h3">Fast-Start Failover (FSFO) is an amazing feature of Oracle Data Guard Broker which brings High Availability (HA)features in addition to the Disaster Recovery (DR) one.</p><h4 name="44f9" id="44f9" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Data Guard as an HA solution</strong></h4><p name="5b4b" id="5b4b" class="graf graf--p graf-after--h4">By default, a physical standby database protects from Disaster Recovery (like when your Data Center is on fire or underwater, or with a power cut,…). But it requires a manual action to do the failover. Then, even if the failover is quick (seconds to minutes) and there’s no loss of data (if in SYNC), it cannot be considered as HA because of the manual decision which can take hours. The idea of the manual decision is to understand the cause as it may be better to just wait in case of a transient failure. Especially if the standby site is less powerful and application performance will be degraded.</p><p name="bb68" id="bb68" class="graf graf--p graf-after--p">With FSFO, the failure of the primary database is automatically detected (with an observer process constantly testing the connection from another site) and then the failover to a designated standby is initiated. If Transparent Application Failover (TAF) is correctly configured, the application will directly reconnect to the new primary without your intervention.</p><p name="f8f2" id="f8f2" class="graf graf--p graf-after--p">How does the observer decide that the primary is down? By default, the failover is triggered when the primary is not reachable by both the observer and by the standby. In 12c, thanks to the ObserverOverride property, it is also possible to get the observer issuing the failover as soon as it cannot connect to the primary, even when the standby can see the primary. This can be used when the observer is on the application side.</p><p name="1f86" id="1f86" class="graf graf--p graf-after--p">12cR2 brought new additional possibilities for complex Data Guard configurations, such as defining multiple observers and multiple targets.</p><h4 name="7456" id="7456" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">No human decision?</strong></h4><p name="ece7" id="ece7" class="graf graf--p graf-after--h4">However, FSFO is faster than a manual decision but may initiate a failover when we do not want it. If the observer is on the same site as the primary (bad idea) then a network connection between the two sites will trigger the failover. When running in FSFO you must be sure that all your infrastructure is ok so that no undesired failover is initiated, and that you have no manual tasks to do in order to get the applications running again.</p><h4 name="690a" id="690a" class="graf graf--h4 graf-after--p">Enable FSFO in observe-only mode</h4><p name="72eb" id="72eb" class="graf graf--p graf-after--h4">If it is not the case, you will not decide to automate the failover. This is where 19c ‘observe only’ mode is interesting. The observer will report the failure but will not initiate a failover. I enable FSFO in this mode:</p><pre name="3f2c" id="3f2c" class="graf graf--pre graf-after--p">[oracle@cloud ~]$ dgmgrl / &quot;<strong class="markup--strong markup--pre-strong">enable fast_start failover observe only</strong>&quot;<br>DGMGRL for Linux: Release 19.0.0.0.0 - Production on Wed Mar 6 10:02:01 2019<br>Version 19.2.0.0.0</pre><pre name="c8fe" id="c8fe" class="graf graf--pre graf-after--pre">Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.</pre><pre name="9085" id="9085" class="graf graf--pre graf-after--pre">Welcome to DGMGRL, type &quot;help&quot; for information.<br>Connected to &quot;CDB1A&quot;<br>Connected as SYSDG.<br>Enabled <strong class="markup--strong markup--pre-strong">in Observe-Only Mode</strong>.</pre><p name="776c" id="776c" class="graf graf--p graf-after--pre">And start the observer (you should use the full syntax to run it in background with a log directory, but this is just for a small test which logs on my screen):</p><pre name="c371" id="c371" class="graf graf--pre graf-after--p">[oracle@cloud ~]$ dgmgrl sys/oracle &quot;<strong class="markup--strong markup--pre-strong">start observer</strong>&quot; &amp;<br>[1] 26589</pre><pre name="d7d1" id="d7d1" class="graf graf--pre graf-after--pre">[oracle@cloud ~]$ DGMGRL for Linux: Release 19.0.0.0.0 - Production on Wed Mar 6 10:04:50 2019<br>Version 19.2.0.0.0</pre><pre name="0388" id="0388" class="graf graf--pre graf-after--pre">Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.</pre><pre name="4129" id="4129" class="graf graf--pre graf-after--pre">Welcome to DGMGRL, type &quot;help&quot; for information.<br>Connected to &quot;CDB1A&quot;<br>Connected as SYSDBA.<br><strong class="markup--strong markup--pre-strong">Observer &#39;cloud&#39; started</strong></pre><pre name="099e" id="099e" class="graf graf--pre graf-after--pre">[W000 2019-03-06T10:04:50.342+00:00] Observer trace level is set to USER<br>[W000 2019-03-06T10:04:50.342+00:00] Try to connect to the primary.</pre><p name="8508" id="8508" class="graf graf--p graf-after--pre">Now if I simulate a crash of the primary database, killing the PMON process:</p><pre name="f547" id="f547" class="graf graf--pre graf-after--p">[oracle@cloud ~]$ kill -9 $(pgrep -f ora_pmon_CDB1A)</pre><p name="3c9d" id="3c9d" class="graf graf--p graf-after--pre">This immediately logs the following from the observer:</p><pre name="8b2d" id="8b2d" class="graf graf--pre graf-after--p">[oracle@cloud ~]$ [W000 2019-03-06T10:37:50.198+00:00] <strong class="markup--strong markup--pre-strong">Primary database cannot be reached</strong>.<br>[W000 2019-03-06T10:37:50.198+00:00] Fast-Start Failover threshold has not exceeded. <strong class="markup--strong markup--pre-strong">Retry for the next 30 seconds</strong></pre><p name="d667" id="d667" class="graf graf--p graf-after--pre">The default 30 seconds threshold is there to avoid a failover decision in case of a transient network failure.</p><p name="e97d" id="e97d" class="graf graf--p graf-after--p">After this threshold, a fast-start failover would have been initiated in normal FSFO mode, but here it is only reported in the log:</p><pre name="7113" id="7113" class="graf graf--pre graf-after--p"><br>[W000 2019-03-06T10:37:51.198+00:00] Try to connect to the primary.<br>ORA-12537: TNS:connection closed<br>Unable to connect to database using //cloud:1521/CDB1A_DGMGRL<br>[W000 2019-03-06T10:37:51.235+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:37:52.235+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:37:53.287+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:37:54.288+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:17.902+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:17.902+00:00] Fast-Start Failover threshold has not exceeded. <strong class="markup--strong markup--pre-strong">Retry for the next 3 seconds</strong><br>[W000 2019-03-06T10:38:18.902+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:19.952+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:19.952+00:00] Fast-Start Failover threshold has not exceeded. <strong class="markup--strong markup--pre-strong">Retry for the next 1 second</strong><br>[W000 2019-03-06T10:38:20.952+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:22.003+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:22.003+00:00] Fast-Start Failover threshold has expired.<br>[W000 2019-03-06T10:38:22.003+00:00] Try to connect to the standby.<br>[W000 2019-03-06T10:38:22.003+00:00] Making a last connection attempt to primary database before proceeding with Fast-Start Failover.<br>[W000 2019-03-06T10:38:22.003+00:00] Check if the standby is ready for failover.<br>[W000 2019-03-06T10:38:22.006+00:00] <strong class="markup--strong markup--pre-strong">A fast-start failover would have been initiated...</strong><br>[W000 2019-03-06T10:38:22.006+00:00] <strong class="markup--strong markup--pre-strong">Unable to failover since this observer is in observe-only mode</strong><br>[W000 2019-03-06T10:38:22.006+00:00] <strong class="markup--strong markup--pre-strong">Fast-Start Failover is not possible because observe-only mode.</strong><br>[W000 2019-03-06T10:38:23.007+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:24.058+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:25.058+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:26.110+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:27.110+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:50.727+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:50.727+00:00] Fast-Start Failover threshold has not exceeded. Retry for the next 3 seconds<br>[W000 2019-03-06T10:38:51.727+00:00] Try to connect to the primary.<br>[W000 2019-03-06T10:38:52.777+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T10:38:52.777+00:00] Fast-Start Failover threshold has not exceeded. Retry for the next 1 second<br>...</pre><p name="ab11" id="ab11" class="graf graf--p graf-after--pre">Of course, this is something you should monitor, and have a manual decision about it. This is useful to run the FSFO in ‘dry-run’ mode where you want to be sure that your infrastructure is ok, without false alerts, before having it fully automated. But even when you don’t want to go to fully automated FSFO, this mode is very helpful for the post-failover tasks.</p><p name="a5b2" id="a5b2" class="graf graf--p graf-after--p">Let’s say I decide to failover. I do not stop the observer. I do not disable FSFO. I just initiate the failover manually:</p><pre name="2cc5" id="2cc5" class="graf graf--pre graf-after--p">DGMGRL&gt; failover to cdb1b;<br>Failover succeeded, new primary is &quot;cdb1b&quot;</pre><p name="914a" id="914a" class="graf graf--p graf-after--pre">The observer is still running and detects that the primary has changed:</p><pre name="668a" id="668a" class="graf graf--pre graf-after--p">[W000 2019-03-06T13:13:25.182+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T13:13:25.182+00:00] Fast-Start Failover threshold has not exceeded. Retry for the next 2 seconds<br>[W000 2019-03-06T13:13:26.183+00:00] Try to connect to the primary.<br>[W000 2019-03-06T13:13:27.233+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T13:13:27.233+00:00] Fast-Start Failover threshold has expired.<br>[W000 2019-03-06T13:13:27.233+00:00] Try to connect to the standby.<br>[W000 2019-03-06T13:13:27.233+00:00] Making a last connection attempt to primary database before proceeding with Fast-Start Failover.<br>[W000 2019-03-06T13:13:27.280+00:00] Check if the standby is ready for failover.<br>[W000 2019-03-06T13:13:27.285+00:00] A fast-start failover would have been initiated...<br>[W000 2019-03-06T13:13:27.285+00:00] Unable to failover since this observer is in observe-only mode<br>[W000 2019-03-06T13:13:27.285+00:00] Fast-Start Failover is not possible because observe-only mode.<br>[W000 2019-03-06T13:13:28.284+00:00] Try to connect to the primary.<br>[W000 2019-03-06T13:13:28.284+00:00] Primary database cannot be reached.<br>[W000 2019-03-06T13:13:28.284+00:00] Fast-Start Failover observe-only mode enabled.<br>[W000 2019-03-06T13:13:28.284+00:00] Will not attempt a Fast-Start Failover.<br>[W000 2019-03-06T13:13:28.284+00:00] Retry connecting to primary.<br>[W000 2019-03-06T13:13:29.284+00:00] Try to connect to the primary.<br>[W000 2019-03-06T13:13:30.285+00:00] <strong class="markup--strong markup--pre-strong">Primary database has changed to cdb1b.</strong><br>[W000 2019-03-06T13:13:30.337+00:00] Try to connect to the primary.<br>[W000 2019-03-06T13:13:30.337+00:00] Try to connect to the primary //instance-20190305-2110:1522/CDB1B_DGMGRL.<br>[W000 2019-03-06T13:13:30.380+00:00] <strong class="markup--strong markup--pre-strong">The standby cdb1a needs to be reinstated</strong><br>[W000 2019-03-06T13:13:30.380+00:00] Try to connect to the new standby cdb1a.<br>[W000 2019-03-06T13:13:30.380+00:00] Connection to the primary restored!<br>[W000 2019-03-06T13:13:32.380+00:00] Connection to the new standby restored!<br>[W000 2019-03-06T13:13:32.380+00:00] Disconnecting from database //instance-20190305-2110:1522/CDB1B_DGMGRL.<br>[W000 2019-03-06T13:13:33.384+00:00] Failed to ping the new standby.<br>[W000 2019-03-06T13:13:34.385+00:00] Try to connect to the new standby cdb1a.<br>[W000 2019-03-06T13:13:36.385+00:00] Connection to the new standby restored!<br>[W000 2019-03-06T13:13:36.388+00:00] Failed to ping the new standby.<br>[W000 2019-03-06T13:13:37.389+00:00] Try to connect to the new standby cdb1a.</pre><h4 name="b261" id="b261" class="graf graf--h4 graf-after--pre">Reinstate old primary as new standby</h4><p name="053a" id="053a" class="graf graf--p graf-after--h4">This is the other automation of FSFO: as soon as the old site comes up again, this situation is detected. It is mandatory in the fully automated failover because you don’t want the old desynchronized primary to come up and have applications connecting to it again, which is a case of split-brain. FSFO detects this and can even automatically reinstate this old primary as a new standby (this is why FSFO requires the database to be in FLASHBACK ON).</p><p name="3ece" id="3ece" class="graf graf--p graf-after--p">Let’s see it, I Startup CDB1A — the one I killed before</p><pre name="4955" id="4955" class="graf graf--pre graf-after--p">ORACLE instance started.</pre><pre name="f539" id="f539" class="graf graf--pre graf-after--pre">Total System Global Area 4.2950E+10 bytes<br>Fixed Size                 30386848 bytes<br>Variable Size            8187281408 bytes<br>Database Buffers         3.4628E+10 bytes<br>Redo Buffers              103829504 bytes<br>Database mounted.<br><strong class="markup--strong markup--pre-strong">ORA-16649: possible failover to another database prevents this database from being opened</strong></pre><p name="1524" id="1524" class="graf graf--p graf-after--pre">Impossible to open, to prevent against split brain.</p><p name="f30a" id="f30a" class="graf graf--p graf-after--p">And then I do nothing, just let the observer do its magic:</p><pre name="cba8" id="cba8" class="graf graf--pre graf-after--p">SQL&gt; [W000 2019-03-06T13:17:32.728+00:00] Try to connect to the primary //instance-20190305-2110:1522/CDB1B_DGMGRL.<br>[W000 2019-03-06T13:17:33.728+00:00] <strong class="markup--strong markup--pre-strong">Connection to the primary restored!</strong><br>[W000 2019-03-06T13:17:33.728+00:00] <strong class="markup--strong markup--pre-strong">Wait for new primary to be ready to reinstate.</strong><br>[W000 2019-03-06T13:17:33.731+00:00] <strong class="markup--strong markup--pre-strong">New primary is now ready to reinstate.</strong><br>[W000 2019-03-06T13:17:34.732+00:00] Issuing REINSTATE command.</pre><pre name="ea66" id="ea66" class="graf graf--pre graf-after--pre">2019-03-06T13:17:34.732+00:00<br>Initiating reinstatement for database &quot;cdb1a&quot;...<br>Reinstating database &quot;cdb1a&quot;, please wait...<br>[W000 2019-03-06T13:17:48.752+00:00] The standby cdb1a is ready to be a FSFO target<br><strong class="markup--strong markup--pre-strong">Reinstatement of database &quot;cdb1a&quot; succeeded<br></strong>2019-03-06T13:18:17.381+00:00<br>[W000 2019-03-06T13:18:17.789+00:00] Successfully reinstated database cdb1a.</pre><p name="a15e" id="a15e" class="graf graf--p graf-after--pre">Now the old primary is up in a standby role, fully synchronized. This is awesome. Just imagine the following situation. You have a few hours of power cut. You decided to failover. This is one command only with Data Guard Broker, but you have probably a lot of work to do with all the other systems.</p><figure name="9cbf" id="9cbf" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 475px; max-height: 438px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 92.2%;"></div><img class="graf-image" data-image-id="1*U2fimGZemCBem2PxkYB_ag.png" data-width="475" data-height="438" data-is-featured="true" src="https://cdn-images-1.medium.com/max/600/1*U2fimGZemCBem2PxkYB_ag.png"></div></figure><p name="b6e6" id="b6e6" class="graf graf--p graf-after--figure graf--trailing">And then you will postpone the reinstate of the primary databases. And maybe you will forget it after that exhausting day. And then you run unprotected… Now, Murphy’s law breaks the DR site… and you have lost everything. If you run FSFO, then the old site has been synchronized again without your intervention and is ready for a new failover. And in 19c this is possible even if you want full control with the manual decision to failover.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/60ebdaecec3e"><time class="dt-published" datetime="2019-03-06T14:45:51.057Z">March 6, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/19c-observe-only-data-guard-fsfo-no-split-brain-risk-in-manual-failover-60ebdaecec3e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>