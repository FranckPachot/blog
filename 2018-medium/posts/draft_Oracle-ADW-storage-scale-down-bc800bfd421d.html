<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Oracle ADW storage scale-down</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Oracle ADW storage scale-down</h1>
</header>
<section data-field="subtitle" class="p-summary">
With the Oracle Autonomous Data Warehouse, we can scale up/down the storage by increment of 1TB. Scale-up is easy: the tablespace is a…
</section>
<section data-field="body" class="e-content">
<section name="64d4" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="8d22" id="8d22" class="graf graf--h3 graf--leading graf--title">Oracle ADW storage scale-down</h3><p name="19fb" id="19fb" class="graf graf--p graf--empty graf-after--h3"><br></p><p name="aa73" id="aa73" class="graf graf--p graf-after--p">With the Oracle Autonomous Data Warehouse, we can scale up/down the storage by increment of 1TB. Scale-up is easy: the tablespace is a bigfile one and is auto-extensible. Scale-down is different when there is data in the tablespace, especially when the extents are at the end. Those are tasks that we are used to, as DBA: reorg with ALTER TABLE MOVE, maybe export to a new tablespace, downsize the datafile. But with ADW there are no DBA so let’s see how this is managed ‘autonomously’.</p><p name="61f6" id="61f6" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="aabd" id="aabd" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="e24b" id="e24b" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   4096G            Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="2d29" id="2d29" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="cbc4" id="cbc4" class="graf graf--pre graf-after--p">SQL&gt; select tablespace_name,dbms_xplan.format_size2(bytes) &quot;bytes&quot;,dbms_xplan.format_size2(maxbytes) &quot;maxbytes&quot;, round(sum(bytes)over(order by file_name rows between unbounded preceding and current row)/power(1024,4),2) CUMUL_TB from dba_data_files order by file_name;</pre><pre name="4f94" id="4f94" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">TABLESPACE_NAME   bytes  maxbytes      CUMUL_TB<br></strong>DATA                 2t     32t            2.24 <br>DBFS_DATA          100m     32t            2.24 <br>SYSAUX               1g     32t            2.24 <br>SYSTEM             241m     32t            2.24 <br>UNDO_8             185m    205g            2.24 <br>UNDOTBS1            51g    205g            2.29 <br>SAMPLESCHEMA       200g     32t            2.40</pre><p name="ffc5" id="ffc5" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="c9d6" id="c9d6" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="8fcf" id="8fcf" class="graf graf--pre graf-after--p">SQL&gt; select c##cloud$service.dbms_autotbs.get_segment_tablespace from dual;</pre><pre name="eade" id="eade" class="graf graf--pre graf-after--pre">GET_SEGMENT_TABLESPACE<br>----------------------<br>DATA</pre><p name="dd2e" id="dd2e" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="fdf2" id="fdf2" class="graf graf--pre graf-after--p">SQL&gt; select owner,segment_name, dbms_xplan.format_size2(sum(bytes)) &quot;bytes&quot; from (select owner,case when owner=user then segment_name else &#39;(all)&#39; end segment_name,bytes,header_file,header_block from dba_segments) group by owner,segment_name order by min(header_block),sum(bytes);</pre><pre name="593f" id="593f" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">OWNER               SEGMENT_NAME   bytes   <br></strong>SYS                 (all)          1017m   <br>SYSTEM              (all)             2m   <br>AUDSYS              (all)             6m   <br>DBSNMP              (all)           192k   <br>GSMADMIN_INTERNAL   (all)             1m   <br>C##CLOUD$SERVICE    (all)             3m   <br>XDB                 (all)           640k   <br>LBACSYS             (all)           320k   <br>C##OMLIDM           (all)            64k   <br>SH                  (all)             6m   <br>SSB                 (all)           162g   <br>ADMIN               DEMO0             1t   <br>ADMIN               DEMO1             1t</pre><p name="4b49" id="4b49" class="graf graf--p graf--empty graf-after--pre"><br></p><figure name="90d2" id="90d2" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 365px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 52.2%;"></div><img class="graf-image" data-image-id="1*XtMsxDtm7utlfA8RZANayQ.png" data-width="730" data-height="381" src="https://cdn-images-1.medium.com/max/800/1*XtMsxDtm7utlfA8RZANayQ.png"></div></figure><p name="0ab8" id="0ab8" class="graf graf--p graf--empty graf-after--figure"><br></p><figure name="1ab3" id="1ab3" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 150px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 21.4%;"></div><img class="graf-image" data-image-id="1*BUi7gTbn4yVcqpfMHIqMGw.png" data-width="997" data-height="213" src="https://cdn-images-1.medium.com/max/800/1*BUi7gTbn4yVcqpfMHIqMGw.png"></div></figure><p name="d503" id="d503" class="graf graf--p graf--empty graf-after--figure"><br></p><p name="378f" id="378f" class="graf graf--p graf--empty graf-after--p"><br></p><figure name="955b" id="955b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 367px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 52.5%;"></div><img class="graf-image" data-image-id="1*RY880o387pd0onsnnwLPUA.png" data-width="726" data-height="381" src="https://cdn-images-1.medium.com/max/800/1*RY880o387pd0onsnnwLPUA.png"></div></figure><p name="22f4" id="22f4" class="graf graf--p graf--empty graf-after--figure"><br></p><figure name="3109" id="3109" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 497px; max-height: 278px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 55.900000000000006%;"></div><img class="graf-image" data-image-id="1*1M7w0ACHsuug8dv8BsVxIg.png" data-width="497" data-height="278" src="https://cdn-images-1.medium.com/max/800/1*1M7w0ACHsuug8dv8BsVxIg.png"></div></figure><p name="2700" id="2700" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="6bb2" id="6bb2" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="9394" id="9394" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   2048G            Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="9758" id="9758" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="d485" id="d485" class="graf graf--p graf--empty graf-after--p"><br></p><p name="176f" id="176f" class="graf graf--p graf--empty graf-after--p"><br></p><p name="2b98" id="2b98" class="graf graf--p graf--empty graf-after--p"><br></p><p name="e454" id="e454" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="3e79" id="3e79" class="graf graf--pre graf-after--p">SQL&gt; purge dba_recyclebin;<br>SQL&gt; select owner,segment_name, dbms_xplan.format_size2(sum(bytes)) &quot;bytes&quot; from (select owner,case when owner=user then segment_name else &#39;(all)&#39; end segment_name,bytes,header_file,header_block from dba_segments) group by owner,segment_name order by min(header_block),sum(bytes);</pre><pre name="744f" id="744f" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">OWNER               SEGMENT_NAME   bytes   <br></strong>SYS                 (all)           663m   <br>SYSTEM              (all)             2m   <br>AUDSYS              (all)             6m   <br>DBSNMP              (all)           192k   <br>GSMADMIN_INTERNAL   (all)             1m   <br>C##CLOUD$SERVICE    (all)             3m   <br>XDB                 (all)           640k   <br>LBACSYS             (all)           320k   <br>C##OMLIDM           (all)            64k   <br>SH                  (all)             6m   <br>SSB                 (all)           162g</pre><p name="7fec" id="7fec" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="005b" id="005b" class="graf graf--p graf--empty graf-after--p"><br></p><p name="cdd1" id="cdd1" class="graf graf--p graf--empty graf-after--p"><br></p><p name="e7cf" id="e7cf" class="graf graf--p graf-after--p">For this test I’ve created a 10TB ADW service:</p><figure name="12f9" id="12f9" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 451px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 64.5%;"></div><img class="graf-image" data-image-id="1*5OrVNqDrEAJR9YkgBfh-BQ.png" data-width="1498" data-height="966" src="https://cdn-images-1.medium.com/max/800/1*5OrVNqDrEAJR9YkgBfh-BQ.png"></div></figure><p name="29d0" id="29d0" class="graf graf--p graf-after--figure">Technically, this 10TB is just a quota. Our ADW database is actually a PDB (Pluggable Database) and multitenant has a <strong class="markup--strong markup--p-strong">MAX_PDB_STORAGE</strong> quota for it. This is how those 10TB are set:</p><pre name="082b" id="082b" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="3f95" id="3f95" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   10T              Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="cec6" id="cec6" class="graf graf--p graf-after--pre">I’ve also created a few tables (12 tables, 651GB each). The ADW console shows this limit and the storage usage within this limit:</p><figure name="60af" id="60af" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 298px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 42.5%;"></div><img class="graf-image" data-image-id="1*Mn4drlU5qGtW6RwvCGGEsw.png" data-width="778" data-height="331" src="https://cdn-images-1.medium.com/max/800/1*Mn4drlU5qGtW6RwvCGGEsw.png"></div></figure><p name="a2fa" id="a2fa" class="graf graf--p graf-after--figure">What is actually accounted in those 7.66 TB? That’s the size of my segments, but I’m concerned about the tablespaces:</p><pre name="626a" id="626a" class="graf graf--pre graf-after--p">SQL&gt; select tablespace_name,dbms_xplan.format_size2(bytes) &quot;bytes&quot;,dbms_xplan.format_size2(maxbytes) &quot;maxbytes&quot;,sum(bytes)over(order by file_name rows between unbounded preceding and current row)/power(1024,4) CUMUL_TB from dba_data_files order by file_name;</pre><pre name="7d28" id="7d28" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">TABLESPACE_NAME   bytes  maxbytes      CUMUL_TB<br></strong>DATA                 8t     32t        7.662265777587890625 <br>DBFS_DATA          100m     32t        7.66236114501953125 <br>SYSAUX               1g     32t        7.663539886474609375 <br>SYSTEM             191m     32t        7.66372203826904296875 <br>UNDO_10            180m    512g        7.66389369964599609375 <br>UNDO_8             180m    512g        7.66406536102294921875 <br>UNDO_9             180m    512g        7.66423702239990234375 <br>UNDOTBS1           180m    512g        7.66440868377685546875 <br>SAMPLESCHEMA       200g     32t        7.85972118377685546875</pre><p name="81a2" id="81a2" class="graf graf--p graf-after--pre">Those 7.66TB os used space is the total size of my tablespaces. SAMPLESCHEMA is not mine: it is a read-only one shared by all PDBs. </p><p name="1ebb" id="1ebb" class="graf graf--p graf-after--p">DBFS_DATA is a DataBase File System where I can store files, like Data Pump exports. It is amazing to see how this Autonomous Database leverages all those features introduced by Oracle in 40 years. DBFS is not widely used but, combined with Multitenant, provides one brick on this Cloud. That will probably deserve another blog post.</p><p name="4e71" id="4e71" class="graf graf--p graf-after--p">My tables and indexes are stored in DATA and ADW uses the following function to parameter this:</p><pre name="0960" id="0960" class="graf graf--pre graf-after--p">SQL&gt; select c##cloud$service.dbms_autotbs.get_segment_tablespace from dual;</pre><pre name="053d" id="053d" class="graf graf--pre graf-after--pre">GET_SEGMENT_TABLESPACE<br>----------------------<br>DATA</pre><p name="86bf" id="86bf" class="graf graf--p graf-after--pre">I have created my 651GB tables one after one with increasing number. Here are the segments:</p><pre name="9ad1" id="9ad1" class="graf graf--pre graf-after--p">SQL&gt; select owner,segment_name, dbms_xplan.format_size2(sum(bytes)) &quot;bytes&quot; from (select owner,case when owner=user then segment_name else &#39;(all)&#39; end segment_name,bytes,header_file,header_block from dba_segments) group by owner,segment_name order by min(header_block),sum(bytes);</pre><pre name="0d36" id="0d36" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">OWNER               SEGMENT_NAME   bytes   <br></strong>SYS                 (all)             1g   <br>SYSTEM              (all)             1m   <br>AUDSYS              (all)             3m   <br>DBSNMP              (all)           192k   <br>GSMADMIN_INTERNAL   (all)             1m   <br>C##CLOUD$SERVICE    (all)             2m   <br>LBACSYS             (all)           320k   <br>SH                  (all)             6m   <br>SSB                 (all)           162g   <br>ADMIN               DEMO1           651g   <br>ADMIN               DEMO2           651g   <br>ADMIN               DEMO3           651g   <br>ADMIN               DEMO4           651g   <br>ADMIN               DEMO5           651g   <br>ADMIN               DEMO6           651g   <br>ADMIN               DEMO7           651g   <br>ADMIN               DEMO8           651g   <br>ADMIN               DEMO9           651g   <br>ADMIN               DEMO10          651g   <br>ADMIN               DEMO11          651g   <br>ADMIN               DEMO12          651g</pre><p name="5dbc" id="5dbc" class="graf graf--p graf-after--pre">And the extents:</p><pre name="c89c" id="c89c" class="graf graf--pre graf-after--p">SQL&gt; select segment_name,TB,sum(TB)over(order by block_id rows between unbounded preceding and current row) CUMUL_TB from (select segment_name,round(sum(bytes)/power(1024,4),2) TB, max(block_id) block_id from dba_extents where owner=&#39;ADMIN&#39; and tablespace_name=&#39;DATA&#39; group by segment_name);</pre><pre name="e3ac" id="e3ac" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">SEGMENT_NAME       TB   CUMUL_TB   <br></strong>DEMO1            0.64       0.64 <br>DEMO2            0.64       1.28 <br>DEMO3            0.64       1.92 <br>DEMO4            0.64       2.56 <br>DEMO5            0.64       3.20 <br>DEMO6            0.64       3.84 <br>DEMO7            0.64       4.48 <br>DEMO8            0.64       5.12 <br>DEMO9            0.64       5.76 <br>DEMO10           0.64       6.40 <br>DEMO11           0.64       7.04 <br>DEMO12           0.64       7.68</pre><p name="ed99" id="ed99" class="graf graf--p graf-after--pre">My goal is to see how we can scale down the storage when the free space is not at the end of the datafile. I’ll drop and purge the tables DEMO1 to DEMO4. This will free 2.56TB at the beginning of the file. And drop without purge DEMO5 to DEMO8 so that another 2.56TB goes to recyclebin.</p><p name="57be" id="57be" class="graf graf--p graf-after--p">When doing that, the storage is still the same (7.66 TB / 10 TB) and I check that the remaining extents, 2.56TB, for table DEMO9 to DEMO10, starts after 4TB of free space. </p><pre name="7028" id="7028" class="graf graf--pre graf-after--p">SQL&gt; select segment_name,TB,sum(TB)over(order by block_id rows between unbounded preceding and current row) CUMUL_TB,dbms_xplan.format_size(min_block_id*8192)||&#39;-&#39;||dbms_xplan.format_size(block_id*8192) &quot;offsets&quot; from (select segment_name,round(sum(bytes)/power(1024,4),2) TB, min(block_id) min_block_id,max(block_id) block_id from dba_extents where owner=&#39;ADMIN&#39; and tablespace_name=&#39;DATA&#39; group by segment_name);<br>SEGMENT_NAME   TB     CUMUL_TB   offsets       <br>DEMO9            0.64       0.64 4571G-5888G   <br>DEMO10           0.64       1.28 5229G-6532G   <br>DEMO11           0.64       1.92 5877G-7183G   <br>DEMO12           0.64       2.56 6535G-7835G</pre><h3 name="11de" id="11de" class="graf graf--h3 graf-after--pre">Scale down to 8TB</h3><p name="5b3d" id="5b3d" class="graf graf--p graf--empty graf-after--h3"><br></p><figure name="22e6" id="22e6" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 282px; max-height: 308px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 109.2%;"></div><img class="graf-image" data-image-id="1*64X0AhQd3boWxx5fOjwzlA.png" data-width="282" data-height="308" src="https://cdn-images-1.medium.com/max/600/1*64X0AhQd3boWxx5fOjwzlA.png"></div></figure><p name="c7ee" id="c7ee" class="graf graf--p graf--empty graf-after--figure"><br></p><p name="8c36" id="8c36" class="graf graf--p graf--empty graf-after--p"><br></p><p name="ae72" id="ae72" class="graf graf--p graf--empty graf-after--p"><br></p><p name="e705" id="e705" class="graf graf--p graf-after--p">Scale down to 6TB -&gt; needs reorg</p><p name="d725" id="d725" class="graf graf--p graf--empty graf-after--p"><br></p><p name="b34f" id="b34f" class="graf graf--p graf--empty graf-after--p"><br></p><p name="97bb" id="97bb" class="graf graf--p graf-after--p">SQL Id: ghqcj9186va66 <br>SQL Execution Id: 67110935 <br>SQL Execution Start: 04-Feb-2019 13:34:47</p><p name="b1e6" id="b1e6" class="graf graf--p graf-after--p">SQL Id: c4rh04n4313jm <br>SQL Execution Id: 67108864 <br>SQL Execution Start: 04-Feb-2019 13:34:47</p><p name="1d3a" id="1d3a" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="05d1" id="05d1" class="graf graf--pre graf-after--p">BEGIN pod_cdb_admin_router.handle_request(REQ_ID=&gt;:0,REQ_METHOD=&gt;:1,REQ_URI=&gt;:2,REQ_PARAMS=&gt;:3,REQ_VERSION=&gt;:4,REQ_PAYLOAD=&gt;:5,REQ_PAYLOAD_FMT=&gt;:6,ENABLE_LOG=&gt;:7,STATUS=&gt;:8) ; END;<br>begin pod_cdb_admin.resize_tenant(status=&gt;:status,tenant_name=&gt;&#39;VAVXRLXX2LLQL7M&#39;,pdb_name=&gt;&#39;VAVXRLXX2LLQL7M_DB201902011608&#39;,cpu_count=&gt;128,max_size=&gt;&#39;8192G&#39;,attempt_shrink=&gt;FALSE); end;</pre><p name="f775" id="f775" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="cdbc" id="cdbc" class="graf graf--p graf-after--p">12805. 00000 — “parallel query server died unexpectedly”<br>*Cause: A parallel query server died unexpectedly, PMON cleaning</p><figure name="4043" id="4043" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 177px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 25.3%;"></div><img class="graf-image" data-image-id="1*wiolnOa5is9UOzvKQ1a6sA.png" data-width="1322" data-height="334" src="https://cdn-images-1.medium.com/max/800/1*wiolnOa5is9UOzvKQ1a6sA.png"></div></figure><p name="4fc2" id="4fc2" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="53ef" id="53ef" class="graf graf--pre graf-after--p">SQL Monitoring Report</pre><pre name="fbe3" id="fbe3" class="graf graf--pre graf-after--pre">SQL Text<br>------------------------------<br>BEGIN pod_cdb_admin_router.handle_request(REQ_ID=&gt;:0,REQ_METHOD=&gt;:1,REQ_URI=&gt;:2,REQ_PARAMS=&gt;:3,REQ_VERSION=&gt;:4,REQ_PAYLOAD=&gt;:5,REQ_PAYLOAD_FMT=&gt;:6,ENABLE_LOG=&gt;:7,STATUS=&gt;:8) ; END;</pre><pre name="d367" id="d367" class="graf graf--pre graf-after--pre">Global Information<br>------------------------------<br> Status                                 :  DONE                                                     <br> Instance ID                            :  2                                                        <br> Session                                :  C##CLOUD$SERVICE (14931:62651)                           <br> SQL ID                                 :  ghqcj9186va66                                            <br> SQL Execution ID                       :  33555873                                                 <br> Execution Started                      :  02/02/2019 10:24:50                                      <br> First Refresh Time                     :  02/02/2019 10:24:56                                      <br> Last Refresh Time                      :  02/02/2019 10:25:05                                      <br> Duration                               :  15s                                                      <br> Module/Action                          :  GET_STMT_REPORT_XML/a3801c14-d42b-46a5-95f7-987ab0825f9d <br> Service                                :  vavxrlxx2llql7m_db201902011608                           <br> Program                                :  JDBC Thin Client                                         <br> PLSQL Entry Ids (Object/Subprogram)    :  22364,1                                                  <br> PLSQL Current Ids (Object/Subprogram)  :  13637,150</pre><pre name="e281" id="e281" class="graf graf--pre graf-after--pre">Global Stats<br>==================================================================<br>| Elapsed |   Cpu   | PL/SQL  |  Other   | Buffer | Read | Write |<br>| Time(s) | Time(s) | Time(s) | Waits(s) |  Gets  | Reqs | Reqs  |<br>==================================================================<br>|      16 |      15 |    0.02 |     0.63 |     4G |   4G |    4G |<br>==================================================================</pre><pre name="8132" id="8132" class="graf graf--pre graf-after--pre">SQL Monitoring Report</pre><pre name="ed91" id="ed91" class="graf graf--pre graf-after--pre">SQL Text<br>------------------------------<br>begin pod_cdb_admin.resize_tenant(status=&gt;:status,tenant_name=&gt;&#39;VAVXRLXX2LLQL7M&#39;,pdb_name=&gt;&#39;VAVXRLXX2LLQL7M_DB201902011608&#39;,cpu_count=&gt;16,max_size=&gt;&#39;10240G&#39;,attempt_shrink=&gt;FALSE); end;</pre><pre name="5f44" id="5f44" class="graf graf--pre graf-after--pre">Global Information<br>------------------------------<br> Status              :  DONE   <br> Instance ID         :  2                         <br> Session             :  C##CLOUD$SERVICE (3619:5710) <br> SQL ID              :  0jwrp1j1jd9vu            <br> SQL Execution ID    :  33554432                              <br> Execution Started   :  02/01/2019 22:29:13   <br> First Refresh Time  :  02/01/2019 22:29:19            <br> Last Refresh Time   :  02/01/2019 22:29:32 <br> Duration            :  19s <br> Module/Action       :  RESIZE_TENANT_DATABASE/6317f97d-223a-48de-92cd-9b70f32b2ef5 <br> Service             :  SYS$USERS<br> Program             :  JDBC Thin Client</pre><pre name="6ca1" id="6ca1" class="graf graf--pre graf-after--pre">Global Stats<br>==========================================================<br>=========================================================<br>| Elapsed |   Cpu   |    IO    | Concurrency | Cluster  |<br>| Time(s) | Time(s) | Waits(s) |  Waits(s)   | Waits(s) |<br>=========================================================<br>|      15 |    2.84 |    -0.19 |       -0.03 |    -0.02 |<br>=========================================================<br>=======================================================<br>|     PL/SQL     |  Other   | Buffer | Read |  Read   |<br>|    Time(s)     | Waits(s) |  Gets  | Reqs |  Bytes  |<br>=======================================================<br>| 18446744073709 |       13 |     9G |   9G | 16384PB |<br>=======================================================<br>=====================================================<br>|  Read   | Write |  Write  |        Offload        |<br>|  Bytes  | Reqs  |  Bytes  |    Returned Bytes     |<br>=====================================================<br>| 16384PB |    4G | 16384PB | -18446744073709813760 |<br>=====================================================</pre><pre name="1b4f" id="1b4f" class="graf graf--pre graf--empty graf-after--pre"><br></pre><p name="0fa0" id="0fa0" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="6297" id="6297" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="4a78" id="4a78" class="graf graf--pre graf-after--p">SQL&gt; select segment_name,TB,sum(TB)over(order by block_id rows between unbounded preceding and current row) CUMUL_TB,dbms_xplan.format_size(min_block_id*8192)||&#39;-&#39;||dbms_xplan.format_size(block_id*8192) &quot;offsets&quot; from (select segment_name,round(sum(bytes)/power(1024,4),2) TB, min(block_id) min_block_id,max(block_id) block_id from dba_extents where owner=&#39;ADMIN&#39; and tablespace_name=&#39;DATA&#39; group by segment_name);<br>SEGMENT_NAME   TB     CUMUL_TB   offsets       <br>DEMO9            0.64       0.64 4571G-5888G   <br>DEMO10           0.64       1.28 5229G-6532G   <br>DEMO11           0.64       1.92 5877G-7183G   <br>DEMO12           0.64       2.56 6535G-7835G</pre><p name="180b" id="180b" class="graf graf--p graf--empty graf-after--pre"><br></p><figure name="e2d1" id="e2d1" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 507px; max-height: 252px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 49.7%;"></div><img class="graf-image" data-image-id="1*Eq95qZRtkj3Dy0IWMJql2Q.png" data-width="507" data-height="252" src="https://cdn-images-1.medium.com/max/800/1*Eq95qZRtkj3Dy0IWMJql2Q.png"></div></figure><p name="79bc" id="79bc" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="5a58" id="5a58" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="0636" id="0636" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   8192G            Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="d387" id="d387" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="9fd2" id="9fd2" class="graf graf--pre graf-after--p">SQL&gt; select owner,original_name,dbms_xplan.format_size2(block_size*space) &quot;size&quot; from dba_recyclebin natural join(select tablespace_name ts_name,block_size from dba_tablespaces);<br>OWNER   ORIGINAL_NAME   size    <br>ADMIN   DEMO7            651g   <br>ADMIN   DEMO5            651g   <br>ADMIN   DEMO6            651g   <br>ADMIN   DEMO8            651g</pre><p name="e9e3" id="e9e3" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="6505" id="6505" class="graf graf--p graf--empty graf-after--p"><br></p><h3 name="a9fc" id="a9fc" class="graf graf--h3 graf-after--p">Scale down to 6TB</h3><p name="9576" id="9576" class="graf graf--p graf--empty graf-after--h3"><br></p><figure name="c762" id="c762" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 503px; max-height: 257px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 51.1%;"></div><img class="graf-image" data-image-id="1*TpEXrNUlwDXm2umCsdbOjA.png" data-width="503" data-height="257" src="https://cdn-images-1.medium.com/max/800/1*TpEXrNUlwDXm2umCsdbOjA.png"></div></figure><p name="42c2" id="42c2" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="fbdf" id="fbdf" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="397c" id="397c" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   8192G            Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="c213" id="c213" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="4d54" id="4d54" class="graf graf--pre graf-after--p">TABLESPACE_NAME   bytes   maxbytes   CUMUL_TB                 <br>DATA                 8t     32t          7.662265777587890625 <br>DBFS_DATA          100m     32t           7.66236114501953125 <br>SYSAUX               1g     32t          7.663539886474609375 <br>SYSTEM             191m     32t        7.66372203826904296875 <br>UNDO_10            180m    307g        7.66389369964599609375 <br>UNDO_8             180m    307g        7.66406536102294921875 <br>UNDO_9             180m    307g        7.66423702239990234375 <br>UNDOTBS1           180m    307g        7.66440868377685546875 <br>SAMPLESCHEMA       200g     32t        7.85972118377685546875</pre><p name="2e32" id="2e32" class="graf graf--p graf-after--pre">Scale down to 4 TB</p><figure name="ce43" id="ce43" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 515px; max-height: 250px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.5%;"></div><img class="graf-image" data-image-id="1*CuqKURCmJUoGFJK7UGkIHA.png" data-width="515" data-height="250" src="https://cdn-images-1.medium.com/max/800/1*CuqKURCmJUoGFJK7UGkIHA.png"></div></figure><p name="5ef4" id="5ef4" class="graf graf--p graf-after--figure">Scale down to 1TB</p><figure name="c8b0" id="c8b0" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 383px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 54.7%;"></div><img class="graf-image" data-image-id="1*MQDNi4Lk88jhxQWDUsidVQ.png" data-width="857" data-height="469" src="https://cdn-images-1.medium.com/max/800/1*MQDNi4Lk88jhxQWDUsidVQ.png"></div></figure><p name="e97f" id="e97f" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="ce01" id="ce01" class="graf graf--pre graf-after--p">SQL&gt; alter table DEMO12 move online including all lobs update indexes;</pre><pre name="ea72" id="ea72" class="graf graf--pre graf-after--pre">Error starting at line : 7 in command -<br>alter table DEMO12 move online including all lobs update indexes<br>Error report -<br>ORA-12801: error signaled in parallel query server P001, instance e6pod-ebeyb7.subdb2.vcnadwcfra1.oraclevcn.com:eyb1pod3 (3)<br><strong class="markup--strong markup--pre-strong">ORA-65114: space usage in container is too high</strong><br>12801. 00000 -  &quot;error signaled in parallel query server %s&quot;<br>*Cause:    A parallel query server reached an exception condition.<br>*Action:   Check the following error message for the cause, and consult<br>           your error manual for the appropriate action.<br>*Comment:  This error can be turned off with event 10397, in which<br>           case the server&#39;s actual error is signaled instead.</pre><p name="cc30" id="cc30" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="b332" id="b332" class="graf graf--p graf-after--p">Another case</p><p name="5588" id="5588" class="graf graf--p graf--empty graf-after--p"><br></p><figure name="2670" id="2670" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 417px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59.599999999999994%;"></div><img class="graf-image" data-image-id="1*kKxmpnfodZ-_cdUBit_97w.png" data-width="1345" data-height="801" src="https://cdn-images-1.medium.com/max/800/1*kKxmpnfodZ-_cdUBit_97w.png"></div></figure><p name="849d" id="849d" class="graf graf--p graf--empty graf-after--figure"><br></p><pre name="9ce9" id="9ce9" class="graf graf--pre graf-after--p">SQL&gt; select property_name,dbms_xplan.format_size(property_value) property_value, description from database_properties where property_name=&#39;MAX_PDB_STORAGE&#39;;</pre><pre name="212e" id="212e" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PROPERTY_NAME     PROPERTY_VALUE   DESCRIPTION<br></strong>MAX_PDB_STORAGE   20T              Maximum Space Usage of Datafiles<br>                                   and Local Tempfiles in Container</pre><p name="013a" id="013a" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="bd57" id="bd57" class="graf graf--pre graf-after--p">SQL&gt; select tablespace_name,dbms_xplan.format_size2(bytes) &quot;bytes&quot;,dbms_xplan.format_size2(maxbytes) &quot;maxbytes&quot;,round(sum(bytes)over(order by file_name rows between unbounded preceding and current row)/power(1024,4),2) CUMUL_TB from dba_data_files order by file_name;</pre><pre name="9c16" id="9c16" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">TABLESPACE_NAME   bytes   maxbytes     CUMUL_TB </strong>  <br>DATA                 1t     32t            1.29 <br>DATA_NEW             1t     32t            2.58 <br>DBFS_DATA            1t     32t            3.95 <br>DBFS_DATA_NEW        1t     32t            5.32 <br>SYSAUX               3g     32t            5.32 <br>SYSTEM             481m     32t            5.32 <br>UNDO_8             190m    512g            5.32 <br>UNDOTBS1           181g    512g            5.50 <br>SAMPLESCHEMA       200g     32t            5.69</pre><p name="7491" id="7491" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="79b6" id="79b6" class="graf graf--p graf--empty graf-after--p"><br></p><p name="3717" id="3717" class="graf graf--p graf--empty graf-after--p"><br></p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="99aa" id="99aa" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 510px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 49.4%;"></div><img class="graf-image" data-image-id="1*ynlTJdWxthFVuWr7e1LdXg.png" data-width="2373" data-height="1172" src="https://cdn-images-1.medium.com/max/1200/1*ynlTJdWxthFVuWr7e1LdXg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><pre name="fceb" id="fceb" class="graf graf--pre graf-after--figure">select dbms_metadata.get_ddl(&#39;TABLESPACE&#39;, &#39;DBFS_DATA&#39;) from dual<br>select dbms_metadata.get_ddl(&#39;TABLESPACE&#39;, &#39;DATA&#39;) from dual</pre><p name="66ff" id="66ff" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="5313" id="5313" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="abbe" id="abbe" class="graf graf--pre graf-after--p">begin pod_cdb_admin.resize_tenant(status=&gt;:status,tenant_name=&gt;&#39;ZLJNJRLBOWCD4DC&#39;,pdb_name=&gt;&#39;ZLJNJRLBOWCD4DC_PSENDB&#39;,cpu_count=&gt;6,max_size=&gt;&#39;3072G&#39;,attempt_shrink=&gt;FALSE); end;<br>BEGIN pod_cdb_admin_router.handle_request(REQ_ID=&gt;:0,REQ_METHOD=&gt;:1,REQ_URI=&gt;:2,REQ_PARAMS=&gt;:3,REQ_VERSION=&gt;:4,REQ_PAYLOAD=&gt;:5,REQ_PAYLOAD_FMT=&gt;:6,ENABLE_LOG=&gt;:7,STATUS=&gt;:8) ; END;</pre><p name="3cca" id="3cca" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="79b2" id="79b2" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="b21c" id="b21c" class="graf graf--pre graf-after--p">SELECT /*+all_rows*/ SYS_XMLGEN(VALUE(KU$), XMLFORMAT.createFormat2(&#39;TABLESPACE_T&#39;, &#39;7&#39;)), KU$.TS_NUM FROM SYS.KU$_TABLESPACE_VIEW KU$ WHERE KU$.NAME=:NAME1</pre><p name="51c7" id="51c7" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="c70f" id="c70f" class="graf graf--pre graf-after--p">alter table &quot;...&quot;.&quot;...&quot; move including all lobs tablespace &quot;...&quot; update indexes (&quot;...&quot;.&quot;...&quot; tablespace &quot;...&quot;, &quot;...&quot;.&quot;...&quot; tablespace &quot;...&quot;)</pre><p name="c399" id="c399" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="8fe2" id="8fe2" class="graf graf--p graf--empty graf-after--p"><br></p><p name="dde9" id="dde9" class="graf graf--p graf--empty graf-after--p"><br></p><p name="7a34" id="7a34" class="graf graf--p graf--empty graf-after--p"><br></p><p name="044e" id="044e" class="graf graf--p graf--empty graf-after--p"><br></p><p name="6128" id="6128" class="graf graf--p graf--empty graf-after--p graf--trailing"><br></p></div></div></section>
</section>
<footer><p><a href="https://medium.com/p/bc800bfd421d">View original.</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>