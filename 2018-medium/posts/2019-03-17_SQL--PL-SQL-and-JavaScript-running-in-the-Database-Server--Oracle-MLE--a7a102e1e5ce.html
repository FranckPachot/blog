<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>SQL, PL/SQL and JavaScript running in the Database Server (Oracle MLE)</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">SQL, PL/SQL and JavaScript running in the Database Server (Oracle MLE)</h1>
</header>
<section data-field="subtitle" class="p-summary">
In a previous post I measured the CPU usage when running a database transaction in the same engine (SQL), or two engines in the same…
</section>
<section data-field="body" class="e-content">
<section name="a1a1" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6cfb" id="6cfb" class="graf graf--h3 graf--leading graf--title">SQL, PL/SQL and JavaScript running in the Database Server (Oracle MLE)</h3><p name="e0ed" id="e0ed" class="graf graf--p graf-after--h3">In a <a href="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle" data-href="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">previous post</a> I measured the CPU usage when running a database transaction in the same engine (SQL), or two engines in the same process (PL/SQL + SQL or JavaScript + SQL) or two processes (Javascript client + server SQL):</p><div name="7c63" id="7c63" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle" data-href="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle"><strong class="markup--strong markup--mixtapeEmbed-strong">ODC Appreciation Day : Reduce CPU usage by running the business logic in the Oracle Database</strong><br><em class="markup--em markup--mixtapeEmbed-em">Here is my #ThanksODC post. A long one... There&#39;s a point that should always be a major topic for database developer…</em>db-blog.web.cern.ch</a><a href="https://db-blog.web.cern.ch/blog/franck-pachot/2018-10-odc-appreciation-day-reduce-cpu-usage-running-business-logic-oracle" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="440ef5989e1de4df8690cbde62db670f" data-thumbnail-img-id="0*XhismqZc_uD_InA2" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*XhismqZc_uD_InA2);"></a></div><p name="3ee3" id="3ee3" class="graf graf--p graf-after--mixtapeEmbed">For the JavaScript + SQL running in the same process, I used the Oracle Multi-Lingual Engine in beta 0.2.7 but there is now a new beta 0.3.0 and this post runs the same (or similar) with this.</p><p name="07f6" id="07f6" class="graf graf--p graf-after--p">I’ve installed this MLE in a <a href="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4" data-href="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4" class="markup--anchor markup--p-anchor" target="_blank">previous post</a>:</p><div name="4ca6" id="4ca6" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4" data-href="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4"><strong class="markup--strong markup--mixtapeEmbed-strong">Oracle Multi-Lingual Engine</strong><br><em class="markup--em markup--mixtapeEmbed-em">Here is a very quick and easy test of the Oracle MLE, the engine that let you run JavaScript or Python stored…</em>medium.com</a><a href="https://medium.com/@FranckPachot/oracle-multi-lingual-engine-7ce6414aa6c4" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="5f232644ec1d0f5bc6300fd02b906bc6" data-thumbnail-img-id="1*_pI-oHuHkZh6U4C-ytCM0Q.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*_pI-oHuHkZh6U4C-ytCM0Q.png);"></a></div><p name="2d2b" id="2d2b" class="graf graf--p graf-after--mixtapeEmbed">And here is the demo where I run 400000 amount transfers between accounts. Here are the tables:</p><pre name="7211" id="7211" class="graf graf--pre graf-after--p">SQLcl: Release 18.4 Production on Sun Mar 17 15:42:34 2019<br>Copyright (c) 1982, 2019, Oracle.  All rights reserved.<br>Last Successful login time: Sun Mar 17 2019 15:42:36 +00:00<br>Connected to:<br>Oracle Database 12c Enterprise Edition Release 12.2.0.1.0_MLE - 64bit Beta</pre><pre name="64c1" id="64c1" class="graf graf--pre graf-after--pre">15:42:39 SQL&gt; create table CUSTOMERS (<br>      CUSTOMER_ID number generated always as identity <br>                  constraint CUSTOMER_PK primary key,<br>      CUSTOMER_NAME varchar2(42)<br>     );</pre><pre name="c3d4" id="c3d4" class="graf graf--pre graf-after--pre">Table created.</pre><pre name="a16a" id="a16a" class="graf graf--pre graf-after--pre">15:42:42 SQL&gt; create table ACCOUNTS (<br>      ACCOUNT_ID  varchar2(10) constraint ACCOUNT_PK primary key,<br>      CUSTOMER_ID number,<br>      AMOUNT      number default 0<br>     );</pre><pre name="6ef7" id="6ef7" class="graf graf--pre graf-after--pre">Table created.</pre><pre name="0f7d" id="0f7d" class="graf graf--pre graf-after--pre">15:42:46 SQL&gt; insert /*+ append */ into CUSTOMERS (CUSTOMER_NAME)<br>      select x from (<br>       select to_char( date&#39;-4712-01-01&#39;+rownum-1,&#39;Jsp&#39;) x <br>       from xmltable(&#39;1 to 1000000&#39;)<br>      ) where length(x)=42 and rownum&lt;=4000;</pre><pre name="ae6b" id="ae6b" class="graf graf--pre graf-after--pre">4000 rows created.</pre><pre name="c188" id="c188" class="graf graf--pre graf-after--pre">15:42:49 SQL&gt; commit;</pre><pre name="7a8c" id="7a8c" class="graf graf--pre graf-after--pre">Commit complete.</pre><pre name="e859" id="e859" class="graf graf--pre graf-after--pre">15:42:51 SQL&gt; select * from CUSTOMERS <br>              order by CUSTOMER_ID fetch first 10 rows only;</pre><pre name="70a2" id="70a2" class="graf graf--pre graf-after--pre">  CUSTOMER_ID CUSTOMER_NAME<br>  ----------- ------------------------------------------<br>            1 Three Thousand Three Hundred Seventy-Three<br>            2 Three Thousand Three Hundred Seventy-Seven<br>            3 Three Thousand Three Hundred Seventy-Eight<br>            4 Three Thousand Seven Hundred Seventy-Three<br>            5 Three Thousand Seven Hundred Seventy-Seven<br>            6 Three Thousand Seven Hundred Seventy-Eight<br>            7 Three Thousand Eight Hundred Seventy-Three<br>            8 Three Thousand Eight Hundred Seventy-Seven<br>            9 Three Thousand Eight Hundred Seventy-Eight<br>           10 Seven Thousand Three Hundred Seventy-Three</pre><pre name="5379" id="5379" class="graf graf--pre graf-after--pre">10 rows selected.</pre><pre name="6198" id="6198" class="graf graf--pre graf-after--pre">15:42:54 SQL&gt; insert /*+ append */ into ACCOUNTS                   <br>              (ACCOUNT_ID,CUSTOMER_ID,AMOUNT)<br>      select &#39;X&#39;||to_char(rownum,&#39;FM0999999&#39;),CUSTOMER_ID,10000 <br>      from CUSTOMERS cross join xmltable(&#39;1 to 100&#39;)<br>     ;</pre><pre name="a253" id="a253" class="graf graf--pre graf-after--pre">400000 rows created.</pre><pre name="c1df" id="c1df" class="graf graf--pre graf-after--pre">15:42:57 SQL&gt; commit;</pre><pre name="f248" id="f248" class="graf graf--pre graf-after--pre">Commit complete.</pre><pre name="41b7" id="41b7" class="graf graf--pre graf-after--pre">15:42:58 SQL&gt; commit;</pre><pre name="398b" id="398b" class="graf graf--pre graf-after--pre">Commit complete.</pre><pre name="51a5" id="51a5" class="graf graf--pre graf-after--pre">15:43:15 SQL&gt; select * from ACCOUNTS <br>              order by ACCOUNT_ID fetch first 10 rows only;</pre><pre name="dad7" id="dad7" class="graf graf--pre graf-after--pre">ACCOUNT_ID     CUSTOMER_ID   AMOUNT<br>----------     -----------   ------<br>X0000001              1150    10000<br>X0000002              1151    10000<br>X0000003              1152    10000<br>X0000004              1153    10000<br>X0000005              1154    10000<br>X0000006              1155    10000<br>X0000007              1156    10000<br>X0000008              1157    10000<br>X0000009              1158    10000<br>X0000010              1159    10000</pre><pre name="6ac1" id="6ac1" class="graf graf--pre graf-after--pre">10 rows selected.</pre><pre name="cecf" id="cecf" class="graf graf--pre graf-after--pre">15:43:16 SQL&gt; select /*+ full(ACCOUNTS) cache(ACCOUNTS) */ <br>              count(*),avg(amount) from ACCOUNTS;</pre><pre name="655e" id="655e" class="graf graf--pre graf-after--pre">  COUNT(*)   AVG(AMOUNT)<br>  --------   -----------<br>    400000         10000</pre><p name="b06d" id="b06d" class="graf graf--p graf-after--pre">I have a ‘show-cpu-seconds-from-ps.sh’ script that displays the cputime delta from ps output.</p><p name="b8db" id="b8db" class="graf graf--p graf-after--p">Here I run all in one SQL statement: <strong class="markup--strong markup--p-strong">5 seconds of CPU</strong></p><pre name="6dc2" id="6dc2" class="graf graf--pre graf-after--p">15:44:23 SQL&gt; set timing on<br>15:44:28 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh init to reset cputime counter</pre><pre name="59b2" id="59b2" class="graf graf--pre graf-after--pre">15:44:30 SQL&gt; update ACCOUNTS set AMOUNT=<br>  2          case<br>  3           when ACCOUNT_ID=&#39;X0000001&#39; then AMOUNT+(select 1*count(*) from ACCOUNTS where ACCOUNT_ID&lt;&gt;&#39;X0000001&#39;)<br>  4           else AMOUNT-1<br>  5          end<br>  6  /</pre><pre name="cd55" id="cd55" class="graf graf--pre graf-after--pre">400000 rows updated.</pre><pre name="83cf" id="83cf" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">Elapsed: 00:00:04.451</strong><br>15:44:43 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh diff to show the delta cputime<br>         <strong class="markup--strong markup--pre-strong">5 cpu seconds</strong> in pid=     19971 <strong class="markup--strong markup--pre-strong">oracleCDB1</strong> (LOCAL=NO)</pre><pre name="910d" id="910d" class="graf graf--pre graf-after--pre">15:44:43 SQL&gt; select * from ACCOUNTS order by ACCOUNT_ID fetch first 10 rows only;<br>ACCOUNT_ID     CUSTOMER_ID   AMOUNT<br>X0000001              1150   409999<br>X0000002              1151     9999<br>X0000003              1152     9999<br>X0000004              1153     9999<br>X0000005              1154     9999<br>X0000006              1155     9999<br>X0000007              1156     9999<br>X0000008              1157     9999<br>X0000009              1158     9999<br>X0000010              1159     9999</pre><pre name="1d9f" id="1d9f" class="graf graf--pre graf-after--pre">10 rows selected.</pre><pre name="b32a" id="b32a" class="graf graf--pre graf-after--pre">Elapsed: 00:00:00.019<br>15:44:43 SQL&gt; rollback;</pre><pre name="cae0" id="cae0" class="graf graf--pre graf-after--pre">Rollback complete.</pre><pre name="789a" id="789a" class="graf graf--pre graf-after--pre">Elapsed: 00:00:04.158</pre><p name="ff1b" id="ff1b" class="graf graf--p graf-after--pre">This is the actual CPU cycles needed to update those 400000 account amounts: 5 seconds. And the rollback is the same.</p><p name="3dce" id="3dce" class="graf graf--p graf-after--p">Now with a PL/SQL procedure: <strong class="markup--strong markup--p-strong">30 seconds of CPU</strong> (because of the context switches between the PL/SQL and SQL engines)</p><pre name="105e" id="105e" class="graf graf--pre graf-after--p">15:44:47 SQL&gt; create or replace procedure transfer(acc1 varchar2, acc2 varchar2, amount number) as<br>  2  begin<br>  3   -- debit acc1<br>  4   update ACCOUNTS set ACCOUNTS.AMOUNT = ACCOUNTS.AMOUNT - transfer.amount where ACCOUNT_ID=acc1;<br>  5   if sql%rowcount &lt;&gt; 1 then raise_application_error(-20000,&#39;Account &#39;&#39;&#39;||acc1||&#39;&#39;&#39; unknown&#39;); end if;<br>  6   -- credit acc2<br>  7   update ACCOUNTS set ACCOUNTS.AMOUNT = ACCOUNTS.AMOUNT + transfer.amount where ACCOUNT_ID=acc2;<br>  8   if sql%rowcount &lt;&gt; 1 then raise_application_error(-20000,&#39;Account &#39;&#39;&#39;||acc2||&#39;&#39;&#39; unknown&#39;); end if;<br>  9  end;<br> 10  /</pre><pre name="21de" id="21de" class="graf graf--pre graf-after--pre">Procedure created.<br>Elapsed: 00:00:00.113<br>15:46:11 SQL&gt; desc transfer</pre><pre name="7273" id="7273" class="graf graf--pre graf-after--pre">PROCEDURE transfer<br>Argument Name   Type       In/Out   Default?<br>ACC1            VARCHAR2   IN<br>ACC2            VARCHAR2   IN<br>AMOUNT          NUMBER     IN</pre><pre name="fd06" id="fd06" class="graf graf--pre graf-after--pre">15:46:38 SQL&gt; set timing on<br>15:46:41 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh init to reset cputime counter</pre><pre name="8df0" id="8df0" class="graf graf--pre graf-after--pre">15:46:43 SQL&gt; exec for c in (select * from ACCOUNTS where ACCOUNT_ID&lt;&gt;&#39;X0000001&#39;) loop transfer(c.ACCOUNT_ID,&#39;X0000001&#39;,1); end<br> loop;</pre><pre name="f4c4" id="f4c4" class="graf graf--pre graf-after--pre">PL/SQL procedure successfully completed.</pre><pre name="9df7" id="9df7" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">Elapsed: 00:00:30.283</strong><br>15:47:15 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh diff to show the delta cputime<br>        <strong class="markup--strong markup--pre-strong">30 cpu seconds</strong> in pid=     19971 <strong class="markup--strong markup--pre-strong">oracleCDB1</strong> (LOCAL=NO)</pre><pre name="30da" id="30da" class="graf graf--pre graf-after--pre">15:47:38 SQL&gt; select * from ACCOUNTS order by ACCOUNT_ID fetch first 10 rows only;<br>ACCOUNT_ID     CUSTOMER_ID   AMOUNT<br>X0000001              1150   409999<br>X0000002              1151     9999<br>X0000003              1152     9999<br>X0000004              1153     9999<br>X0000005              1154     9999<br>X0000006              1155     9999<br>X0000007              1156     9999<br>X0000008              1157     9999<br>X0000009              1158     9999<br>X0000010              1159     9999</pre><pre name="1f74" id="1f74" class="graf graf--pre graf-after--pre">10 rows selected.</pre><pre name="5048" id="5048" class="graf graf--pre graf-after--pre">Elapsed: 00:00:00.015<br>15:47:43 SQL&gt; rollback;</pre><pre name="e888" id="e888" class="graf graf--pre graf-after--pre">Rollback complete.</pre><pre name="1f47" id="1f47" class="graf graf--pre graf-after--pre">Elapsed: 00:00:04.266</pre><p name="148e" id="148e" class="graf graf--p graf-after--pre">Now with a JavaScript client: <strong class="markup--strong markup--p-strong">157 seconds of CPU </strong>(in the same database session process, but two engines).</p><pre name="a763" id="a763" class="graf graf--pre graf-after--p">15:48:38 SQL&gt; disconnect</pre><pre name="c658" id="c658" class="graf graf--pre graf-after--pre">Disconnected from Oracle Database 12c Enterprise Edition Release 12.2.0.1.0_MLE - 64bit Beta<br>15:48:54 SQL&gt; script<br>  2  var DriverManager = Java.type(&quot;java.sql.DriverManager&quot;);<br>  3  if ( ! con === undefined ) { con.rollback(); con.close(); }<br>  4  var con = DriverManager.getConnection(&quot;jdbc:oracle:thin:@//localhost/PDB1&quot;,&quot;demo&quot;,&quot;demo&quot;);<br>  5  con.setAutoCommit(false);<br>  6  var sql = con.createStatement();<br>  7  .</pre><pre name="e87f" id="e87f" class="graf graf--pre graf-after--pre">15:49:10 SQL&gt; save script01-init.js replace<br>Wrote file script01-init.js<br>15:49:16 SQL&gt; @    script01-init.js<br>Elapsed: 00:00:01.019<br>15:49:18 SQL&gt; script<br>  2  print(&quot;First 10 accounts:&quot;);<br>  3  var res=sql.executeQuery(&quot; select ACCOUNT_ID,AMOUNT from ACCOUNTS order by 1 fetch first 10 rows only&quot;);<br>  4  while(res.next()){print(&quot; ACCOUNT_ID: &quot;+res.getString(1)+&quot; &quot;+&quot;AMOUNT: &quot;+res.getString(2)); }<br>  5  .</pre><pre name="8cab" id="8cab" class="graf graf--pre graf-after--pre">15:49:33 SQL&gt; save script02-query.js replace<br>Wrote file script02-query.js<br>15:49:35 SQL&gt; @    script02-query.js<br>First 10 accounts:<br> ACCOUNT_ID: X0000001 AMOUNT: 10000<br> ACCOUNT_ID: X0000002 AMOUNT: 10000<br> ACCOUNT_ID: X0000003 AMOUNT: 10000<br> ACCOUNT_ID: X0000004 AMOUNT: 10000<br> ACCOUNT_ID: X0000005 AMOUNT: 10000<br> ACCOUNT_ID: X0000006 AMOUNT: 10000<br> ACCOUNT_ID: X0000007 AMOUNT: 10000<br> ACCOUNT_ID: X0000008 AMOUNT: 10000<br> ACCOUNT_ID: X0000009 AMOUNT: 10000<br> ACCOUNT_ID: X0000010 AMOUNT: 10000<br>Elapsed: 00:00:00.181<br>15:49:37 SQL&gt; script<br>  2  var pre1=con.prepareStatement(&quot; update ACCOUNTS set AMOUNT=AMOUNT-? where ACCOUNT_ID=?&quot;);<br>  3  var pre2=con.prepareStatement(&quot; update ACCOUNTS set AMOUNT=AMOUNT+? where ACCOUNT_ID=?&quot;);<br>  4  function transfer (acc1,acc2,amount) {<br>  5   pre1.setInt(1,amount); pre1.setString(2,acc1); pre1.execute();<br>  6   pre2.setInt(1,amount); pre2.setString(2,acc2); pre2.execute();<br>  7  }<br>  8  var res=sql.executeQuery(&quot; select ACCOUNT_ID from ACCOUNTS where ACCOUNT_ID&lt;&gt;&#39;X0000001&#39;&quot;);<br>  9  print(&quot;Calling transaction for each account...&quot;);var t0=new Date();var cnt=0;<br> 10  while(res.next()){ transfer(res.getString(1),&#39;X0000001&#39;,1); cnt++ }<br> 11  print(cnt+&quot; transactions executed in &quot;+(new Date() - t0)/1000+&quot; seconds&quot;);<br> 12  .</pre><pre name="51d4" id="51d4" class="graf graf--pre graf-after--pre">15:50:17 SQL&gt; save script02-run.js replace<br>Wrote file script02-run.js<br>15:50:18 SQL&gt; set timing on<br>15:50:22 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh init to reset cputime counter</pre><pre name="54c3" id="54c3" class="graf graf--pre graf-after--pre">15:50:25 SQL&gt; @    script02-run.js<br>Calling transaction for each account...<br>399999 transactions executed in 138.016 seconds<br><strong class="markup--strong markup--pre-strong">Elapsed: 00:02:18.082</strong><br>15:52:45 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh diff to show the delta cputime<br>        <strong class="markup--strong markup--pre-strong">52 cpu seconds</strong> in pid=     19945 /opt/oracle/product/12.2.0.1/dbhome_1/jdk/jre/bin/<strong class="markup--strong markup--pre-strong">java</strong> -Djava.awt.headless=true -Dappl<br>e.awt.UIElement=true -Xss10M -client<br>       <strong class="markup--strong markup--pre-strong">105 cpu seconds</strong> in pid=     20426 <strong class="markup--strong markup--pre-strong">oracleCDB1</strong> (LOCAL=NO)</pre><pre name="f614" id="f614" class="graf graf--pre graf-after--pre">15:52:56 SQL&gt; @    script02-query.js<br>First 10 accounts:<br> ACCOUNT_ID: X0000001 AMOUNT: 409999<br> ACCOUNT_ID: X0000002 AMOUNT: 9999<br> ACCOUNT_ID: X0000003 AMOUNT: 9999<br> ACCOUNT_ID: X0000004 AMOUNT: 9999<br> ACCOUNT_ID: X0000005 AMOUNT: 9999<br> ACCOUNT_ID: X0000006 AMOUNT: 9999<br> ACCOUNT_ID: X0000007 AMOUNT: 9999<br> ACCOUNT_ID: X0000008 AMOUNT: 9999<br> ACCOUNT_ID: X0000009 AMOUNT: 9999<br> ACCOUNT_ID: X0000010 AMOUNT: 9999<br>Elapsed: 00:00:00.015<br>15:53:13 SQL&gt; script<br>  2  con.rollback();<br>  3  con.close();<br>  4  .</pre><pre name="5263" id="5263" class="graf graf--pre graf-after--pre">15:53:20 SQL&gt; save script02-close.js replace<br>Wrote file script02-close.js<br>15:53:22 SQL&gt; @    script02-close.js<br>Elapsed: 00:00:06.198</pre><p name="845c" id="845c" class="graf graf--p graf-after--pre">And finally running JavaScript in the MLE engine: <strong class="markup--strong markup--p-strong">223 seconds of CPU</strong>. This MLE, in beta, may not be fully optimized, so the time is not very relevant. The point is that the whole is running 100% in the same process.</p><pre name="04a2" id="04a2" class="graf graf--pre graf-after--p">15:53:31 SQL&gt; connect demo/demo@//localhost/pdb1<br>Connected.</pre><pre name="be7c" id="be7c" class="graf graf--pre graf-after--pre">15:55:34 SQL&gt; create or replace javascript source named &quot;demo.js&quot; as<br>  2  function transfer (acc1,acc2,amount) {<br>  3   var sql = _dbRequire(&#39;<a href="http://twitter.com/oracle/sql" data-href="http://twitter.com/oracle/sql" class="markup--anchor markup--pre-anchor" title="Twitter profile for @oracle/sql" rel="noopener" target="_blank">@oracle/sql</a>&#39;);<br>  4   sql.execute(&quot; update ACCOUNTS set AMOUNT=AMOUNT-:amount where ACCOUNT_ID=:acc1&quot;,[amount,acc1]);<br>  5   sql.execute(&quot; update ACCOUNTS set AMOUNT=AMOUNT+:amount where ACCOUNT_ID=:acc2&quot;,[amount,acc2]);<br>  6  }<br>  7  module.exports.run = function () {<br>  8   var sql = _dbRequire(&#39;<a href="http://twitter.com/oracle/sql" data-href="http://twitter.com/oracle/sql" class="markup--anchor markup--pre-anchor" title="Twitter profile for @oracle/sql" rel="noopener" target="_blank">@oracle/sql</a>&#39;);<br>  9   var res=sql.execute(&quot; select ACCOUNT_ID from ACCOUNTS where ACCOUNT_ID&lt;&gt;&#39;X0000001&#39;&quot;);<br> 10   for (var row of res.rows) {<br> 11    transfer(row[0],&#39;X0000001&#39;,1);<br> 12   }<br> 13  }<br> 14  /</pre><pre name="d9f6" id="d9f6" class="graf graf--pre graf-after--pre">Function created.<br>Elapsed: 00:00:00.013<br>15:56:02 SQL&gt; create or replace procedure run as language javascript<br>  2  name &#39;demo\.js.run()&#39;;<br>  3  /</pre><pre name="ee3f" id="ee3f" class="graf graf--pre graf-after--pre">Procedure created.<br>Elapsed: 00:00:00.032<br>15:56:14 SQL&gt; select * FROM user_libraries;</pre><pre name="69c5" id="69c5" class="graf graf--pre graf-after--pre">no rows selected<br>Elapsed: 00:00:00.122<br>15:56:19 SQL&gt; select object_name,procedure_name,object_type from user_procedures;<br>OBJECT_NAME   PROCEDURE_NAME   OBJECT_TYPE<br>RUN                            PROCEDURE<br>TRANSFER                       PROCEDURE</pre><pre name="a57f" id="a57f" class="graf graf--pre graf-after--pre">Elapsed: 00:00:00.291<br>15:56:21 SQL&gt; select object_name,procedure_name,object_type from user_procedures;<br>OBJECT_NAME   PROCEDURE_NAME   OBJECT_TYPE<br>RUN                            PROCEDURE<br>TRANSFER                       PROCEDURE</pre><pre name="edce" id="edce" class="graf graf--pre graf-after--pre">Elapsed: 00:00:00.012<br>15:56:36 SQL&gt; set timing on<br>15:56:51 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh init to reset cputime counter</pre><pre name="6696" id="6696" class="graf graf--pre graf-after--pre">15:56:53 SQL&gt; call demo.run();</pre><pre name="0e39" id="0e39" class="graf graf--pre graf-after--pre">Call completed.</pre><pre name="a6e8" id="a6e8" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">Elapsed: 00:03:32.463</strong><br>16:00:28 SQL&gt; host sh /tmp/sqlcl/show-cpu-seconds-from-ps.sh diff to show the delta cputime<br>       <strong class="markup--strong markup--pre-strong">223 cpu seconds</strong> in pid=     20761 <strong class="markup--strong markup--pre-strong">oracleCDB1</strong> (LOCAL=NO)</pre><p name="ad57" id="ad57" class="graf graf--p graf-after--pre">The important point with this MLE engine is that you can write your code without being tied to a platform. You write code (or use libraries of code, copy/paste from StackOverflow…) in the latest trendy languages (JavaScript and Python for the moment, whatever in the future). And it can run on the client, the application server, or in the database. Then, the best colocation of code can be achieved without duplicating the logic into different languages. In summary, the developer thinks “serverless” for simplicity and agility and the operations run “full server” for efficiency and scalability.</p><p name="6da0" id="6da0" class="graf graf--p graf-after--p">But that’s for the future. Follow the <a href="https://www.oracle.com/technetwork/database/multilingual-engine/overview/index.html" data-href="https://www.oracle.com/technetwork/database/multilingual-engine/overview/index.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MLE</a> and be involved in the <a href="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/" data-href="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">community</a>:</p><div name="6faa" id="6faa" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/" data-href="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/"><strong class="markup--strong markup--mixtapeEmbed-strong">Space: <em class="markup--em markup--mixtapeEmbed-em">Multilingual Engine</em> | Oracle Community</strong><br>Multilingual Enginecommunity.oracle.com</a><a href="https://community.oracle.com/community/groundbreakers/database/developer-tools/multilingual-engine/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="09f34e1e1513766890b50403b367cdf3" data-thumbnail-img-id="0*qvbOR9yAXFikVZCq" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*qvbOR9yAXFikVZCq);"></a></div><p name="b92a" id="b92a" class="graf graf--p graf-after--mixtapeEmbed">For your curiosity, where is the perf-top for the last run in MLE showing the work in oracle and in libmle.so engines:</p><figure name="4218" id="4218" class="graf graf--figure graf-after--p graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*neT70UvmEmYqNsWS2X-Eag.png" data-width="2670" data-height="1504" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*neT70UvmEmYqNsWS2X-Eag.png"></div></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/a7a102e1e5ce"><time class="dt-published" datetime="2019-03-17T20:02:57.838Z">March 17, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/sql-pl-sql-and-javascript-running-in-the-database-server-oracle-mle-a7a102e1e5ce" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>