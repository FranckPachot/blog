<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>PostgreSQL ‘bind variable peeking’</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">PostgreSQL ‘bind variable peeking’</h1>
</header>
<section data-field="subtitle" class="p-summary">
When coming from Oracle like me we know how important it is to balance the pros and cons of using bind variables or literals.
</section>
<section data-field="body" class="e-content">
<section name="e0b6" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5f65" id="5f65" class="graf graf--h3 graf--leading graf--title">PostgreSQL ‘bind variable peeking’</h3><p name="a6e9" id="a6e9" class="graf graf--p graf-after--h3">When coming from Oracle like me we know how important it is to balance the pros and cons of using bind variables or literals. </p><ul class="postList"><li name="88ce" id="88ce" class="graf graf--li graf-after--p">Bind variables have the advantage to share the query execution plan with several executions so that there’s no need to parse and optimizer each time</li><li name="cdfe" id="cdfe" class="graf graf--li graf-after--li">Bind variables have the inconvenient to share the query execution plan with the risk that what is optimized for one value is bad for another value</li></ul><p name="1109" id="1109" class="graf graf--p graf-after--li">This post is about using bind values, and for which value is the plan optimized for. Basically, there are two possibilities. The plan can be compiled without any knowledge of the values for which it will be executed. Or the plan can be optimized for a chosen fixed value (called peeked bind in Oracle or sniffed parameter in SQL Server). But which value? Each execution one? The first one only? A randomly peeked one?</p><h4 name="39f8" id="39f8" class="graf graf--h4 graf-after--p">Oracle</h4><p name="e7f8" id="e7f8" class="graf graf--p graf-after--h4">Before Oracle 9iR2 the execution plan was optimized before any execution. From 9iR2, except when “ _optim_peek_user_binds” is set false, the optimization is deferred to the first execution and the plan will be optimized for it. It is then expected to be more accurate, but the future executions of the same cursor will use the same, and that can be bad. In 11g Oracle tried to prevent this in some cases where the optimizer can decide to optimize it again with the new execution value.</p><p name="b66f" id="b66f" class="graf graf--p graf-after--p">But this is about cursor sharing and the goal of this post is to compare with PostgreSQL which has no cursor sharing. The only way to share a cursor by multiple executions is by preparing it — and the limitation is that this is possible only within one session.</p><p name="5155" id="5155" class="graf graf--p graf-after--p">And in Oracle, that’s simple: Adaptive Cursor Sharing happens only at parse call, so a prepared statement will always use the first execution value.</p><h4 name="c435" id="c435" class="graf graf--h4 graf-after--p">PostgreSQL</h4><p name="bff0" id="bff0" class="graf graf--p graf-after--h4">With Postgres there is nothing like Oracle cursor sharing to avoid the expensive compilation at each execution. Trying to avoid that requires to prepare the statements. But even there, there is no re-use:</p><ul class="postList"><li name="d166" id="d166" class="graf graf--li graf-after--p">The first 5 executions will compile the query plan for each execution — aiming at an accurate plan as if the values were passed as literals</li><li name="fb52" id="fb52" class="graf graf--li graf-after--li">From the 6th execution, the plan will be reused by all future executions of the same prepared statement (i.e in the same session). But no ‘peeked bind’ is chosen. The optimizer falls to a plan optimized without the knowledge of the value.</li></ul><p name="26f1" id="26f1" class="graf graf--p graf-after--li">Here is the documentation about it:</p><div name="8ab5" id="8ab5" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.postgresql.org/docs/11/sql-prepare.html#SQL-PREPARE-NOTES" data-href="https://www.postgresql.org/docs/11/sql-prepare.html#SQL-PREPARE-NOTES" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.postgresql.org/docs/11/sql-prepare.html#SQL-PREPARE-NOTES"><strong class="markup--strong markup--mixtapeEmbed-strong">PostgreSQL: Documentation: 11: PREPARE</strong><br><em class="markup--em markup--mixtapeEmbed-em">Prepared statements potentially have the largest performance advantage when a single session is being used to execute a…</em>www.postgresql.org</a><a href="https://www.postgresql.org/docs/11/sql-prepare.html#SQL-PREPARE-NOTES" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="28c6e46799e93e58d6b3b41ca27ab152" data-thumbnail-img-id="0*vvfPhCv6K4lFbCTg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*vvfPhCv6K4lFbCTg);"></a></div><p name="f800" id="f800" class="graf graf--p graf-after--mixtapeEmbed">I’ve run a little demo to show there in db&lt;&gt;fiddle:</p><div name="b941" id="b941" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://dbfiddle.uk/?rdbms=postgres_11&amp;fiddle=ae9eb57ba9b15a5278c5a4f4a380f448" data-href="https://dbfiddle.uk/?rdbms=postgres_11&amp;fiddle=ae9eb57ba9b15a5278c5a4f4a380f448" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://dbfiddle.uk/?rdbms=postgres_11&amp;fiddle=ae9eb57ba9b15a5278c5a4f4a380f448"><strong class="markup--strong markup--mixtapeEmbed-strong">db fiddle</strong><br><em class="markup--em markup--mixtapeEmbed-em">create table DEMO as select 1 n from generate_series(1,11) union all select 2 from generate_series(1,22) union all…</em>dbfiddle.uk</a><a href="https://dbfiddle.uk/?rdbms=postgres_11&amp;fiddle=ae9eb57ba9b15a5278c5a4f4a380f448" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="a341f96bedf084b41cb8255023c399d2"></a></div><p name="37a9" id="37a9" class="graf graf--p graf-after--mixtapeEmbed">This runs with the following table created and analyzed:</p><pre name="741e" id="741e" class="graf graf--pre graf-after--p">create table DEMO as select 1 n from generate_series(1,11)<br>           union all select 2   from generate_series(1,22)<br>           union all select 3   from generate_series(1,33)<br>           union all select 4   from generate_series(1,44)<br>           union all select 5   from generate_series(1,55)<br>           union all select 6   from generate_series(1,66)<br>           union all select 7   from generate_series(1,77)<br>           union all select 8   from generate_series(1,88)<br>           union all select 9   from generate_series(1,1000)<br>           ;</pre><pre name="ec26" id="ec26" class="graf graf--pre graf-after--pre">select count(*),count(distinct n) from DEMO;</pre><pre name="adb9" id="adb9" class="graf graf--pre graf-after--pre"> count | count<br>-------+-------<br>  1396 |     9</pre><pre name="9138" id="9138" class="graf graf--pre graf-after--pre">analyze DEMO;<br>ANALYZE</pre><p name="695b" id="695b" class="graf graf--p graf-after--pre">I’ve created rows with skewed distributions: 11 rows with value ‘1’, 22 with value ‘2’,… And I analyzed the table so that histograms are gathered to have the query planner aware of it:</p><pre name="9b73" id="9b73" class="graf graf--pre graf-after--p">\x<br>Expanded display is on.<br>select * from pg_stats where tablename = &#39;demo&#39; and attname = &#39;n&#39;;<br>-[ RECORD 1 ]----------+--------------------------------------------<br>schemaname             | public<br>tablename              | demo<br>attname                | n<br>inherited              | f<br>null_frac              | 0<br>avg_width              | 4<br>n_distinct             | 9<br>most_common_vals       | {9,8,7,6,5,4,3,2,1}<br>most_common_freqs      | {0.716332, 0.0630372, 0.0551576, 0.0472779, 0.0393983, 0.0315186, 0.023639, 0.0157593, 0.00787966}<br>histogram_bounds       |<br>correlation            | 1<br>most_common_elems      |<br>most_common_elem_freqs |<br>elem_count_histogram   |</pre><pre name="1601" id="1601" class="graf graf--pre graf-after--pre">\x<br>Expanded display is off.</pre><p name="16c9" id="16c9" class="graf graf--p graf-after--pre">I prepare my statement:</p><pre name="0bbc" id="0bbc" class="graf graf--pre graf-after--p">prepare myselect (int) as select count(*) from DEMO where n=$1;<br>PREPARE</pre><p name="c974" id="c974" class="graf graf--p graf-after--pre">And run this statement several times with different value, the goal being to look at the query planner estimation for the number of rows for each value:</p><pre name="3c7e" id="3c7e" class="graf graf--pre graf-after--p">QUERY PLAN<br>------------------------------------------------------------<br> Aggregate  (cost=24.48..24.49 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=11</strong> width=0)<br>         Filter: (n = 1)</pre><pre name="1973" id="1973" class="graf graf--pre graf-after--pre">explain execute myselect(2);<br>                         QUERY PLAN<br>------------------------------------------------------------<br> Aggregate  (cost=24.50..24.52 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=22</strong> width=0)<br>         Filter: (n = 2)</pre><pre name="27d3" id="27d3" class="graf graf--pre graf-after--pre">explain execute myselect(3);<br>                         QUERY PLAN<br>------------------------------------------------------------<br> Aggregate  (cost=24.53..24.54 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=33</strong> width=0)<br>         Filter: (n = 3)</pre><pre name="0b30" id="0b30" class="graf graf--pre graf-after--pre">explain execute myselect(4);<br>                         QUERY PLAN<br>------------------------------------------------------------<br> Aggregate  (cost=24.56..24.57 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=44</strong> width=0)<br>         Filter: (n = 4)</pre><pre name="2b46" id="2b46" class="graf graf--pre graf-after--pre">explain execute myselect(5);<br>                         QUERY PLAN<br>------------------------------------------------------------<br> Aggregate  (cost=24.59..24.60 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=55</strong> width=0)<br>         Filter: (n = 5)</pre><pre name="174c" id="174c" class="graf graf--pre graf-after--pre">explain execute myselect(6);<br>                         QUERY PLAN<br>-------------------------------------------------------------<br> Aggregate  (cost=24.84..24.85 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=155</strong> width=0)<br>         Filter: (n = $1)</pre><pre name="354e" id="354e" class="graf graf--pre graf-after--pre">explain execute myselect(7);<br>                         QUERY PLAN<br>-------------------------------------------------------------<br> Aggregate  (cost=24.84..24.85 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=155</strong> width=0)<br>         Filter: (n = $1)</pre><pre name="cc2a" id="cc2a" class="graf graf--pre graf-after--pre">explain execute myselect(8);<br>                         QUERY PLAN<br>-------------------------------------------------------------<br> Aggregate  (cost=24.84..24.85 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=155</strong> width=0)<br>         Filter: (n = $1)</pre><pre name="0600" id="0600" class="graf graf--pre graf-after--pre">explain execute myselect(9);<br>                         QUERY PLAN<br>-------------------------------------------------------------<br> Aggregate  (cost=24.84..24.85 rows=1 width=8)<br>   -&gt;  Seq Scan on demo  (cost=0.00..24.45 <strong class="markup--strong markup--pre-strong">rows=155</strong> width=0)<br>         Filter: (n = $1)</pre><p name="02da" id="02da" class="graf graf--p graf--empty graf-after--pre"><br></p><pre name="79d7" id="79d7" class="graf graf--pre graf-after--p">select count(*),count(distinct n),count(*)/count(distinct n) <br>&quot;avg. rows per value&quot; from DEMO;</pre><pre name="dabb" id="dabb" class="graf graf--pre graf-after--pre"> count | count | avg. rows per value<br>-------+-------+---------------------<br>   429 |     9 |                  47</pre><p name="ae3b" id="ae3b" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="3ba1" id="3ba1" class="graf graf--p graf--empty graf-after--p"><br></p><p name="1d54" id="1d54" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="9d8b" id="9d8b" class="graf graf--pre graf-after--p">select count(*),count(distinct n),count(*)/count(distinct n) &quot;avg. rows per value&quot; from DEMO;<br> count | count | avg. rows per value<br>-------+-------+---------------------<br>   310 |     9 |                  34</pre><p name="eb84" id="eb84" class="graf graf--p graf--empty graf-after--pre"><br></p><p name="8800" id="8800" class="graf graf--p graf--empty graf-after--p"><br></p><pre name="cf2e" id="cf2e" class="graf graf--pre graf-after--p">create table DEMO as select 1 n from generate_series(1,11)<br>           union all select 2 from generate_series(1,22)<br>           union all select 3 from generate_series(1,33)<br>           union all select 4 from generate_series(1,44)<br>           union all select 5 from generate_series(1,55)<br>           union all select 6 from generate_series(1,66)<br>           union all select 7 from generate_series(1,66)<br>           union all select 8 from generate_series(1,66)<br>           union all select 9 from generate_series(1,66)<br>           ;<br>\\<br>select count(*),count(distinct n) from DEMO;<br>\\<br>analyze DEMO<br>\\<br>prepare myselect (int) as select count(*) from DEMO where n=$1;<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(1);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(2);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(3);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(4);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(5);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(6);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(7);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(8);<br>\\<br>explain (analyze,verbose,costs,buffers) execute myselect(9);</pre><pre name="2b20" id="2b20" class="graf graf--pre graf--empty graf-after--pre"><br></pre><div name="4446" id="4446" class="graf graf--mixtapeEmbed graf-after--pre"><a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/cache/plancache.c" data-href="https://github.com/postgres/postgres/blob/master/src/backend/utils/cache/plancache.c" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/postgres/postgres/blob/master/src/backend/utils/cache/plancache.c"><strong class="markup--strong markup--mixtapeEmbed-strong">postgres/postgres</strong><br><em class="markup--em markup--mixtapeEmbed-em">Mirror of the official PostgreSQL GIT repository. Note that this is just a *mirror* - we don&#39;t work with pull requests…</em>github.com</a><a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/cache/plancache.c" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="8b7d0450d0afb725fe84eb045f0c0c64" data-thumbnail-img-id="0*VbGEm1h7xSukZVkw" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*VbGEm1h7xSukZVkw);"></a></div><p name="c1b7" id="c1b7" class="graf graf--p graf--empty graf-after--mixtapeEmbed graf--trailing"><br></p></div></div></section>
</section>
<footer><p><a href="https://medium.com/p/fb4be4942252">View original.</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>