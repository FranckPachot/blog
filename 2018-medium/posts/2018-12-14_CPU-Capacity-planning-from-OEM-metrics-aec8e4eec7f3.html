<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>CPU Capacity planning from OEM metrics</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">CPU Capacity planning from OEM metrics</h1>
</header>
<section data-field="subtitle" class="p-summary">
The CPU used by your Oracle Database is expensive because it is the metric used by licensing. The more you can control and know what you…
</section>
<section data-field="body" class="e-content">
<section name="e8ad" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="bf2e" id="bf2e" class="graf graf--h3 graf--leading graf--title">CPU Capacity planning from OEM metrics</h3><p name="58ff" id="58ff" class="graf graf--p graf-after--h3">The CPU used by your Oracle Database is expensive because it is the metric used by licensing. The more you can control and know what you need, the more freedom you will have to optimize the costs. With instance caging, available in all editions, you can put a soft limit. This means that:</p><ul class="postList"><li name="8de8" id="8de8" class="graf graf--li graf-after--p">you run on a limited number of threads and after a while, this gives a good idea of what you really need. You can forecast the capacity for a future consolidation.</li><li name="9b7d" id="9b7d" class="graf graf--li graf-after--li">you monitor ‘resmgr: cpu quantum’ and if activity is high you can decide to scale-up immediately, throttle some services, or do some query/design tuning.</li></ul><p name="5e3b" id="5e3b" class="graf graf--p graf-after--li">In order to set instance caging, you need to define a value for CPU_COUNT according to the past activity. This post is the detail behind the following tweet:</p><figure name="8b59" id="8b59" class="graf graf--figure graf--iframe graf-after--p"><blockquote class="twitter-tweet"><a href="https://twitter.com/FranckPachot/status/1072776055499427840?s=20"></a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></figure><p name="7929" id="7929" class="graf graf--p graf-after--figure">Oracle Enterprise Manager cloud Control collects many metrics from the target databases and maintains a history of them with daily minimum, maximum and average,… The <a href="https://docs.oracle.com/cd/E63000_01/EMVWS/monview.htm#EMVWS32314" data-href="https://docs.oracle.com/cd/E63000_01/EMVWS/monview.htm#EMVWS32314" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Oracle documentation</a> mentions the view MGMT$METRIC_DAILY but I prefer the MGMT_METRICS_1DAY because the ‘underscore’ views are not mentioned in the <a href="https://docs.oracle.com/cd/E63000_01/OEMLI/db_mgmt.htm#OEMLI115" data-href="https://docs.oracle.com/cd/E63000_01/OEMLI/db_mgmt.htm#OEMLI115" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Licensing Information</a> documentation. The ‘dollar’ metric views require Diagnostic Pack. However, those scripts are to be used with databases where Diagnostic Pack is enabled.</p><h3 name="d344" id="d344" class="graf graf--h3 graf-after--p">Average, Maximum or Percentile?</h3><p name="6ae7" id="6ae7" class="graf graf--p graf-after--h3">The goal is to define a CPU_COUNT which accepts the peak activity. Then I’ll get the maximum value from the daily metric: the maximum number of sessions in CPU observed during each day. However, we may have experienced an issue where some queries take lot of resources. If this is caused by an application bug or bad execution plan, we need to fix it. We don’t want to pay for CPU to cope with these issues. Then, rather than taking the maximum, I’ll look at a percentile. Here is a graph from 4 instances during 2 years:</p><figure name="3ed9" id="3ed9" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 166px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 23.7%;"></div><img class="graf-image" data-image-id="1*a1aLb8pK4l0OPWfJFGuUeg.png" data-width="1511" data-height="358" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*a1aLb8pK4l0OPWfJFGuUeg.png"></div></figure><p name="4e6c" id="4e6c" class="graf graf--p graf-after--figure">Do you want to pay for 120 threads just because of one peak? Probably not. Taking a percentile 99% will give the value to cope with 99% of the days.</p><p name="07c1" id="07c1" class="graf graf--p graf-after--p">My query for these instances returns the following: 125 thread is the maximum, but 74 threads are sufficient for 99% of the days observed. And 50 threads are ok for 90% of the days:</p><figure name="e96b" id="e96b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 284px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.5%;"></div><img class="graf-image" data-image-id="1*gyDeDYppmaIQYXmbkzwh8w.png" data-width="933" data-height="378" src="https://cdn-images-1.medium.com/max/800/1*gyDeDYppmaIQYXmbkzwh8w.png"></div></figure><p name="ebc3" id="ebc3" class="graf graf--p graf-after--figure">You see the same number for multiple instances because they are nodes for the same database.</p><h3 name="067f" id="067f" class="graf graf--h3 graf-after--p">RAC instances</h3><p name="621e" id="621e" class="graf graf--p graf-after--h3">Here is another example with two nodes from the same database. In addition to the peaks where we can accept to throttle for a short time, there is a service that has been relocated several times:</p><figure name="88a1" id="88a1" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 145px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 20.7%;"></div><img class="graf-image" data-image-id="1*PxmlwQui50A3zi2LojEofw.png" data-width="2044" data-height="423" src="https://cdn-images-1.medium.com/max/800/1*PxmlwQui50A3zi2LojEofw.png"></div></figure><p name="6b76" id="6b76" class="graf graf--p graf-after--figure">Then which CPU_COUNT do you want to set on each instance? The safest would be to accept, on each node, the possibility to run the load observed on the whole cluster. This can happen in an exceptional case where only one node remains. But this costs a lot. Rather than setting the sum of cluster load, we can set the maximum observed, so that each node can accept a peak observed on one of the nodes. Or, if we don’t expect service relocation, or if we accept some response time degradation in those cases, we can just set what has been observed on the node.</p><p name="e640" id="e640" class="graf graf--p graf-after--p">The following query joins the daily metrics with some target information: “Line of Business” and “Department” to group the databases from a business point of view, “LifeCycle Status” to differentiate production, test, and development.</p><p name="e311" id="e311" class="graf graf--p graf-after--p">The metric selected is the per-instance CPU second per second, which is the average number of sessions in CPU.</p><p name="f826" id="f826" class="graf graf--p graf--startsWithDoubleQuote graf-after--p">“CPU load/instance/day” does the join and calculates the value, the max, and the sum among the cluster. With single-instance, you don’t have to worry. With RAC, you may decide, in “Target CPU load/instance/day” which one you use. Then “Proposed instance caging” calculates the percentiles. The main query, at the end, does a ‘group by rollup’ to add some aggregates per business and environment. Of course, you will customize for your needs. My goal is to show the useful sources of information and how to mine them.</p><pre name="846a" id="846a" class="graf graf--pre graf-after--p">with <br>TARGET_PROPERTIES as (<br>    select target_guid,property_name,property_value <br>    from sysman.MGMT_TARGET_PROPERTIES<br>    where property_type=&#39;INSTANCE&#39;<br>),<br>TARGET_PROP_DEFS as (<br>    select property_name,property_display_name<br>    from sysman.MGMT$ALL_TARGET_PROP_DEFS <br>    where defined_by=&#39;SYSTEM&#39;<br>),<br>TARGET_LINE_OF_BUSINESS as (<br>    select target_guid,property_value &quot;Line of Business&quot; <br>    from TARGET_PROP_DEFS <br>    natural left outer join <br>    TARGET_PROPERTIES where property_display_name=&#39;Line of Business&#39;<br>),<br>TARGET_DEPARTMENT as (<br>    select target_guid,property_value &quot;Department&quot; <br>    from TARGET_PROP_DEFS <br>    natural left outer join <br>    TARGET_PROPERTIES where property_display_name=&#39;Department&#39;<br>),<br>TARGET_LIFESYCLE_STATUS as (<br>    select target_guid,property_value &quot;LifeCycle Status&quot; <br>    from TARGET_PROP_DEFS <br>    natural left outer join <br>    TARGET_PROPERTIES <br>    where property_display_name=&#39;LifeCycle Status&#39;<br>),<br>TARGET_RAC_DATABASES as (<br>    select member_target_name target_name<br>    ,member_target_guid target_guid<br>    ,composite_target_name &quot;RAC Database&quot;<br>    from sysman.MGMT_TARGET_MEMBERSHIPS<br>    where composite_target_type=&#39;rac_database&#39; <br>    and member_target_type=&#39;oracle_database&#39;<br>),<br>TARGETS_INSTANCES as (<br>    select target_guid, target_type, type_meta_ver<br>    ,category_prop_1, target_name <br>    from sysman.mgmt_targets <br>    where target_type=&#39;oracle_database&#39; <br>),<br>METRICS_CPU as (<br>    select metric_guid<br>    ,target_type, type_meta_ver, category_prop_1, metric_name<br>    ,metric_label, key_column, num_keys, column_label<br>    ,description, short_name, source, eval_func <br>    from sysman.mgmt_metrics<br>    where column_label = &#39;CPU Usage (per second)&#39;<br>),<br>METRICS_1DAY as (<br>    select target_guid<br>    ,metric_guid,rollup_timestamp &quot;Day&quot;<br>    ,value_maximum/100 &quot;Max CPU load&quot;<br>    from sysman.mgmt_metrics_1day<br>),<br>&quot;CPU load/instance/day&quot; as (<br>    select &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;<br>    ,&quot;RAC Database&quot;,target_name &quot;Instance&quot;,&quot;Day&quot;,&quot;Max CPU load&quot;<br>    -- sums over the RAC cluster because we should afford running all services on one instance (but sum of max can be large when a service has been relocated during the day)<br>    ,sum(&quot;Max CPU load&quot;) over (partition by &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Day&quot;) &quot;Sum instances CPU load&quot;<br>    -- or just need to ensure that each node can run the maximum observed per node<br>    ,max(&quot;Max CPU load&quot;) over (partition by &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Day&quot;) &quot;Max instances CPU load&quot;<br>    from <br>        METRICS_1DAY<br>    natural join    <br>        METRICS_CPU<br>    natural join<br>        TARGETS_INSTANCES<br>    natural left outer join<br>        TARGET_LINE_OF_BUSINESS<br>    natural left outer join<br>        TARGET_RAC_DATABASES<br>    natural left outer join<br>        TARGET_LIFESYCLE_STATUS<br>    natural left outer join<br>        TARGET_DEPARTMENT<br>),<br>&quot;Target CPU load/instance/day&quot; as (<br>    select &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Instance&quot;,&quot;Day&quot;<br>    -- choice of the metric used when in RAC:<br>    --  - &quot;Max CPU load&quot; when not counting relocation of services,<br>    --  - &quot;Sum instances CPU load&quot; when counting that each nodes can accept the maximum load seen in any node<br>    --  - &quot;Max instances CPU load&quot; when counting that each node can accept the maximul load seen in the whole cluster<br>    ,&quot;Max CPU load&quot; &quot;Max CPU&quot;<br>    from &quot;CPU load/instance/day&quot;<br>),<br>&quot;Proposed instance caging&quot; as (<br>select <br>    &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Instance&quot;<br>    ,ceil(max(&quot;Max CPU&quot;)) &quot;From Max&quot;<br>    -- here we add a percentile calculation because we do not count expceptional peaks<br>    ,ceil(percentile_cont(0.99) within group(order by &quot;Max CPU&quot;)) &quot;From percentile 99%&quot;<br>    ,ceil(percentile_cont(0.90) within group(order by &quot;Max CPU&quot;)) &quot;From percentile 90%&quot;<br>    from &quot;Target CPU load/instance/day&quot;<br>    group by &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Instance&quot;<br>)<br>select<br> &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;<br> ,&quot;RAC Database&quot;,&quot;Instance&quot; <br> ,sum(&quot;From Max&quot;)<br> ,sum(&quot;From percentile 99%&quot;),sum(&quot;From percentile 90%&quot;)<br>from &quot;Proposed instance caging&quot;<br> group by rollup (<br> &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Instance&quot;<br> )<br> order by <br> grouping(&quot;Line of Business&quot;) desc,grouping(&quot;Department&quot;) desc,grouping(&quot;LifeCycle Status&quot;) desc,grouping(&quot;RAC Database&quot;) desc,grouping(&quot;Instance&quot;) desc,<br> &quot;Line of Business&quot;,&quot;Department&quot;,&quot;LifeCycle Status&quot;,&quot;RAC Database&quot;,&quot;Instance&quot;<br>;</pre><p name="3e40" id="3e40" class="graf graf--p graf-after--pre">You may like or not my way of writing SQL queries. I use Common Table Expressions to define the source of data, name each column according to its role in the final result, and use natural join because the names define clearly the join columns. I find this very easy to develop and test each step.</p><p name="fbc2" id="fbc2" class="graf graf--p graf-after--p">The “CPU load/instance/day” result can easily be exported to an Excel pivot graph to look at the whole picture, as above, before deciding which percentile and which cluster aggregation to use. You may even have to look at your logs to see if the peaks are related to business activity (where you want to scale-up) or a problem (which you want to cage). And remember that the goal is to set a base for instance caging, which can be adapted easily later. When you run a while with a controlled number of threads, you can consider consolidation and licensing optimization. And don’t forget to see if you can reduce the CPU_COUNT with some tuning. Please, don’t hesitate to comment, here or on Twitter, with remarks or improvements.</p><div name="c879" id="c879" class="graf graf--mixtapeEmbed graf-after--p graf--trailing"><a href="https://twitter.com/FranckPachot" data-href="https://twitter.com/FranckPachot" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://twitter.com/FranckPachot"><strong class="markup--strong markup--mixtapeEmbed-strong">Franck Pachot (@FranckPachot) | Twitter</strong><br><em class="markup--em markup--mixtapeEmbed-em">The latest Tweets from Franck Pachot (@FranckPachot). DBA at @CERN, Oracle #ACED, OCM 12c, @OakTableNetwork member…</em>twitter.com</a><a href="https://twitter.com/FranckPachot" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="116aee57dd84452d090cfed9f2a85124" data-thumbnail-img-id="0*bltcMVtgRh_Zes_0" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*bltcMVtgRh_Zes_0);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/aec8e4eec7f3"><time class="dt-published" datetime="2018-12-14T21:03:12.684Z">December 14, 2018</time></a>.</p><p><a href="https://medium.com/@FranckPachot/cpu-capacity-planning-from-oem-metrics-aec8e4eec7f3" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>