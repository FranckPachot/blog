<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Oracle ATP: MEDIUM and HIGH services are not for OLTP</title><style>
      * {
        <!--font-family: Georgia, Cambria, "Times New Roman", Times, serif;-->
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Oracle ATP: MEDIUM and HIGH services are not for OLTP</h1>
</header>
<section data-field="subtitle" class="p-summary">
The Autonomous Transaction Processing services HIGH and MEDIUM are forcing Parallel DML, which can lock the tables in eXclusive mode.
</section>
<section data-field="body" class="e-content">
<section name="9b5e" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="615f" id="615f" class="graf graf--h3 graf--leading graf--title">Oracle ATP: MEDIUM and HIGH services are not for OLTP</h3><h4 name="c4c4" id="c4c4" class="graf graf--h4 graf-after--h3 graf--subtitle">The Autonomous Transaction Processing services HIGH and MEDIUM are forcing Parallel DML, which can lock the tables in eXclusive mode.</h4><p name="a5ae" id="a5ae" class="graf graf--p graf-after--h4">This may seem obvious that the TP and TPURGENT are for OLTP. But when you know that the service names are associated with Resource Manager consumer groups, you may think that high priority use cases should run on the HIGH service. However those LOW, MEDIUM, HIGH services were probably named when ADW was the only Autonomous Database and it is not directly obvious that they are there for <strong class="markup--strong markup--p-strong">reporting</strong> only, or maybe for some batch operations.</p><figure name="29cd" id="29cd" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 525px; max-height: 276px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 52.6%;"></div><img class="graf-image" data-image-id="1*y8dkl2T8Ku_FecZr0Evokw.png" data-width="1314" data-height="691" data-is-featured="true" src="https://cdn-images-1.medium.com/max/600/1*y8dkl2T8Ku_FecZr0Evokw.png"></div><figcaption class="imageCaption">Application “enq: TM — contention” and Scheduler “resmgr:pq queued” waits</figcaption></figure><p name="7852" id="7852" class="graf graf--p graf-after--figure">What is less obvious is that when you do some modifications through these services, they run with Parallel DML (PDML). And PDML can acquire an exclusive lock on tables. And then it blocks your concurrent transactions. You will see some waits on <em class="markup--em markup--p-em">‘enq: TM contention</em>’ and probably some ‘<em class="markup--em markup--p-em">resmgr:pq queued</em>’</p><h3 name="959b" id="959b" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">What does the documentation say about parallelism?</strong></h3><p name="8f3e" id="8f3e" class="graf graf--p graf-after--h3">The <a href="https://docs.oracle.com/en/cloud/paas/atp-cloud/atpug/connect-predefined.html#GUID-9747539B-FD46-44F1-8FF8-F5AC650F15BE" data-href="https://docs.oracle.com/en/cloud/paas/atp-cloud/atpug/connect-predefined.html#GUID-9747539B-FD46-44F1-8FF8-F5AC650F15BE" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">documentation</a> or the <a href="https://www.oracle.com/technetwork/database/bi-datawarehousing/adw-technical-faq-public-5069016.pdf" data-href="https://www.oracle.com/technetwork/database/bi-datawarehousing/adw-technical-faq-public-5069016.pdf" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Autonomous Database FAQ</a> explains that MEDIUM and HIGH use parallel query, but it is not immediately visible that they also run in parallel DML:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="27e5" id="27e5" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 284px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 27.500000000000004%;"></div><img class="graf-image" data-image-id="1*bu0MhrlhjjIRget-rSrZNQ.png" data-width="1628" data-height="448" src="https://cdn-images-1.medium.com/max/1200/1*bu0MhrlhjjIRget-rSrZNQ.png"></div><figcaption class="imageCaption"><a href="https://www.oracle.com/technetwork/database/bi-datawarehousing/adw-technical-faq-public-5069016.pdf" data-href="https://www.oracle.com/technetwork/database/bi-datawarehousing/adw-technical-faq-public-5069016.pdf" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">https://www.oracle.com/technetwork/database/bi-datawarehousing/adw-technical-faq-public-5069016.pdf</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="6fc3" id="6fc3" class="graf graf--p graf-after--figure">You may also refer to Maria Colgan description of those services:</p><div name="8979" id="8979" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://sqlmaria.com/2018/08/21/getting-started-with-oracle-autonomous-transaction-processing/" data-href="https://sqlmaria.com/2018/08/21/getting-started-with-oracle-autonomous-transaction-processing/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://sqlmaria.com/2018/08/21/getting-started-with-oracle-autonomous-transaction-processing/"><strong class="markup--strong markup--mixtapeEmbed-strong">Getting started with Oracle Autonomous Transaction Processing</strong><br><em class="markup--em markup--mixtapeEmbed-em">Getting started with Oracle Autonomous Transaction Processing is actually much easier than you might think. In fact…</em>sqlmaria.com</a><a href="https://sqlmaria.com/2018/08/21/getting-started-with-oracle-autonomous-transaction-processing/" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="545eef6bfd90f188945b00634fcf91c1"></a></div><h4 name="0a34" id="0a34" class="graf graf--h4 graf-after--mixtapeEmbed">How to enable Parallel DML?</h4><p name="dbc3" id="dbc3" class="graf graf--p graf-after--h4">As far as I know, the documentation mentions only two ways to enable Parallel DML. At the session level:</p><pre name="45ba" id="45ba" class="graf graf--pre graf-after--p">alter session enable parallel DML;</pre><p name="77ad" id="77ad" class="graf graf--p graf-after--pre">to enable it (when the table degree is &gt;1) or even to force it even for no parallel tables:</p><pre name="6f55" id="6f55" class="graf graf--pre graf-after--p">alter session force parallel DML;</pre><p name="993f" id="993f" class="graf graf--p graf-after--pre">Or, since 12c, at statement level with the ENABLE_PARALLEL_DML hint:</p><div name="c6b2" id="c6b2" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://blog.dbi-services.com/parallel-dml-in-12c/" data-href="https://blog.dbi-services.com/parallel-dml-in-12c/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://blog.dbi-services.com/parallel-dml-in-12c/"><strong class="markup--strong markup--mixtapeEmbed-strong">Parallel DML in 12c - Blog dbi services</strong><br><em class="markup--em markup--mixtapeEmbed-em">By Franck Pachot . Following a question from Randolf Geist (who can imagine that there is something about parallel…</em>blog.dbi-services.com</a><a href="https://blog.dbi-services.com/parallel-dml-in-12c/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="26cf979cf0a09ce8fc3d25c52c3f1ace" data-thumbnail-img-id="0*JsF32Ba2SND61imA" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*JsF32Ba2SND61imA);"></a></div><p name="69fb" id="69fb" class="graf graf--p graf-after--mixtapeEmbed">It is important that Oracle requires us to explicitly enable PDML because PDML queries can acquire exclusive locks on the tables, and DML is not expected to do that — exclusive lock is usually for DDL to prevent concurrent DML.</p><p name="dd3d" id="dd3d" class="graf graf--p graf-after--p">Let’s also precise here that there’s a big difference between Parallel Query and Parallel DML. Parallel Query is for SELECT. it can consume a lot of resources, but will never lock tables. Parallel DML concerns only modifications (like INSERT, DELETE, UPDATE). This is a bit misleading because, in SQL, the <a href="https://en.wikipedia.org/wiki/Data_manipulation_language" data-href="https://en.wikipedia.org/wiki/Data_manipulation_language" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Data Manipulation Language</a> also includes the SELECT. But it is common that people use the DML term for non-SELECT DML.</p><h3 name="0df1" id="0df1" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">What does the dictionary say about parallelism?</strong></h3><p name="1918" id="1918" class="graf graf--p graf-after--h3">V$SESSION has information about the sessions that have Parallel DML enabled:</p><pre name="ad24" id="ad24" class="graf graf--pre graf-after--p">select distinct regexp_replace(service_name,&#39;.*_&#39;)<br> ,pdml_enabled, pdml_status, pddl_status, pq_status <br>FROM V$session order by 2,3,4;</pre><figure name="597f" id="597f" class="graf graf--figure graf-after--pre"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 309px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 44.2%;"></div><img class="graf-image" data-image-id="1*HG65pgDFXEGx-PAQlZgAWw.png" data-width="1421" data-height="628" src="https://cdn-images-1.medium.com/max/800/1*HG65pgDFXEGx-PAQlZgAWw.png"></div></figure><p name="5b67" id="5b67" class="graf graf--p graf-after--figure">That tells us that Parallel DML is enabled, for all services. But not forced. When you ALTER SESSION FORCE PARALLEL DML, you see it explicitly:</p><pre name="71d7" id="71d7" class="graf graf--pre graf-after--p">SQL&gt; connect demo/demo@//localhost/PDB1<br>Connected.</pre><pre name="50a1" id="50a1" class="graf graf--pre graf-after--pre"><br>SQL&gt; select distinct regexp_replace(service_name,&#39;.*_&#39;) &quot;service&quot;<br>    ,pdml_enabled, pdml_status, pddl_status<br>   FROM V$session where sid=sys_context(&#39;userenv&#39;,&#39;sid&#39;);</pre><pre name="ffcc" id="ffcc" class="graf graf--pre graf-after--pre">   service    PDML_ENABLED    PDML_STATUS    PDDL_STATUS<br>__________ _______________ ______________ ______________<br>pdb1       NO              <strong class="markup--strong markup--pre-strong">DISABLED</strong>       ENABLED</pre><pre name="eb56" id="eb56" class="graf graf--pre graf-after--pre">SQL&gt; alter session <strong class="markup--strong markup--pre-strong">enable</strong> parallel dml;</pre><pre name="5e23" id="5e23" class="graf graf--pre graf-after--pre">Session altered.</pre><pre name="5524" id="5524" class="graf graf--pre graf-after--pre">SQL&gt; select distinct regexp_replace(service_name,&#39;.*_&#39;) &quot;service&quot;<br>    ,pdml_enabled, pdml_status, pddl_status<br>   FROM V$session where sid=sys_context(&#39;userenv&#39;,&#39;sid&#39;);</pre><pre name="42ab" id="42ab" class="graf graf--pre graf-after--pre">   service    PDML_ENABLED    PDML_STATUS    PDDL_STATUS<br>__________ _______________ ______________ ______________<br>pdb1       YES             <strong class="markup--strong markup--pre-strong">ENABLED</strong>        ENABLED</pre><pre name="dc11" id="dc11" class="graf graf--pre graf-after--pre">SQL&gt; alter session <strong class="markup--strong markup--pre-strong">force</strong> parallel dml;</pre><pre name="03fc" id="03fc" class="graf graf--pre graf-after--pre">Session altered.</pre><pre name="82c1" id="82c1" class="graf graf--pre graf-after--pre">SQL&gt; select distinct regexp_replace(service_name,&#39;.*_&#39;) &quot;service&quot;<br>    ,pdml_enabled, pdml_status, pddl_status<br>   FROM V$session where sid=sys_context(&#39;userenv&#39;,&#39;sid&#39;);</pre><pre name="5576" id="5576" class="graf graf--pre graf-after--pre">   service    PDML_ENABLED    PDML_STATUS    PDDL_STATUS<br>__________ _______________ ______________ ______________<br>pdb1       YES             <strong class="markup--strong markup--pre-strong">FORCED</strong>         ENABLED</pre><pre name="0e8e" id="0e8e" class="graf graf--pre graf-after--pre">SQL&gt; alter session <strong class="markup--strong markup--pre-strong">disable</strong> parallel dml;</pre><pre name="1df4" id="1df4" class="graf graf--pre graf-after--pre">Session altered.</pre><pre name="0aa7" id="0aa7" class="graf graf--pre graf-after--pre">SQL&gt; select distinct regexp_replace(service_name,&#39;.*_&#39;) &quot;service&quot;<br>    ,pdml_enabled, pdml_status, pddl_status<br>   FROM V$session where sid=sys_context(&#39;userenv&#39;,&#39;sid&#39;);</pre><pre name="ddcc" id="ddcc" class="graf graf--pre graf-after--pre">   service    PDML_ENABLED    PDML_STATUS    PDDL_STATUS<br>__________ _______________ ______________ ______________<br>pdb1       NO              <strong class="markup--strong markup--pre-strong">DISABLED</strong>       ENABLED</pre><p name="e1d6" id="e1d6" class="graf graf--p graf-after--pre">So, in my ATP service, all services have PDML enabled, and none are forced.</p><h3 name="cb67" id="cb67" class="graf graf--h3 graf-after--p">What does the execution plan say about parallelism?</h3><p name="9533" id="9533" class="graf graf--p graf-after--h3">However, it seems that when connected with the MEDIUM and HIGH services, PDML can be used:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="0784" id="0784" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 587px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.89999999999999%;"></div><img class="graf-image" data-image-id="1*6YVmxU8JovPzdhvihA5eZg.png" data-width="2058" data-height="1171" src="https://cdn-images-1.medium.com/max/1200/1*6YVmxU8JovPzdhvihA5eZg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2dc2" id="2dc2" class="graf graf--p graf-after--figure">And you can see that I even created the table explicitly in NO PARALLEL (which is the default anyway). The PDML is enabled but not forced. Then what I often do in this case is look at the ‘+OUTLINE’ dbms_xplan format as there may be some clues about specific optimizer settings:</p><pre name="b113" id="b113" class="graf graf--pre graf-after--p">SQL&gt; select * from dbms_xplan.display(format=&gt;&#39;+outline&#39;);</pre><pre name="f06c" id="f06c" class="graf graf--pre graf-after--pre">...</pre><pre name="ecf9" id="ecf9" class="graf graf--pre graf-after--pre">Outline Data<br>-------------<br> <br>  /*+<br>      BEGIN_OUTLINE_DATA<br>      FULL(@&quot;DEL$1&quot; &quot;DEMO&quot;@&quot;DEL$1&quot;)<br>      OUTLINE_LEAF(@&quot;DEL$1&quot;)<br>     <strong class="markup--strong markup--pre-strong"> SHARED(8)</strong><br>      ALL_ROWS<br>      OPT_PARAM(&#39;_fix_control&#39; &#39;20648883:0&#39;)<br>      DB_VERSION(&#39;18.1.0&#39;)<br>      OPTIMIZER_FEATURES_ENABLE(&#39;18.1.0&#39;)<br>      IGNORE_OPTIM_EMBEDDED_HINTS<br>      END_OUTLINE_DATA<br>  */<br> <br>Note<br>-----<br>   - automatic DOP: Computed Degree of Parallelism is 8 because of degree limit</pre><p name="ca7b" id="ca7b" class="graf graf--p graf-after--pre">ATP service disables the fix about “Lift restrictions on view merging for the CURSOR expression” but this has nothing to do with PDML. However, there’s something interesting here: a SHARED hint.</p><h3 name="6ce4" id="6ce4" class="graf graf--h3 graf-after--p">What does V$SQL_HINT say about parallelism?</h3><p name="3d63" id="3d63" class="graf graf--p graf-after--h3">Actually, the true hint for running in parallel is not PARALLEL but SHARED. This is visible in V$SQL_HINT as it is the inverse of NOPARALLEL (and its synonym NO_PARALLEL added later to follow the NO_% hint syntax convention):</p><pre name="714f" id="714f" class="graf graf--pre graf-after--p">SQL&gt; select name,inverse,version from v$sql_hint <br>     where name like &#39;%SHARED&#39;;</pre><pre name="c248" id="c248" class="graf graf--pre graf-after--pre">     NAME        INVERSE    VERSION<br>_________ ______________ __________<br>SHARED    NO_PARALLEL    8.1.0</pre><pre name="dc06" id="dc06" class="graf graf--pre graf-after--pre">SQL&gt; select name,inverse,version from v$sql_hint<br>     where name like &#39;%PARALLEL&#39;;</pre><pre name="670e" id="670e" class="graf graf--pre graf-after--pre">          NAME    INVERSE     VERSION<br>______________ __________ ___________<br>NOPARALLEL     SHARED     8.1.0<br>NO_PARALLEL    SHARED     10.1.0.3</pre><p name="309c" id="309c" class="graf graf--p graf-after--pre">PARALLEL is just a synonym for SHARED.</p><p name="4590" id="4590" class="graf graf--p graf-after--p">So, it seems that even with no parallel degree and no forced parallel DML, parallelism has been forced to a degree of 8 as we can see with the SHARED(8) hint. Probably related to the number of CPU:</p><figure name="5506" id="5506" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 525px; max-height: 213px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.6%;"></div><img class="graf-image" data-image-id="1*K7JguLE68BvKwK9ekc4XkA.png" data-width="2010" data-height="817" src="https://cdn-images-1.medium.com/max/600/1*K7JguLE68BvKwK9ekc4XkA.png"></div><figcaption class="imageCaption">ATP number of OCPU</figcaption></figure><pre name="e15c" id="e15c" class="graf graf--pre graf-after--figure">SQL&gt; show parameter cpu_count<br>NAME      TYPE    VALUE <br>--------- ------- ----- <br><strong class="markup--strong markup--pre-strong">cpu_count</strong> integer <strong class="markup--strong markup--pre-strong">20</strong>    </pre><pre name="686d" id="686d" class="graf graf--pre graf-after--pre">SQL&gt; show parameter degree_limit<br>NAME                 VALUE<br>--------------------- ----<br>parallel_degree_limit <strong class="markup--strong markup--pre-strong">CPU</strong></pre><p name="00c2" id="00c2" class="graf graf--p graf-after--pre">I have 10 OCPUs allocated to this ATP service, which means 20 threads (CPU_COUNT) but DBMS_XPLAN also mentions that Auto DOP has computed the degree because of degree limit. The Resource Manager plan has some limits for the maximum degree of parallelism, like:</p><pre name="ce11" id="ce11" class="graf graf--pre graf-after--p">SQL&gt; select plan,group_or_subplan,parallel_degree_limit_p1<br>     from DBA_RSRC_PLAN_DIRECTIVES where plan=&#39;OLTP_PLAN&#39;;</pre><pre name="1712" id="1712" class="graf graf--pre graf-after--pre">PLAN         GROUP_OR_SUBPLAN       PARALLEL_DEGREE_LIMIT_P1<br>---------    ----------------       ------------------------OLTP_PLAN    HIGH                                         20 <br>OLTP_PLAN    MEDIUM                                        4 <br>OLTP_PLAN    LOW                                           1 <br>OLTP_PLAN    TPURGENT                                        <br>OLTP_PLAN    OTHER_GROUPS                                  1 <br>OLTP_PLAN    TP                                            1</pre><h3 name="42dd" id="42dd" class="graf graf--h3 graf-after--pre">What does the LOGON Trigger say about parallelism?</h3><p name="a9f7" id="a9f7" class="graf graf--p graf-after--h3">Usually, when we want to enable Parallel DML automatically for a user we add a Logon Trigger, like:</p><pre name="3b78" id="3b78" class="graf graf--pre graf-after--p">CREATE OR REPLACE TRIGGER app_user.after_logon_trg<br>AFTER LOGON ON app_user.SCHEMA<br>BEGIN<br>  EXECUTE IMMEDIATE &#39;ALTER SESSION ENABLE PARALLEL DML&#39;;<br>END;<br>/</pre><p name="80bd" id="80bd" class="graf graf--p graf-after--pre">Note that this AFTER LOGON ON SCHEMA comes from Tim Hall example:</p><div name="17dc" id="17dc" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://oracle-base.com/articles/misc/database-triggers-overview" data-href="https://oracle-base.com/articles/misc/database-triggers-overview" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://oracle-base.com/articles/misc/database-triggers-overview"><strong class="markup--strong markup--mixtapeEmbed-strong">Database Triggers Overview</strong><br><em class="markup--em markup--mixtapeEmbed-em">An introduction to database triggers in Oracle.</em>oracle-base.com</a><a href="https://oracle-base.com/articles/misc/database-triggers-overview" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="7f293bcfcc3ca025ea27239d1dcf95b8" data-thumbnail-img-id="0*FPhzBgXTtEiXE_VX" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*FPhzBgXTtEiXE_VX);"></a></div><p name="5a0d" id="5a0d" class="graf graf--p graf-after--mixtapeEmbed">So, let’s have a look at the LOGON triggers defined in the Autonomous Transaction Processing PDB (Don’t forget that for whatever reason the TRIGGERING_EVENT in DBA_TRIGGERS ends with a space):</p><pre name="6bea" id="6bea" class="graf graf--pre graf-after--p">set echo on long 10000<br>select dbms_metadata.get_ddl(&#39;TRIGGER&#39;,trigger_name,owner) <br>from dba_triggers where triggering_event like &#39;LOGON &#39;;</pre><figure name="84d6" id="84d6" class="graf graf--figure graf-after--pre"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 447px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 63.9%;"></div><img class="graf-image" data-image-id="1*zZWCcMBwynD9-hmCKvKJCA.png" data-width="1178" data-height="753" src="https://cdn-images-1.medium.com/max/800/1*zZWCcMBwynD9-hmCKvKJCA.png"></div></figure><p name="6a31" id="6a31" class="graf graf--p graf-after--figure">No mention of ENABLE or FORCE parallel DML here, but there is a minimum parallel degree set to the number of CPU, with the DOP policy set to AUTO, for the MEDIUM and HIGH services only.</p><p name="78ad" id="78ad" class="graf graf--p graf-after--p">I have all information here, let’s reproduce the same in a non-autonomous database. And show the reason of the sessions blocked on “enq: TM contention”</p><h3 name="1b18" id="1b18" class="graf graf--h3 graf-after--p">What does ksqgtl trace say about parallelism?</h3><p name="9b3b" id="9b3b" class="graf graf--p graf-after--h3">I’m connected to a 19.3 database here where I enable PDML (not forced) and I also trace the Kernel Service enQueue (like what we did with 10704 before 12cR2) in order to show the locks acquired.</p><p name="19d6" id="19d6" class="graf graf--p graf-after--p">The Auto DOP is set with a minimum degree equal to CPU, as in the ATP logon trigger.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="229b" id="229b" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 412px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40%;"></div><img class="graf-image" data-image-id="1*Y-J3uNR-nlb2RWKLPY8_-g.png" data-width="2702" data-height="1080" src="https://cdn-images-1.medium.com/max/1200/1*Y-J3uNR-nlb2RWKLPY8_-g.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="1144" id="1144" class="graf graf--p graf-after--figure">I have created a simple DEMO table with DEGREE 1 (which means no parallel, and is the default anyway). I run a DELETE and explain plan:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="5686" id="5686" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 632px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 61.3%;"></div><img class="graf-image" data-image-id="1*3TNZZPoHvu7CgbqlQ8_O-Q.png" data-width="2703" data-height="1656" src="https://cdn-images-1.medium.com/max/1200/1*3TNZZPoHvu7CgbqlQ8_O-Q.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="cbb6" id="cbb6" class="graf graf--p graf-after--figure">This is what I observed in ATP but here, with no resource manager, the parallel degree is set to 48 which is my CPU_COUNT.</p><p name="c501" id="c501" class="graf graf--p graf-after--p">Now looking at the ksq trace for ksqgtl (GeT Lock):</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="a4c8" id="a4c8" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 345px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 33.4%;"></div><img class="graf-image" data-image-id="1*lNOnsBNMxKQyCeINZ1cDsA.png" data-width="2703" data-height="903" src="https://cdn-images-1.medium.com/max/1200/1*lNOnsBNMxKQyCeINZ1cDsA.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="674f" id="674f" class="graf graf--p graf-after--figure">My delete, because it is running as PDML, has acquired a mode=6 (eXclusive) lock on the DEMO table.</p><p name="9a25" id="9a25" class="graf graf--p graf-after--p">If you want to reproduce, here are the commands I’ve run:</p><pre name="66f2" id="66f2" class="graf graf--pre graf-after--p">set pagesize 1000 echo on<br>drop table DEMO;<br>connect demo/demo@//localhost/PDB1<br>create table DEMO (n) parallel 1 as select rownum from xmltable(&#39;1 to 1000&#39;);<br>alter session enable parallel dml;<br>alter session set parallel_degree_policy=auto parallel_min_degree=cpu;<br>select distinct regexp_replace(service_name,&#39;.*_&#39;) &quot;service&quot;<br> ,pdml_enabled, pdml_status, pddl_status, pq_status<br>from v$session where sid=sys_context(&#39;userenv&#39;,&#39;sid&#39;)<br>/<br>alter session set events &#39;trace[ksq] disk medium&#39;;<br>alter session set tracefile_identifier=KSQ;<br>delete DEMO;<br>select * from dbms_xplan.display_cursor(format=&gt;&#39;+outline&#39;);<br>alter session set events &#39;trace[ksq]off&#39;;<br>select object_id , to_char(object_id,&#39;0XXXXXXX&#39;) , object_name,object_type from user_objects where object_name=&#39;DEMO&#39;;<br>column value new_value tracefile<br>select value from v$diag_info where name=&#39;Default Trace File&#39;;<br>column value clear<br>host grep TM- &amp;tracefile<br>rollback;</pre><h3 name="cbb2" id="cbb2" class="graf graf--h3 graf-after--pre">One question remains…</h3><p name="6d99" id="6d99" class="graf graf--p graf-after--h3">In my example, I’ve enabled PDML:</p><pre name="35cc" id="35cc" class="graf graf--pre graf-after--p">alter session enable parallel dml;</pre><p name="abe9" id="abe9" class="graf graf--p graf-after--pre">because I’ve seen it enabled for my MEDIUM and HIGH services. But I don’t know (yet — please tweet <a href="https://twitter.com/franckpachot" data-href="https://twitter.com/franckpachot" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">@FranckPachot</a> if you have ideas) where this comes from. There’s nothing about it in the LOGON trigger.</p><p name="8d01" id="8d01" class="graf graf--p graf-after--p">If I do not enable PDML in my non-autonomous database, the SELECT part is done in the parallel query but the DELETE is not in PDML (there is no DELETE below the PX COORDINATOR)</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="e487" id="e487" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 771px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.7%;"></div><img class="graf-image" data-image-id="1*gEQl4SHV6yW2ynk5GcXzAA.png" data-width="2096" data-height="1565" src="https://cdn-images-1.medium.com/max/1200/1*gEQl4SHV6yW2ynk5GcXzAA.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="d49e" id="d49e" class="graf graf--p graf-after--figure">So, the question that remains: how is PDML enabled in the Autonomous Transaction Processing service?</p><p name="9575" id="9575" class="graf graf--p graf-after--p">But the most important to remember is that running some INSERT/UPDATE/DELETE with the MEDIUM of HIGH service can block all your Transaction Processing because of the exclusive lock.</p><p name="c090" id="c090" class="graf graf--p graf-after--p graf--trailing">Autonomous does not mean that we can run without understanding.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@FranckPachot" class="p-author h-card">Franck Pachot</a> on <a href="https://medium.com/p/5a9281b68d72"><time class="dt-published" datetime="2019-06-22T20:51:37.250Z">June 22, 2019</time></a>.</p><p><a href="https://medium.com/@FranckPachot/oracle-atp-medium-and-high-services-are-not-for-oltp-5a9281b68d72" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 27, 2019.</p></footer></article></body></html>